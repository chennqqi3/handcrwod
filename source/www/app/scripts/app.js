(function(){"use strict";angular.module("app.activate",[]).controller("activateCtrl",function($scope,$rootScope,$api,$location,$session,userStorage,AUTH_EVENTS,$auth,logger){var param;return param=$location.search(),$scope.showMessage=!1,$scope.message="",$auth.activate(param).then(function(res){return 0===res.err_code?(logger.logSuccess("ユーザー登録が完了しました。"),$rootScope.$broadcast(AUTH_EVENTS.loginSuccess),$location.path("/home")):$scope.message=res.err_msg,$scope.showMessage=!0})})}).call(this),function(){"use strict";angular.module("app.forgotpwd",[]).controller("forgotpwdCtrl",function($scope,$api,$location){var reset_url;return reset_url=$api.base_url()+"#/resetpwd",$scope.user={email:"",reset_url:reset_url},$scope.showMessage=!1,$scope.canSubmit=function(){return $scope.form_forgotpwd.$valid},$scope.submitForm=function(){return $api.call("user/send_reset_password",$scope.user).success(function(data,status,headers,config){return 0===data.err_code?$scope.message="パスワードリセット用メールをお客様のメールアドレスへ届けました。メールからリンクをクリックして、パスワードをリセットしてください。":$scope.message=data.err_msg,$scope.showMessage=!0})}})}.call(this),function(){"use strict";angular.module("app.resetpwd",[]).controller("resetpwdCtrl",function($scope,$api,$location,$timeout){var param;return param=$location.search(),$scope.user={user_id:param.user_id,activate_key:param.activate_key,password:""},$scope.showMessage=!1,$scope.canSubmit=function(){return $scope.form_resetpwd.$valid},$scope.submitForm=function(){return $api.call("user/reset_password",$scope.user).success(function(data,status,headers,config){return 0===data.err_code?($scope.message="パスワードがリセットされました。",$timeout(function(){return $location.path("/signin")},1e3)):$scope.message=data.err_msg,$scope.showMessage=!0})}})}.call(this),function(){"use strict";angular.module("app.settings",[]).controller("settingsCtrl",function($scope,$api,$rootScope,logger,$session,$upload,CONFIG,$location,$numutil,$timeout,$dialogs,userStorage,missionStorage,homeStorage){$rootScope.nav_id="settings",missionStorage.select_mission_in_nav(),$scope.init=function(){var _i,_results;return $scope.time_zones=moment.tz.names(),$scope.alarm_times=function(){for(_results=[],_i=0;_i<=23;_i++)_results.push(_i);return _results}.apply(this),userStorage.get_profile(null,function(res){if(0===res.err_code)return $scope.user=res.user,$scope.user.alarm_mail_flag=1===$scope.user.alarm_mail_flag}),$api.call("google/is_connected").then(function(res){var url;return 0!==res.data.err_code?(url=$location.absUrl(),url=url.replace(/(#[\/\w]*)/gi,"")+"#/settings",$scope.google_auth_url=CONFIG.GOOGLE_CONNECT_URL+"?TOKEN="+$session.getTOKEN()+"&redirect_url="+encodeURIComponent(url)):$scope.google_auth_url=""})},$scope.init(),$scope.$on("reload_session",function(){return $scope.init()}),$scope.changeHourlyAmount=function(){var v;return v=$numutil.to_num($scope.user.hourly_amount),v<0&&(v=0),$timeout(function(){return $scope.user.hourly_amount=v})},$scope.canUpdateProfile=function(){return $scope.form_update_profile.$valid},$scope.breakHandcrowd=function(){return $dialogs.confirm("退会","ハンドクラウドから退会します。よろしいでしょうか？","確認",function(){return $dialogs.confirm("退会","退会手続きをされますと、サービスがご利用できなくなります。本当に退会してよろしいでしょうか？","OK",function(){return homeStorage.break_handcrowd(function(res){return 0===res.err_code?(logger.logSuccess("ハンドクラウドから退会されました"),$location.path("/signin")):logger.logError(res.err_msg)})},null,"btn-danger")})},$scope.updateProfile=function(){var hourly_amount;return hourly_amount=$numutil.to_num($scope.user.hourly_amount),$api.call("user/update_profile",{user_name:$scope.user.user_name,login_id:$scope.user.login_id,email:$scope.user.email,skills:$scope.user.skills,hourly_amount:hourly_amount,time_zone:$scope.user.time_zone,alarm_mail_flag:$scope.user.alarm_mail_flag,alarm_time:$scope.user.alarm_time}).success(function(data,status,headers,config){return 0===data.err_code?($session.user_name=$scope.user.user_name,$session.email=$scope.user.email,$session.time_zone=$scope.user.time_zone,logger.logSuccess("プロファイルが保存されました。")):logger.logError(data.err_msg),$scope.showMessage=!0})},$scope.canUpdatePassword=function(){return $scope.form_update_password.$valid},$scope.updatePassword=function(){return $api.call("user/update_profile",{old_password:$scope.user.old_password,new_password:$scope.user.new_password}).success(function(data,status,headers,config){return 0===data.err_code?logger.logSuccess("パスワードが変更されました。"):logger.logError(data.err_msg),$scope.showMessage=!0})},$scope.onUploadAvartar=function(files){var file;return file=files[0],userStorage.upload_avartar(file).progress(function(evt){}).success(function(data,status,headers,config){return 0===data.err_code?$scope.user.avartar=data.avartar:logger.logError(data.err_msg)})},$scope.disconnectGoogle=function(){return $api.call("google/disconnect").then(function(res){var url;if(0===res.data.err_code)return url=$location.absUrl(),url=url.replace(/(#[\/\w]*)/gi,"")+"#/settings",$scope.google_auth_url=CONFIG.GOOGLE_CONNECT_URL+"?TOKEN="+$session.getTOKEN()+"&redirect_url="+encodeURIComponent(url)})}})}.call(this),function(){"use strict";angular.module("app.signin",[]).controller("signinCtrl",function($scope,$rootScope,CONFIG,$api,$auth,$location,AUTH_EVENTS,$session,$routeParams,logger,chatStorage){return chatStorage.refresh_unreads_title(),$scope.canSubmit=function(){return $scope.form_signin.$valid},$scope.submitForm=function(){return $auth.login($scope.user).then(function(err_code){return $scope.procLogin(err_code)})},$scope.procLogin=function(err_code){var url;return 0===err_code?($rootScope.$broadcast(AUTH_EVENTS.loginSuccess),void 0!==$rootScope.redirect_url?(url=$rootScope.redirect_url,$rootScope.redirect_url=void 0,$location.path(url)):$location.path("/home"),$session.signinParamsToStorage(null)):51===err_code?($scope.showExpireError=!0,$scope.showSigninError=!1):($scope.showExpireError=!1,$scope.showSigninError=!0)},$scope.showSignin=!0,void 0!==$routeParams.token?"facebook"===$routeParams.from?($scope.showSignin=!1,$scope.params=$session.signinParamsFromStorage(),$auth.loginFacebook($routeParams.token).then(function(err_code){return $scope.procLogin(err_code)})):"google"===$routeParams.from?($scope.showSignin=!1,$scope.params=$session.signinParamsFromStorage(),$auth.loginGoogle($routeParams.token).then(function(err_code){return $scope.procLogin(err_code)})):$auth.autoLogin($routeParams.token,null,null):($scope.params=$location.search(),$session.signinParamsToStorage($scope.params)),$scope.api_url=CONFIG.API_BASE,$scope.base_url=$api.base_url(),$scope.facebook_redirect_url="signin",$scope.facebook_signup_url="signup_facebook",$scope.google_redirect_url="signin",$scope.google_signup_url="signup_google",$scope.user={login_id:$session.login_id,password:""},$scope.showSigninError=!1,$scope.showExpireError=!1})}.call(this),function(){"use strict";angular.module("app.signout",[]).controller("signoutCtrl",function($scope,$rootScope,$auth,$location,AUTH_EVENTS){return $rootScope.$broadcast(AUTH_EVENTS.logoutSuccess),$auth.logout(),$location.path("/signin")})}.call(this),function(){"use strict";angular.module("app.signup",[]).controller("signupCtrl",function($scope,$api,$location,$auth,$session,$rootScope,$dialogs,$http,userStorage,AUTH_EVENTS,$timeout){var activate_url,param;return param=$location.search(),$scope.posting=!1,activate_url=$api.base_url()+"#/activate",$scope.email_readonly=!$api.is_empty(param.email),$scope.user={login_id:"",user_name:"",email:param.email,password:"",activate_url:activate_url,invite_home_id:param.invite_home_id,invite_mission_id:param.invite_mission_id,key:param.key},$scope.showMessage=!1,$scope.message="",$scope.registered=!1,$http.get("contract.txt").success(function(data,status,headers,config){return $scope.contract=data}),$http.get("privacy.txt").success(function(data,status,headers,config){return $scope.privacy=data}),$scope.canSubmit=function(){return $scope.form_signup.$valid&&$scope.registered===!1&&$scope.posting===!1},$scope.submitForm=function(){if($scope.show_error=!0,$scope.form_signup.$valid!==!1)return $scope.posting=!0,$scope.registered?void 0:$auth.signup($scope.user,function(res){return $scope.posting=!1,$scope.err_code=res.err_code,0===res.err_code?($rootScope.$broadcast(AUTH_EVENTS.loginSuccess),$timeout(function(){return $location.path("/home")},1e3),$session.signinParamsToStorage(null),$scope.registered=!0):($scope.message=res.err_msg,$scope.showMessage=!0)})},$scope.showContract=function(){return $dialogs.showContract("ハンドクラウド利用規約",$scope.contract)},$scope.showPrivacy=function(){return $dialogs.showContract("ハンドクラウドサービス　個人情報の取り扱いについて",$scope.privacy)}})}.call(this),function(){"use strict";angular.module("app.signup_facebook",[]).controller("signupFacebookCtrl",function($scope,$api,$auth,$location,$dialogs,$http,$routeParams,$session,AUTH_EVENTS,$rootScope){var activate_url,param;return param=$location.search(),activate_url=$api.base_url()+"#/activate",$scope.user={login_id:"",user_name:""},$api.call("facebook/get_info",{token:$routeParams.token}).success(function(data,status,headers,config){return 0===data.err_code?($scope.user.facebook_id=data.facebook_id,$scope.user.user_name=data.user_name):($scope.message=data.err_msg,$scope.showMessage=!0)}),$scope.showMessage=!1,$scope.message="",$scope.registered=!1,$http.get("contract.txt").success(function(data,status,headers,config){return $scope.contract=data}),$http.get("privacy.txt").success(function(data,status,headers,config){return $scope.privacy=data}),$scope.canSubmit=function(){return $scope.form_signup.$valid&&$scope.registered===!1&&$scope.posting===!1&&!_is_empty($scope.user.facebook_id)},$scope.submitForm=function(){if($scope.show_error=!0,$scope.form_signup.$valid!==!1)return $scope.posting=!0,$auth.signupFacebook({token:$routeParams.token,login_id:$scope.user.login_id,user_name:$scope.user.user_name},function(res){return $scope.posting=!1,0===res.err_code?($rootScope.$broadcast(AUTH_EVENTS.loginSuccess),$location.path("/home")):($scope.message=res.err_msg,$scope.showMessage=!0)})},$scope.showContract=function(){return $dialogs.showContract("ハンドクラウド利用規約",$scope.contract)},$scope.showPrivacy=function(){return $dialogs.showContract("ハンドクラウドサービス　個人情報の取り扱いについて",$scope.privacy)}})}.call(this),function(){"use strict";angular.module("app.signup_google",[]).controller("signupGoogleCtrl",function($scope,$api,$auth,$location,$dialogs,$http,$routeParams,$session,AUTH_EVENTS,$rootScope){var activate_url,param;return param=$location.search(),activate_url=$api.base_url()+"#/activate",$scope.user={login_id:"",user_name:""},$api.call("google/get_info",{token:$routeParams.token}).success(function(data,status,headers,config){return 0===data.err_code?($scope.user.google_id=data.google_id,$scope.user.user_name=data.user_name):($scope.message=data.err_msg,$scope.showMessage=!0)}),$scope.showMessage=!1,$scope.message="",$scope.registered=!1,$http.get("contract.txt").success(function(data,status,headers,config){return $scope.contract=data}),$http.get("privacy.txt").success(function(data,status,headers,config){return $scope.privacy=data}),$scope.canSubmit=function(){return $scope.form_signup.$valid&&$scope.registered===!1&&$scope.posting===!1&&!_is_empty($scope.user.google_id)},$scope.submitForm=function(){if($scope.show_error=!0,$scope.form_signup.$valid!==!1)return $scope.posting=!0,$auth.signupGoogle({token:$routeParams.token,login_id:$scope.user.login_id,user_name:$scope.user.user_name},function(res){return $scope.posting=!1,0===res.err_code?($rootScope.$broadcast(AUTH_EVENTS.loginSuccess),$location.path("/home")):($scope.message=res.err_msg,$scope.showMessage=!0)})},$scope.showContract=function(){return $dialogs.showContract("ハンドクラウド利用規約",$scope.contract)},$scope.showPrivacy=function(){return $dialogs.showContract("ハンドクラウドサービス　個人情報の取り扱いについて",$scope.privacy)}})}.call(this),function(){"use strict";angular.module("app",["app.config","ngRoute","ngAnimate","ui.bootstrap","angularFileUpload","ngWebsocket","duScroll","app.logger","app.controller.main","app.controller.nav","app.directives","app.localization","app.api","app.cache","app.dateutil","app.storage","app.auth","app.dialogs","app.service.chat","app.consts","app.qr","app.storage.home","app.storage.mission","app.storage.task","app.storage.chat","app.storage.user","app.signin","app.signup","app.signup_facebook","app.signup_google","app.signout","app.activate","app.forgotpwd","app.resetpwd","app.chatroom","app.sel_mission","app.sel_date","app.sel_skill","app.sel_performer","app.sel_hours","app.sel_budget","app.settings","app.sel_template","app.home","app.home.add","app.home.invite","app.home.edit","app.bot","app.mission.add","app.mission.open","app.mission.edit","app.mission.member","app.mission.member_add","app.mission.invite","app.mission.attach","app.mission.emoticon","app.task.list","app.task.edit","app.task.star","app.task.process","app.chatroom.search","app.chat.star"]).config(function($routeProvider,USER_ROLES,CONFIG){var ver;return ver="?v="+CONFIG.VER,$routeProvider.when("/",{redirectTo:"/home"}).when("/priority/:mission_id?",{templateUrl:"views/tasks.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/task/star",{templateUrl:"views/task/task_star.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/home/:home_id?",{templateUrl:"views/home/home.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/bot",{templateUrl:"views/home/bot.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/inbox/:mission_id?",{templateUrl:"views/tasks.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/missions/:mission_id?",{templateUrl:"views/tasks.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/chats/:mission_id/:chat_id?",{templateUrl:"views/chatroom/chatroom.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/process/:mission_id?",{templateUrl:"views/process/process.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/search",{templateUrl:"views/tasks.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/settings",{templateUrl:"views/settings.html"+ver,data:{authorizedRoles:[USER_ROLES.user]}}).when("/qr/home/:home_id/:invite_key",{templateUrl:"views/qr/home.html"+ver}).when("/qr/chat/:mission_id/:invite_key",{templateUrl:"views/qr/chat.html"+ver}).when("/signin/:token?/:from?",{templateUrl:"views/account/signin.html"+ver}).when("/signout",{templateUrl:"views/account/signout.html"+ver}).when("/signup",{templateUrl:"views/account/signup.html"+ver}).when("/signup_facebook/:token",{templateUrl:"views/account/signup_facebook.html"+ver}).when("/signup_google/:token",{templateUrl:"views/account/signup_google.html"+ver}).when("/activate",{templateUrl:"views/account/activate.html"+ver}).when("/forgotpwd",{templateUrl:"views/account/forgotpwd.html"+ver}).when("/resetpwd",{templateUrl:"views/account/resetpwd.html"+ver}).when("/loadapp",{templateUrl:"views/account/loadapp.html"+ver}).when("/404",{templateUrl:"views/pages/404.html"+ver}).otherwise({redirectTo:"/404"})}).run(function($rootScope,AUTH_EVENTS,$auth,$chat,$location,$syncServer,$route,$window,CONFIG,$dialogs,$api){var changeWindowState,hidden,init;$rootScope.err_required="必須項目です。",$rootScope.err_invalid_zip_code="3文字以上の半角数字を入力してください。ハイフンは含めないで下さい。",$rootScope.err_invalid_tel="例：半角数字090-1234-5678",$rootScope.err_invalid_email="例：tanaka@gmail.com",$rootScope.err_invalid_maxlength="文字以下に入力してください。",$rootScope.err_invalid_pdf="PDFファイルではありません。",$rootScope.err_invalid_date="例：H9-01-01",$rootScope.err_small_end_date="終了日付を開始日付以降に入力してください。",$rootScope.err_no_data="データーがありません。",$rootScope.err_no_equal_password="同じパスワードを入力してください。",$rootScope.err_invalid_taking_period="半角数字を入力して下さい。",$rootScope.err_invalid_furigana="ひらがなを入力してください。",$rootScope.err_send_method="送付方法を選択してください。",$rootScope.err_invalid_youtube="有効なYoutube　URLではありません。",$rootScope.wait_responding="データー取得中…",$rootScope.ver="?v="+CONFIG.VER,$rootScope.error_disconnected=!1,$window.mobilecheck=function(){return $window.isIOS()||$window.isAndroid()},$window.isAndroid=function(){var a,check;return check=!1,a=$window.navigator.userAgent||$window.navigator.vendor||$window.opera,/(android|bb\d+|meego).+mobile/i.test(a)&&(check=!0),check},$window.isIOS=function(){var a,check;return check=!1,a=$window.navigator.userAgent||$window.navigator.vendor||$window.opera,/ip(hone|od)/i.test(a)&&(check=!0),check},$rootScope.$on("$routeChangeStart",function(event,next,current){var authorizedRoles,mobileEnablePages,p,_i,_len;if(mobileEnablePages=["/signup","/activate","/forgotpwd","/resetpwd","/qr/home/:home_id/:invite_key","/qr/chat/:mission_id/:invite_key","/loadapp"],void 0!==next.originalPath){if($window.mobilecheck()){for(_i=0,_len=mobileEnablePages.length;_i<_len;_i++)if(p=mobileEnablePages[_i],p.indexOf(next.originalPath)!==-1)return;return void $location.path("/loadapp")}if("/signin/:token?/:from?"===next.originalPath)return;if("/signout"===next.originalPath)return void $auth.logout()}if(next.data&&(authorizedRoles=next.data.authorizedRoles),authorizedRoles)return $auth.isAuthorized(authorizedRoles)?void 0:$auth.autoLogin(null,authorizedRoles,event)}),$rootScope.$on("$routeChangeSuccess",function(event,current,previous,rejection){}),init=function(){$syncServer.sync(!1),$rootScope.alerts.length>0&&$dialogs.showAlerts()},$rootScope.$on(AUTH_EVENTS.loginSuccess,function(){return init()}),$rootScope.$on("reload_session",function(){return init()}),$api.init_notification(),changeWindowState=function(evt){var evtMap,h,v,visible;v="visible",h="hidden",evtMap={focus:v,focusin:v,pageshow:v,blur:h,focusout:h,pagehide:h},evt=evt||window.event,visible="",visible=evt.type in evtMap?evtMap[evt.type]:this[hidden]?"hidden":"visible",$rootScope.windowState=visible,$rootScope.$broadcast("change-window-state",visible)},hidden="hidden",hidden in document?document.addEventListener("visibilitychange",changeWindowState):(hidden="mozHidden")in document?document.addEventListener("mozvisibilitychange",changeWindowState):(hidden="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",changeWindowState):(hidden="msHidden")in document?document.addEventListener("msvisibilitychange",changeWindowState):"onfocusin"in document?document.onfocusin=document.onfocusout=changeWindowState:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=changeWindowState,void 0!==document[hidden]&&changeWindowState({type:document[hidden]?"blur":"focus"})}).service("$clip",function($rootScope,logger,$window){return $window.ZeroClipboard.config({swfPath:"swf/ZeroClipboard.swf"}),this.createClient=function(el,fnClipData){var client;return client=new $window.ZeroClipboard(el),client.on("ready",function(event){return client.on("copy",function(event){var textData;return textData=fnClipData(),event.clipboardData.setData("text/plain",textData)}),client.on("aftercopy",function(event){})}),client.on("error",function(event){return $window.ZeroClipboard.destroy()}),client},this}).directive("copyUrl",function($timeout,$rootScope,$parse,$api,$location,$clip,logger){return{restrict:"A",link:function(scope,element,attrs,ngModel){var init;return init=function(){var clipLink;clipLink=$clip.createClient($(element),function(){return logger.logSuccess("URLをコピーしました"),$(element).attr("copy-url")})},$timeout(function(){return init()},10)}}})}.call(this),function(){"use strict";angular.module("app.chatroom.search",[]).controller("chatMessageCtrl",function($scope,$rootScope,$modalInstance,$api,search_string,search_this_room,callback,$session,$dialogs,logger,chatStorage,$timeout){var MAX_MSG_LENGTH;return $scope.session=$session,$scope.req={search_this_room:search_this_room,search_string:search_string},$scope.messages=[],$scope.prev_id=null,$scope.next_id=null,MAX_MSG_LENGTH=100,$scope.init=function(){return $scope.messages=[],$scope.prev_id=null,$scope.next_id=null},$scope.search=function(init){var mission_id;if(!$api.is_empty($scope.req.search_string))return init&&$scope.init(),mission_id=$scope.req.search_this_room&&!$api.is_empty($scope.cur_mission)?$rootScope.cur_mission.mission_id:null,chatStorage.search_messages($rootScope.cur_home.home_id,mission_id,$scope.req.search_string,$scope.prev_id,$scope.next_id).then(function(messages){var i,_i,_j,_ref,_ref1,_results,_results1;if(messages.length>0){if(null!==$scope.next_id){for(_results=[],i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$scope.messages.push(messages[i]),$scope.messages.length>MAX_MSG_LENGTH&&$scope.messages.splice(0,$scope.messages.length-MAX_MSG_LENGTH),_results.push($scope.startScrollTimer($scope.next_id,"next"));return _results}if(null!==$scope.prev_id){for(_results1=[],i=_j=0,_ref1=messages.length-1;0<=_ref1?_j<=_ref1:_j>=_ref1;i=0<=_ref1?++_j:--_j)$scope.messages.splice(i,0,messages[i]),$scope.messages.length>MAX_MSG_LENGTH&&$scope.messages.splice(MAX_MSG_LENGTH,$scope.messages.length-MAX_MSG_LENGTH),_results1.push($scope.startScrollTimer($scope.prev_id,"prev"));return _results1}return $scope.messages=messages}})},$scope.scrollTimer=null,$scope.startScrollTimer=function(cmsg_id,type){return null!==$scope.scrollTimer&&$scope.stopScrollTimer(),$scope.scrollTimer=$timeout(function(){var elem,rect,scrollOffset,scrollView;return scrollView=angular.element("#chat_search_view"),elem=angular.element("#chat_"+cmsg_id),elem&&elem[0]&&(rect=elem[0].getBoundingClientRect(),"prev"===type?scrollOffset=0:"next"===type?(scrollOffset=scrollView.outerHeight(),rect&&(scrollOffset-=rect.height)):scrollOffset=0,scrollView.duScrollToElement(angular.element("#chat_"+cmsg_id),scrollOffset)),$scope.stopScrollTimer()})},$scope.stopScrollTimer=function(){if(null!==$scope.scrollTimer)return $timeout.cancel($scope.scrollTimer),$scope.scrollTimer=null},$scope.prev=function(){if($scope.messages.length>0)return $scope.prev_id=$scope.messages[0].cmsg_id,$scope.next_id=null,$scope.search(!1)},$scope.next=function(){var length;if(length=$scope.messages.length,$scope.messages.length>0)return $scope.prev_id=null,$scope.next_id=$scope.messages[length-1].cmsg_id,$scope.search(!1)},$scope.goMessage=function(message){callback&&callback(message),$modalInstance.dismiss("close")},$scope.cancel=function(){return $modalInstance.dismiss("close")},$scope.close=function(){return $modalInstance.dismiss("close")},$scope.search()})}.call(this),function(){"use strict";angular.module("app.chat.star",[]).controller("chatStarCtrl",function($scope,$api,$location,chatStorage,missionStorage,filterFilter,$rootScope,$routeParams,logger,$session,$dateutil,$timeout,$dialogs,CONFIG){return $scope.sync=function(){if(null!==$rootScope.cur_mission&&null!==$session.user_id)return $scope.mission_id=$rootScope.cur_mission.mission_id,chatStorage.messages(null,null,null,!0).then(function(messages){var length;return $scope.messages=messages,length=$scope.messages.length,length>0?$scope.last_cid=$scope.messages[length-1].cmsg_id:$scope.last_cid=null,$scope.initPreviewLink()})},$scope.prev=function(){var prev_id;if($scope.messages)return prev_id=$scope.messages[0].cmsg_id,chatStorage.messages(null,prev_id,null,!0).then(function(messages){var i,_i,_ref;if(messages.length>0){for($scope.messages[0].date_label=$dateutil.ellipsis_time_str($scope.messages[0].date,messages[0].date),i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$scope.messages.splice(i,0,messages[i]);return $scope.messages.length>MAX_MSG_LENGTH&&$scope.messages.splice(MAX_MSG_LENGTH,$scope.messages.length-MAX_MSG_LENGTH),$scope.startScrollTimer(prev_id,"prev"),$scope.initPreviewLink(),messages}return[]})},$scope.next=function(){var length,next_id;if($scope.messages)return length=$scope.messages.length,next_id=$scope.messages[length-1].cmsg_id,chatStorage.messages(null,null,next_id,!0).then(function(messages){var i,_i,_ref;if(messages.length>0){for(messages[0].date_label=$dateutil.ellipsis_time_str(messages[0].date,$scope.messages[length-1].date),i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$scope.messages.push(messages[i]);return $scope.messages.length>MAX_MSG_LENGTH&&$scope.messages.splice(0,$scope.messages.length-MAX_MSG_LENGTH),$scope.startScrollTimer(next_id,"next"),$scope.initPreviewLink(),messages}return[]})},$scope.sync(),$scope.$on("refresh-star",function(){return $scope.sync()}),$scope.initPreviewLink=function(){return $timeout(function(){return $(".preview-image").off("click"),$(".preview-image").on("click",function(){var url;return url=$(this).attr("preview-image"),$dialogs.previewImage(url)})},2e3)},$scope.startScrollTimer=function(cmsg_id,type){return null!==$scope.scrollTimer&&$scope.stopScrollTimer(),$scope.scrollTimer=$timeout(function(){var elem,rect,scrollOffset,scrollView;return scrollView=angular.element("#chat_view"),elem=angular.element("#chat_"+cmsg_id),elem&&elem[0]&&(rect=elem[0].getBoundingClientRect(),"prev"===type?scrollOffset=0:"next"===type?(scrollOffset=scrollView.outerHeight(),rect&&(scrollOffset-=rect.height)):scrollOffset=0,scrollView.duScrollToElement(angular.element("#chat_"+cmsg_id),scrollOffset)),$scope.stopScrollTimer()})},$scope.stopScrollTimer=function(){if(null!==$scope.scrollTimer)return $timeout.cancel($scope.scrollTimer),$scope.scrollTimer=null},$scope.goMessage=function(message){null!==$rootScope.cur_mission&&$rootScope.cur_mission.mission_id===message.mission_id?$rootScope.$broadcast("scroll-to-message",message.cmsg_id):$location.path("/chats/"+message.mission_id+"/"+message.cmsg_id)},$scope.unstar=function(message){message.star=!1,chatStorage.star_message(message.cmsg_id,message.star),$rootScope.$broadcast("unstar-message",message)},$scope.isToMine=function(message){var mine;return!$api.is_empty(message.content)&&(mine=!1,message.content.replace(/\[to:([^\]]*)\]/g,function(item,user_id){if($session.user_id+""===user_id)return mine=!0}),mine)}})}.call(this),function(){var read_timer;read_timer=2e3,angular.module("app.chatroom",[]).controller("chatroomCtrl",function($scope,$api,$chat,missionStorage,chatStorage,taskStorage,homeStorage,CONFIG,filterFilter,$rootScope,$routeParams,logger,$session,$dateutil,$timeout,$dialogs,$location,$window,$compile,$filter){var MAX_MSG_LENGTH,handleLocationChangeStartEvent,startWatchingForLocationChanges,stopWatchingLocation;return $rootScope.nav_id="chatroom_"+$routeParams.mission_id,$scope.show_tasks=!1,$scope.show_process=!1,$scope.show_attach=!1,$scope.show_star=!1,$scope.show_summary=!1,$scope.last_cid=null,$scope.loaded_messages=!1,$scope.max_right_panel=!1,$scope.old_sideWidth=0,$scope.all_avartar=CONFIG.AVARTAR_URL+"all.jpg",$scope.session=$session,$scope.mission_id=parseInt($routeParams.mission_id,10),$scope.chat_id=parseInt($routeParams.chat_id,10),isNaN($scope.chat_id)||$api.is_empty($scope.chat_id)?($api.is_empty($scope.goto_cmsg_id)||($scope.goto_mission_id===$scope.mission_id&&($scope.chat_id=$scope.goto_cmsg_id),$rootScope.goto_cmsg_id=null,$rootScope.goto_mission_id=null),MAX_MSG_LENGTH=100,$rootScope.taskMode=2,$scope.showInviteQR=function(){$dialogs.showQR($api.base_url()+"#/qr/chat/"+$rootScope.cur_mission.mission_id+"/"+$rootScope.cur_mission.invite_key,"handcrowd://invite_chat?id="+$rootScope.cur_mission.mission_id+"&key="+$rootScope.cur_mission.invite_key,"招待QRコード("+$rootScope.cur_mission.mission_name+")")},void 0===$rootScope.cmsg_sn&&($rootScope.cmsg_sn=-1),$scope.init_cmsg=function(){var err,msg;try{msg=localStorage.getItem("r"+$scope.mission_id+"_"+$session.user_id)}catch(_error){err=_error,msg=""}return void 0!==msg&&"undefined"!==msg||(msg=""),$scope.cmsg={cmsg_id:$rootScope.cmsg_sn,user_id:$session.user_id,user_name:$session.user_name,content:msg},$rootScope.cmsg_sn-=1,$timeout(function(){var ta;return $rootScope.$broadcast("elastic:adjust"),ta=angular.element("#chat_ta"),$scope.$emit("elastic:resize",ta)},1e3)},$scope.clear_cmsg=function(clear_storage){$scope.cmsg={cmsg_id:$rootScope.cmsg_sn,user_id:$session.user_id,user_name:$session.user_name,content:""},$rootScope.cmsg_sn-=1,clear_storage===!0&&$scope.save_in_storage()},$scope.save_in_storage=function(){var err,key;try{key="r"+$scope.mission_id+"_"+$session.user_id,null===$scope.cmsg||void 0===$scope.cmsg||""===$scope.cmsg.content?localStorage.removeItem(key):localStorage.setItem(key,$scope.cmsg.content)}catch(_error){err=_error}},$scope.clear_cmsg(),$scope.focusInput=function(){var chat_ta,err;try{return chat_ta=document.getElementById("chat_ta"),chat_ta.focus()}catch(_error){err=_error}},$scope.get_message=function(cmsg_id){var msg,_i,_len,_ref;if($scope.messages)for(_ref=$scope.messages,_i=0,_len=_ref.length;_i<_len;_i++)if(msg=_ref[_i],msg.cmsg_id===cmsg_id)return msg;return null},$scope.load_messages=function(messages){var div_messages,html,length;return $scope.messages=messages,html=chatStorage.messages_to_html($scope.messages,$scope.chat_id),div_messages=angular.element("#chat_main #messages"),div_messages.html(html),$compile(div_messages.contents())($scope),$("#chat_main #loader").hide(),$scope.initEventHandler(),length=$scope.messages.length,length>0?$scope.last_cid=$scope.messages[length-1].cmsg_id:$scope.last_cid=null,isNaN($scope.chat_id)||$api.is_empty($scope.chat_id)?($scope.loaded_messages=!0,$timeout(function(){return $scope.scrollToBottom(!1)})):$timeout(function(){return $scope.scrollToMessage($scope.chat_id)},1e3),$scope.startReadTimer()},$rootScope.$on("$viewContentLoaded",function(){return $(".chat-main #emoticon_gallery").length>0&&($("body > #emoticon_gallery").remove(),$(".chat-main #emoticon_gallery").appendTo($("body"))),$(".chat-main #react_emoticons").length>0&&($("body > #react_emoticons").remove(),$(".chat-main #react_emoticons").appendTo($("body"))),$(".chat-main #to_users").length>0&&($("body > #to_users").remove(),$(".chat-main #to_users").appendTo($("body"))),$("body > #selection_menu").hide(),$(".chat-main #selection_menu").length>0&&($("body > #selection_menu").remove(),$(".chat-main #selection_menu").appendTo($("body"))),$("body").off("dragenter"),$("body").off("dragleave"),$("body").off("dragover"),$("body").off("drop"),$("body").off("click"),$("body").off("mouseup"),$("body").off("mousedown"),$("body").on("mouseup",function(e){var r,sel;return $(".chat-main").length>0?(sel=window.getSelection(),sel.isCollapsed?$("#selection_menu").hide():(r=sel.getRangeAt(0).getBoundingClientRect(),$("#selection_menu").css("left",r.left+20).css("top",r.bottom).show())):($("body").off("mouseup"),$("#selection_menu").remove())}),$("body").on("click",function(e){return $("#input_bar .footer-btn-wrap .btn-smile").each(function(){if(!$(this).is(e.target)&&0===$(this).has(e.target).length&&0===$(".popover").has(e.target).length)return $("#emoticon_gallery").hide(),$(this).data("isShowing","false")}),$("#input_bar .footer-btn-wrap .btn-to").each(function(){if(!$(this).is(e.target)&&0===$(this).has(e.target).length&&0===$(".popover").has(e.target).length)return $("#to_users").hide(),$(this).data("isShowing","false")}),0===$("#file_drop").has(e.target).length&&($("#file_drop").removeClass("dragover"),$("#file_drop").hide()),$(".btn-react").each(function(){if(!$(this).is(e.target)&&0===$(this).has(e.target).length&&0===$(".popover").has(e.target).length)return $("#react_emoticons").hide()})}),$.fn.dndhover=function(options){return this.each(function(){var collection,self;return self=$(this),collection=$(),self.on("dragenter",function(event){return 0===collection.size()&&self.trigger("dndHoverStart"),collection=collection.add(event.target)}),self.on("dragleave",function(event){return $timeout(function(){if(collection=collection.not(event.target),0===collection.size())return self.trigger("dndHoverEnd")},1)}),self.on("drop",function(event){return collection=$()})})},$("body").dndhover().on("dndHoverStart",function(e){var btn_rect,gheight,gwidth,pos;return e.stopPropagation(),e.preventDefault(),$("#input_bar .footer-btn-wrap .btn-file")[0]&&(btn_rect=$("#input_bar .footer-btn-wrap .btn-file")[0].getBoundingClientRect(),pos={x:0,y:0},gwidth=Math.abs($("#file_drop").width()),
gheight=Math.abs($("#file_drop").height()),pos.x=Math.round((btn_rect.left+btn_rect.right-gwidth)/2),pos.y=btn_rect.top-gheight-4,$("#file_drop").css("left",pos.x).css("top",pos.y),$("#file_drop").show()),!1}),$("body").dndhover().on("dndHoverEnd",function(e){return e.stopPropagation(),e.preventDefault(),$("#file_drop .drop-box").removeClass("dragover"),$("#file_drop").hide(),!1}),$("body").on("dragover",function(e){return e.originalEvent.dataTransfer.dropEffect="copy",!1}),$("body").on("drop",function(e){var filelist,files,i,_i,_ref;if(e.stopPropagation(),e.preventDefault(),0!==$("#file_drop").has(e.target).length){for(filelist=e.originalEvent.dataTransfer.files,files=[],i=_i=0,_ref=filelist.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)files.push(filelist[i]);$scope.onUploadFiles(files)}return $("#file_drop .drop-box").removeClass("dragover"),$("#file_drop").hide(),!1}),$("#file_drop .drop-box").on("dragover",function(e){return $(this).addClass("dragover"),!1}),$("#file_drop .drop-box").on("dragleave",function(e){return $(this).removeClass("dragover"),!1}),$("#file_drop").appendTo($("body"))}),$scope.$on("$locationChangeStart",function(){}),stopWatchingLocation=null,handleLocationChangeStartEvent=function(event){var msg,sending_count,targetHash,targetPath,targetSearch,_i,_len,_ref;if(targetPath=$location.path(),targetSearch=$location.search(),targetHash=$location.hash(),sending_count=0,$scope.messages)for(_ref=$scope.messages,_i=0,_len=_ref.length;_i<_len;_i++)msg=_ref[_i],msg.cmsg_id<0&&(sending_count+=1);if(sending_count>0||$scope.files&&$scope.files.length>0)return event.preventDefault(),$dialogs.confirm("未送信のデータ","未送信のデータが存在します。画面を遷移すると送信がキャンセルされます。よろしいでしょうか？","OK",function(){return $location.path(targetPath).search(targetSearch).hash(targetHash),stopWatchingLocation(),$scope.$applyAsync(startWatchingForLocationChanges)})},startWatchingForLocationChanges=function(){return stopWatchingLocation=$scope.$on("$locationChangeStart",handleLocationChangeStartEvent)},$timeout(startWatchingForLocationChanges,0,!1),angular.element("#input_bar .footer-btn-wrap .btn-smile").on("click",function(e){var btn_rect,ele,gheight,gwidth,isShowing,pos;return e.preventDefault(),ele=$(this),isShowing=ele.data("isShowing"),ele.removeData("isShowing"),"true"!==isShowing?(ele.data("isShowing","true"),btn_rect=ele[0].getBoundingClientRect(),pos={x:0,y:0},gwidth=Math.abs($("#emoticon_gallery").width()),gheight=Math.abs($("#emoticon_gallery").height()),pos.x=Math.round((btn_rect.left+btn_rect.right-gwidth)/2),pos.y=btn_rect.top-gheight-4,$("#emoticon_gallery").css("left",pos.x).css("top",pos.y).show()):(ele.data("isShowing","false"),$("#emoticon_gallery").hide())}),$scope.emoticon_message=function(emo_text){var start,str,strPrefix,strSuffix,txta;txta=$(".item-input-wrapper textarea"),start=txta.prop("selectionStart"),str="",$api.is_empty($scope.cmsg.content)?(str=emo_text,start=str.length):(strPrefix=$scope.cmsg.content.substring(0,start),strSuffix=$scope.cmsg.content.substring(start),start+=emo_text.length,str=strPrefix+emo_text+strSuffix),$scope.cmsg.content=str,angular.element("#input_bar .footer-btn-wrap .btn-smile").data("isShowing","false"),$("#emoticon_gallery").hide(),$timeout(function(){var chat_ta;return chat_ta=document.getElementById("chat_ta"),chat_ta.focus(),chat_ta.setSelectionRange(start,start)})},$scope.manage_emoticon=function(){return $dialogs.missionEmoticon()},angular.element("#input_bar .footer-btn-wrap .btn-to").on("click",function(e){var btn_rect,ele,gheight,gwidth,isShowing,pos;return e.preventDefault(),ele=$(this),isShowing=ele.data("isShowing"),ele.removeData("isShowing"),"true"!==isShowing?(ele.data("isShowing","true"),btn_rect=ele[0].getBoundingClientRect(),pos={x:0,y:0},gwidth=Math.abs($("#to_users").width()),gheight=Math.abs($("#to_users").height()),pos.x=Math.round((btn_rect.left+btn_rect.right-gwidth)/2),pos.y=btn_rect.top-gheight-4,$("#to_users").css("left",pos.x).css("top",pos.y),$("#to_users").show()):(ele.data("isShowing","false"),$("#to_users").hide())}),$scope.to_message=function(member){var start,str,strPrefix,strSuffix,to_text,txta;txta=$(".item-input-wrapper textarea"),start=txta.prop("selectionStart"),str="",to_text=void 0===member?"[to:all]全員\n":"[to:"+member.user_id+"]"+$filter("sir_label")(member.user_name)+"\n",$api.is_empty($scope.cmsg.content)?(str=to_text,start=str.length):(strPrefix=$scope.cmsg.content.substring(0,start),strSuffix=$scope.cmsg.content.substring(start),start+=to_text.length,str=strPrefix+to_text+strSuffix),$scope.cmsg.content=str,angular.element("#input_bar .footer-btn-wrap .btn-to").data("isShowing","false"),angular.element("#to_users").hide(),$timeout(function(){var chat_ta;return chat_ta=document.getElementById("chat_ta"),chat_ta.focus(),chat_ta.setSelectionRange(start,start)})},$scope.onUploadFiles=function(files){var ta;return $api.is_empty($scope.files)||0===$scope.files.length?$scope.files=files:$scope.files=$scope.files.concat(files),ta=angular.element("#chat_ta"),$scope.$emit("elastic:resize",ta),angular.forEach(files,function(file){var size,upload;file.progress=0,size=Math.round(100*file.size/1048576)/100,file.fileSize=size,upload=chatStorage.upload_file($scope.mission_id,file).progress(function(evt){return file.progress=parseInt(100*evt.loaded/evt.total)}).success(function(data,status,headers,config){var i,str,to_id;return i=$scope.files.indexOf(file),$scope.files.splice(i,1),$scope.$emit("elastic:resize",ta),0===data.err_code?(str="[file id="+data.mission_attach_id+" url='"+data.mission_attach_url+"']"+file.name+"[/file]",to_id=$rootScope.cur_mission&&3===$rootScope.cur_mission.private_flag?$session.user_id:null,$chat.send(null,$rootScope.cur_home.home_id,$scope.mission_id,str,to_id,1)):logger.logError(data.err_msg),$("#btn_upload input").val("")}),file.upload=upload})},$scope.onCancelUpload=function(file){var i,ta;ta=angular.element("#chat_ta"),file.upload&&(chatStorage.cancel_upload_file(file),i=$scope.files.indexOf(file),$scope.files.splice(i,1),$scope.$emit("elastic:resize",ta))},$scope.scrollTimer=null,$scope.startScrollTimer=function(cmsg_id,type){return null!==$scope.scrollTimer&&$scope.stopScrollTimer(),$scope.scrollTimer=$timeout(function(){var elem,rect,scrollOffset,scrollView;return scrollView=angular.element("#chat_view"),elem=angular.element("#chat_"+cmsg_id),elem&&elem[0]&&(rect=elem[0].getBoundingClientRect(),"prev"===type?scrollOffset=0:"next"===type?(scrollOffset=scrollView.outerHeight(),rect&&(scrollOffset-=rect.height)):scrollOffset=0,scrollView.duScrollToElement(angular.element("#chat_"+cmsg_id),scrollOffset),$("#chat_view").removeClass("transparent")),$scope.stopScrollTimer()})},$scope.stopScrollTimer=function(){if(null!==$scope.scrollTimer)return $timeout.cancel($scope.scrollTimer),$scope.scrollTimer=null},$scope.prev=function(){var prev_id;if($scope.messages)return prev_id=$scope.messages[0].cmsg_id,chatStorage.messages($scope.mission_id,prev_id).then(function(messages){var el,i,messages_html,_i,_ref;if(messages.length>0){for($scope.messages[0].date_label=$dateutil.ellipsis_time_str($scope.messages[0].date,messages[0].date),i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$scope.messages.splice(i,0,messages[i]);return messages_html=chatStorage.messages_to_html(messages,$scope.chat_id),el=$(messages_html),$compile(el.contents())($scope),$("#messages").prepend(el),$scope.startScrollTimer(prev_id,"prev"),$scope.initEventHandler(),messages}return[]})},$scope.getMaxCid=function(){var max_id,message,_i,_len,_ref;if(max_id=0,$api.is_empty($scope.messages))return max_id;for(_ref=$scope.messages,_i=0,_len=_ref.length;_i<_len;_i++)message=_ref[_i],message.cmsg_id>max_id&&(max_id=message.cmsg_id);return max_id},$scope.next=function(){var length,next_id;if($scope.messages)return length=$scope.messages.length,0===length?null:(next_id=$scope.messages[length-1].cmsg_id,next_id<0?null:chatStorage.messages($scope.mission_id,null,next_id).then(function(messages){var el,i,max_cid,messages_html,_i,_ref;if(messages.length>0){for(max_cid=$scope.getMaxCid(),messages[0].date_label=$dateutil.ellipsis_time_str(messages[0].date,$scope.messages[length-1].date),i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)max_cid<messages[i].cmsg_id&&$scope.messages.push(messages[i]);return messages_html=chatStorage.messages_to_html(messages,$scope.chat_id),el=$(messages_html),$compile(el.contents())($scope),$("#messages").append(el),$scope.startScrollTimer(next_id,"next"),$scope.initEventHandler(),messages}return[]}))},$scope.$on("synced-server",function(){return $scope.sync(),$scope.refreshBackImage()}),$scope.$on("refresh-missions",function(){return $scope.sync(!1)}),$scope.$on("select-mission",function(event){return taskStorage.refresh_remaining(),$scope.refreshBackImage()}),$scope.isMessageExist=function(cmsg_id){var exist,message,_i,_len,_ref;for(exist=!1,_ref=$scope.messages,_i=0,_len=_ref.length;_i<_len;_i++)if(message=_ref[_i],message.cmsg_id===cmsg_id){exist=!0;break}return exist},$scope.scrollToMessage=function(cmsg_id,callback){var f_msg,l_msg,length,res;$scope.isMessageExist(cmsg_id)?($scope.loaded_messages=!0,$scope.startScrollTimer(cmsg_id),callback&&callback()):(length=$scope.messages.length,length>0&&(f_msg=$scope.messages[0],l_msg=$scope.messages[length-1],f_msg.cmsg_id>cmsg_id?$scope.prev().then(function(messages){return $scope.isMessageExist(cmsg_id)?($scope.loaded_messages=!0,$scope.startScrollTimer(cmsg_id),callback?callback():void 0):($scope.stopScrollTimer(),$scope.scrollToMessage(cmsg_id,callback))}):l_msg.cmsg_id<cmsg_id&&(res=$scope.next(),null!==res?res.then(function(messages){return $api.is_empty(messages)||0===messages.length?void(callback&&callback()):$scope.isMessageExist(cmsg_id)?($scope.loaded_messages=!0,$scope.startScrollTimer(cmsg_id),callback?callback():void 0):$scope.scrollToMessage(cmsg_id,callback)}):callback&&callback())))},$scope.$on("scroll-to-message",function(event,cmsg_id){return $scope.scrollToMessage(cmsg_id)}),$scope.showTasks=function(){$scope.show_tasks?($scope.show_tasks=!1,$scope.max_right_panel=!1):($scope.show_tasks=!0,$scope.show_process=!1,$scope.show_attach=!1,$scope.show_star=!1,$scope.show_summary=!1),$scope.onResize(!0)},$scope.showProcess=function(){$scope.show_process?($scope.show_process=!1,$scope.max_right_panel=!1):($scope.show_tasks=!1,$scope.show_process=!0,$scope.show_attach=!1,$scope.show_star=!1,$scope.show_summary=!1),$scope.onResize(!0),$scope.focusInput()},$scope.showFiles=function(){$scope.show_attach?($scope.show_attach=!1,$scope.max_right_panel=!1):($scope.show_tasks=!1,$scope.show_process=!1,$scope.show_attach=!0,$scope.show_star=!1,$scope.show_summary=!1),$scope.onResize(!0),$scope.focusInput()},$scope.showStar=function(){$scope.show_star?($scope.show_star=!1,$scope.max_right_panel=!1):($scope.show_tasks=!1,$scope.show_process=!1,$scope.show_attach=!1,$scope.show_star=!0,$scope.show_summary=!1),$scope.onResize(!0),$scope.focusInput()},$scope.showSummary=function(){$scope.show_summary?($scope.show_summary=!1,$scope.max_right_panel=!1):($scope.show_tasks=!1,$scope.show_process=!1,$scope.show_attach=!1,$scope.show_star=!1,$scope.show_summary=!0),$scope.onResize(!0),$scope.focusInput()},$scope.render_message=function(message){var el,i,len,message_html,_i,_ref;if(message.cmsg_id>0&&message.temp_cmsg_id<0&&$("#chat_"+message.temp_cmsg_id).remove(),len=$("#chat_"+message.cmsg_id).length,len>0){if(len>1)for(i=_i=1,_ref=len-1;1<=_ref?_i<=_ref:_i>=_ref;i=1<=_ref?++_i:--_i)$("#chat_"+message.cmsg_id+":eq("+i+")").remove();return message_html=chatStorage.message_to_html(message,$scope.chat_id,!1),$("#chat_"+message.cmsg_id).html(message_html),$compile($("#chat_"+message.cmsg_id).contents())($scope)}return message_html=chatStorage.message_to_html(message,$scope.chat_id),el=$(message_html),$compile(el.contents())($scope),$("#messages").append(el)},$scope.sendMessage=function(){var l_msg,length,to_id;if(!$api.is_empty($scope.cmsg.content))return to_id=$rootScope.cur_mission&&3===$rootScope.cur_mission.private_flag?$session.user_id:null,length=$scope.messages.length,length>1&&(l_msg=$scope.messages[length-1],$scope.last_cid!==l_msg.cmsg_id?$scope.scrollToMessage($scope.last_cid,function(){return chatStorage.set_message($scope.mission_id,$scope.messages,$scope.cmsg,$scope.render_message)}):(chatStorage.set_message($scope.mission_id,$scope.messages,$scope.cmsg,$scope.render_message),$scope.scrollToBottom())),$chat.send($scope.cmsg.cmsg_id,$rootScope.cur_home.home_id,$scope.mission_id,$scope.cmsg.content,to_id),$scope.clear_cmsg(!0)},$scope.$on("receive_message",function(event,cmsg){var l_msg,length;cmsg.mission_id===$scope.mission_id&&(chatStorage.set_message($scope.mission_id,$scope.messages,cmsg,$scope.render_message),length=$scope.messages.length,length>1?cmsg.inserted?(l_msg=$scope.messages[length-2],$scope.last_cid!==l_msg.cmsg_id?($scope.messages.splice(length-1,1),$scope.scrollToMessage(cmsg.cmsg_id),$scope.last_cid=cmsg.cmsg_id):($scope.last_cid=cmsg.cmsg_id,cmsg.date_label=$dateutil.ellipsis_time_str(cmsg.date,l_msg.date),$scope.scrollToBottom())):cmsg.cmsg_id>$scope.last_cid&&($scope.last_cid=cmsg.cmsg_id):1===length&&($scope.last_cid=cmsg.cmsg_id),$scope.initEventHandler(),"visible"===$rootScope.windowState&&$scope.startReadTimer(read_timer))}),$scope.add_react=function(cmsg_id,e){var gheight,gwidth,pos,y;e.stopPropagation(),y=e.pageY?e.pageY:e.clientY+document.body.scrollTop+document.documentElement.scrollTop,pos={x:0,y:0},gwidth=Math.abs($("#react_emoticons").width()),gheight=Math.abs($("#react_emoticons").height()),pos.x=screen.width-gwidth-30,y+gheight>screen.height?pos.y=y-gheight-20:pos.y=y+20,$("#react_emoticons").css("left",pos.x).css("top",pos.y).show(),$scope.cmsg_id=cmsg_id},$scope.react=function(cmsg_id,emoticon_id){$chat.react(cmsg_id,$scope.mission_id,emoticon_id),$("#react_emoticons").hide()},$scope.$on("react_message",function(event,cmsg){var m,_i,_len,_ref;if(cmsg.mission_id===$scope.mission_id){for(_ref=$scope.messages,_i=0,_len=_ref.length;_i<_len;_i++)if(m=_ref[_i],m.cmsg_id===cmsg.cmsg_id){m.reacts=cmsg.reacts,$scope.render_message(m);break}$scope.initEventHandler()}}),$scope.initEventHandler=function(){return $(".preview-image").off("click"),$(".preview-image").on("click",function(){var url;return url=$(this).attr("preview-image"),$dialogs.previewImage(url)}),$(".preview-video").off("click"),$(".preview-video").on("click",function(){var url;return url=$(this).attr("preview-video"),$dialogs.previewVideo(url)})},$scope.scrollToBottom=function(animate){return $timeout(function(){var err,scrollView;try{if(scrollView=angular.element("#chat_view"))return animate===!1?(scrollView.scrollToElement(angular.element("#scroll_bottom")),$("#chat_view").removeClass("transparent")):scrollView.scrollToElementAnimated(angular.element("#scroll_bottom"))}catch(_error){err=_error}},1e3)},$scope.quote=function(cmsg_id){var message,start,str,strPrefix,strSuffix,text,time;void 0!==cmsg_id&&(message=$scope.get_message(cmsg_id),null===message)||(void 0===message?(text=window.getSelection().toString(),$("#selection_menu").hide(),time=Math.floor((new Date).getTime()/1e3),str="[引用 time="+time+"]"+text+"[/引用 time="+time+"]"):(text=message.content,time=new Date(message.date).getTime()/1e3,str="[引用 id="+message.user_id+" name='"+message.user_name+"' time="+time+"]"+text+"[/引用 time="+time+"]"),str+="\n",start=$(".item-input-wrapper textarea").prop("selectionStart"),$api.is_empty($scope.cmsg.content)?start=str.length:(strPrefix=$scope.cmsg.content.substring(0,start),strSuffix=$scope.cmsg.content.substring(start),start+=str.length,str=strPrefix+str+strSuffix),$scope.cmsg.content=str,$timeout(function(){var chat_ta;return chat_ta=document.getElementById("chat_ta"),chat_ta.focus(),chat_ta.setSelectionRange(start,start)}))},$scope.link=function(cmsg_id){var message,start,str,strPrefix,strSuffix,time;message=$scope.get_message(cmsg_id),null!==message&&(start=$(".item-input-wrapper textarea").prop("selectionStart"),time=new Date(message.date).getTime()/1e3,str="[link href='"+$scope.mission_id+"/"+message.cmsg_id+"'][/link]",$api.is_empty($scope.cmsg.content)?start=str.length:(strPrefix=$scope.cmsg.content.substring(0,start),strSuffix=$scope.cmsg.content.substring(start),start+=str.length,str=strPrefix+str+strSuffix),$scope.cmsg.content=str,$timeout(function(){var chat_ta;return chat_ta=document.getElementById("chat_ta"),chat_ta.focus(),chat_ta.setSelectionRange(start,start)}))},$scope.edit=function(cmsg_id){var message;message=$scope.get_message(cmsg_id),null!==message&&($scope.cmsg.editing=!1,$scope.cmsg.cmsg_id=message.cmsg_id,$scope.cmsg.content=message.content,message.editing=!0,$timeout(function(){return angular.element("#chat_ta").focus()}))},$scope.exitEdit=function(){return $scope.cmsg.editing=!1,$scope.clear_cmsg(!0)},$scope.remove=function(cmsg_id){var message;if(message=$scope.get_message(cmsg_id),null!==message)return $dialogs.confirm("メッセージ削除","このメッセージを削除してもよろしいでしょうか？","削除",function(){return $chat.remove(message.cmsg_id,$scope.mission_id)})},$scope.$on("remove_message",function(event,cmsg){var delta,delta_to,is_to_mine,length;if(cmsg.mission_id===$scope.mission_id)return is_to_mine=chatStorage.is_to_mine(cmsg),chatStorage.remove_message($scope.messages,cmsg),cmsg.unread&&(delta=-1,delta_to=0,is_to_mine&&(delta_to=-1),$rootScope.cur_mission.unreads+=delta,$rootScope.cur_mission.to_unreads+=delta_to,$rootScope.cur_home.unreads+=delta,$rootScope.cur_home.to_unreads+=delta_to,chatStorage.remove_unread(cmsg),chatStorage.refresh_unreads_title(),$rootScope.$broadcast("unread-message",$rootScope.cur_mission)),cmsg.cmsg_id===$scope.last_cid&&(length=$scope.messages.length,length>0?$scope.last_cid=$scope.messages[length-1].cmsg_id:$scope.last_cid=null),$("#chat_"+cmsg.cmsg_id).remove(),$scope.$apply()}),$scope.star=function(cmsg_id){var message;if(message=$scope.get_message(cmsg_id),null!==message)return message.star?message.star=!1:message.star=!0,$scope.render_message(message),chatStorage.star_message(message.cmsg_id,message.star)},$rootScope.$on("unstar-message",function(evt,message){var msg,_i,_len,_ref,_results;for(_ref=$scope.messages,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)msg=_ref[_i],msg.cmsg_id===message.cmsg_id?_results.push(msg.star=!1):_results.push(void 0);return _results}),$scope.unread=function(cmsg_id){var message;message=$scope.get_message(cmsg_id),null!==message&&chatStorage.unread_messages($scope.mission_id,[cmsg_id]).then(function(data){var delta,delta_to;return 0===data.err_code?(message.unread=!0,message.set_unread=!0,$scope.set_unread=!0,message.read_class="unread",$("#chat_"+message.cmsg_id).length>0&&$("#chat_"+message.cmsg_id+" .unread-mark i").addClass(message.read_class).removeClass("read"),delta=1,delta_to=0,message.to_flag=chatStorage.is_to_mine(message),message.to_flag&&(delta_to=1),$rootScope.cur_mission.unreads+=delta,$rootScope.cur_mission.to_unreads+=delta_to,$rootScope.cur_home.unreads+=delta,$rootScope.cur_home.unreads+=delta_to,$rootScope.$broadcast("unread-message",$rootScope.cur_mission),missionStorage.set_mission($rootScope.cur_mission),chatStorage.refresh_unreads_title()):logger.logError(data.err_msg)})},$scope.$on("elastic:resize",function(event,ta){var chat_view,curScrollHeight,curScrollTop,fh,fileBar,h,mustScrollToBottom;if(chat_view=angular.element("#chat_view"),curScrollHeight=chat_view[0].scrollHeight-chat_view.outerHeight(),curScrollTop=chat_view.scrollTop(),mustScrollToBottom=$scope.loaded_messages&&curScrollTop>=curScrollHeight,h=parseInt(ta[0].style.height,10),h<34&&(h=34),angular.element("#input_bar").height(h+"px"),fh=$scope.files?25*$scope.files.length:0,fileBar=angular.element("#file_bar"),fh>0?(fileBar.css("bottom",h+10+"px"),chat_view.css("bottom",h+10+fh+10+"px")):chat_view.css("bottom",h+10+"px"),mustScrollToBottom)return $scope.scrollToBottom()}),$scope.onScroll=function(){return $scope.startReadTimer(read_timer)},$scope.readTimer=null,$scope.startReadTimer=function(duration){return null!==$scope.readTimer&&$scope.stopReadTimer(),$scope.readTimer=$timeout(function(){return $scope.readInScroll()},duration)},$scope.stopReadTimer=function(){if(null!==$scope.readTimer)return $timeout.cancel($scope.readTimer),$scope.readTimer=null},$scope.onChangeWindowState=function(visible){return"visible"===visible?$scope.startReadTimer(read_timer):$scope.stopReadTimer()},$rootScope.$on("change-window-state",function(evt,visible){return $scope.onChangeWindowState(visible)}),$scope.readInScroll=function(){var delta,delta_to,message,messageTop,messages,offset,parent,parentRect,readIds,_i,_j,_len,_len1;if(messages=$scope.messages,parent=angular.element("#chat_view")[0]){if(parentRect=angular.element("#chat_view")[0].getBoundingClientRect(),readIds=[],messages)for(_i=0,_len=messages.length;_i<_len;_i++)message=messages[_i],offset=angular.element("#chat_"+message.cmsg_id).offset(),void 0!==offset&&(messageTop=offset.top,messageTop>=parentRect.top&&messageTop<parentRect.bottom&&message.unread&&!message.set_unread&&readIds.push(message.cmsg_id));if(readIds.length>0){for(_j=0,_len1=messages.length;_j<_len1;_j++)message=messages[_j],readIds.indexOf(message.cmsg_id)!==-1&&(message.unread=!1,message.read_class="unread read",$("#chat_"+message.cmsg_id).length>0&&$("#chat_"+message.cmsg_id+" .unread-mark i").addClass(message.read_class),delta=-1,delta_to=0,message.to_flag=chatStorage.is_to_mine(message),message.to_flag&&(delta_to=-1),$rootScope.cur_mission.unreads+=delta,$rootScope.cur_mission.to_unreads+=delta_to,$rootScope.cur_home.unreads+=delta,$rootScope.cur_home.to_unreads+=delta_to,$rootScope.$broadcast("unread-message",$rootScope.cur_mission));return missionStorage.set_mission($rootScope.cur_mission),chatStorage.refresh_unreads_title(),chatStorage.read_messages($scope.mission_id,readIds).then(function(data){if(0!==data.err_code)return logger.logError(data.err_msg)})}}},$scope.editMission=function(){return missionStorage.get($scope.mission_id,function(res){return 0===res.err_code?$dialogs.editMission(res.mission):logger.logError(res.err_msg)})},$scope.memberMission=function(){return missionStorage.get($scope.mission_id,function(res){return 0===res.err_code?$dialogs.memberMission(res.mission):logger.logError(res.err_msg)})},$scope.inviteMission=function(){$dialogs.addMissionMember($rootScope.cur_mission)},void 0===$rootScope.sideWidth&&($rootScope.sideWidth=470),$scope.handleWidth=8,angular.element(".resize-handle-h").draggable({axis:"x",start:function(){return $(this).addClass("dragging")},drag:function(event,obj){return $scope.onResizeH(obj,!1)},stop:function(event,obj){return $(this).removeClass("dragging"),$scope.onResizeH(obj,!0)}}),$scope.onResizeH=function(obj,resize_handle){var navHomeWidth,navWidth,x;return navHomeWidth=angular.element("#nav-home-container").width(),navWidth=angular.element("#nav-container").width()+navHomeWidth,x=obj.position.left,x<400?x>300?($scope.max_right_panel=!0,void $scope.onResize(!0)):($scope.max_right_panel=!1,void $scope.onResize(!0)):(x>$window.innerWidth-navWidth-450&&(x=$window.innerWidth-navWidth-450,obj.position.left=x),$rootScope.sideWidth=$window.innerWidth-navWidth-$scope.handleWidth-x,$scope.onResize(resize_handle))},$scope.onResize=function(repos_handle){var mainWidth,navHomeWidth,navWidth,sideWidth;if($scope.show_tasks===!1&&$scope.show_process===!1&&$scope.show_attach===!1&&$scope.show_star===!1&&$scope.show_summary===!1)return angular.element(".resize-handle-h").hide(),angular.element(".chat-panel").css({width:"100%"}).show(),angular.element(".right-panel").hide();if(angular.element(".resize-handle-h").show(),$scope.max_right_panel===!1){if(null!==$rootScope.sideWidth&&(navHomeWidth=angular.element("#nav-home-container").width(),navWidth=angular.element("#nav-container").width()+navHomeWidth,mainWidth=$window.innerWidth-$rootScope.sideWidth-$scope.handleWidth-navWidth,angular.element(".chat-panel").css({width:mainWidth+"px"}).show(),angular.element(".right-panel").css({width:$rootScope.sideWidth+"px",left:mainWidth+$scope.handleWidth+"px"}).show()),repos_handle)return angular.element(".resize-handle-h").css({left:angular.element(".chat-panel").width()+"px"})}else if(navHomeWidth=angular.element("#nav-home-container").width(),navWidth=angular.element("#nav-container").width()+navHomeWidth,sideWidth=$window.innerWidth-$scope.handleWidth-navWidth,angular.element(".chat-panel").hide(),angular.element(".right-panel").css({width:sideWidth+"px",left:$scope.handleWidth+"px"}).show(),repos_handle)return angular.element(".resize-handle-h").css({width:$scope.handleWidth+"px",left:"0px"})},$scope.onResize(!0),$scope.$on("resize-window",function(){return $scope.onResize(!0)}),angular.element($window).bind("resize",function(){return $rootScope.$broadcast("resize-window")}),$scope.maxRightPanel=function(){$scope.max_right_panel=!$scope.max_right_panel,$scope.onResize(!0)},$scope.addTask=function(cmsg_id){var message,text;return void 0===cmsg_id?(text=window.getSelection().toString(),$("#selection_menu").hide()):(message=$scope.get_message(cmsg_id),message&&(text=message.content)),$dialogs.addTask($rootScope.cur_mission,text)},$scope.showUserProfile=function(user_id){$dialogs.showUserProfile(user_id)},$scope.canComplete=function(){return $rootScope.cur_mission&&$rootScope.canEditMission()&&$rootScope.cur_mission.complete_flag===!1&&3!==$rootScope.cur_mission.private_flag},$scope.canUncomplete=function(){return $rootScope.cur_mission&&$rootScope.canEditMission()&&$rootScope.cur_mission.complete_flag!==!1&&3!==$rootScope.cur_mission.private_flag},$scope.canBreak=function(){return $rootScope.cur_mission&&!($session.user_id===$rootScope.cur_mission.client_id)&&1===$rootScope.cur_mission.private_flag},$scope.completeMissionConfirm=function(){var message;return message=$rootScope.cur_mission.mission_name+"をアーカイブしてもよろしいでしょうか？",$dialogs.confirm("チャットルーム",message,"アーカイブ",function(){missionStorage.complete($rootScope.cur_mission.mission_id,1,function(data){return 0===data.err_code?(missionStorage.set_cur_mission(null),logger.logSuccess("チャットルームがアーカイブされました。"),$location.path("/home"),$(".mission_complete").removeClass("mission_complete_show").show(),$timeout(function(){return $(".mission_complete").addClass("mission_complete_show"),$timeout(function(){return $(".mission_complete").hide(),$rootScope.$broadcast("refresh-missions"),$rootScope.$broadcast("refresh-tasks"),$rootScope.$broadcast("refresh_back_image")},1500)},10)):logger.logError(data.err_msg)})})},$scope.uncompleteMissionConfirm=function(){var message;return message=$rootScope.cur_mission.mission_name+"をアンアーカイブしてもよろしいでしょうか？",$dialogs.confirm("チャットルーム",message,"アンアーカイブ",function(){missionStorage.complete($rootScope.cur_mission.mission_id,0,function(data){return 0===data.err_code?($rootScope.$broadcast("refresh-missions"),$rootScope.$broadcast("refresh-tasks"),$rootScope.$broadcast("refresh_back_image"),logger.logSuccess("チャットルームがアンアーカイブされました。")):logger.logError(data.err_msg)})})},$scope.breakMissionConfirm=function(){var message;return message=$rootScope.cur_mission.mission_name+"から退室します。よろしいでしょうか？",$dialogs.confirm("チャットルームから退室",message,"退室",function(){return $dialogs.confirm("チャットルームから退室","チャットルームから退室すると元に戻すことができなくなります。よろしいでしょうか？","OK",function(){missionStorage.break_mission($rootScope.cur_mission.mission_id,function(data){return 0===data.err_code?($rootScope.$broadcast("refresh-missions"),$rootScope.$broadcast("refresh-tasks"),logger.logSuccess("チャットルームから退室しました。"),$location.path("/home")):logger.logError(data.err_msg)})},null,"btn-danger")})},$scope.$on("$destroy",function(){return angular.forEach($rootScope.missions,function(mission){mission.mission_id===$scope.mission_id&&mission.unreads>0&&!$scope.set_unread&&chatStorage.read_messages($scope.mission_id).then(function(data){return 0===data.err_code?$timeout(function(){return mission.unreads=0,mission.to_unreads=0,$rootScope.unreads[$scope.mission_id]=[],$rootScope.$broadcast("unread-message",mission),chatStorage.refresh_unreads_title()},1e3):logger.logError(data.err_msg)})})}),$scope.refreshBackImage=function(){var back_pos,cover;cover="",$rootScope.cur_mission&&null!==$rootScope.cur_mission.job_back_url?(1===$rootScope.cur_mission.job_back_pos?back_pos=" repeat":2===$rootScope.cur_mission.job_back_pos?back_pos=" no-repeat center center":3===$rootScope.cur_mission.job_back_pos?back_pos=" no-repeat left top":(back_pos=" no-repeat center center",cover="cover"),$(".chat-view").css("background","url("+encodeURI($rootScope.cur_mission.job_back_url)+") "+back_pos)):$(".chat-view").css("background",""),$(".chat-view").css("-webkit-background-size",cover),$(".chat-view").css("-moz-background-size",cover),$(".chat-view").css("-o-background-size",cover),$(".chat-view").css("background-size",cover)},$scope.$on("refresh_back_image",function(){return $scope.refreshBackImage()}),$scope.refreshBackImage(),$scope.sync=function(load_chat_message){if(void 0===load_chat_message&&(load_chat_message=!0),$scope.session=$session,null!==$session.user_id&&(missionStorage.get($scope.mission_id,function(res){var home;if(0===res.err_code){if(2!==res.mission.private_flag&&$rootScope.cur_home.home_id!==res.mission.home_id){if(home=homeStorage.get_home(res.mission.home_id),null===home)return void $location.path("/home");homeStorage.set_cur_home(home)}else 2===res.mission.private_flag&&$rootScope.cur_home&&(res.mission.home_id=$rootScope.cur_home.home_id);return missionStorage.set_cur_mission(res.mission),$scope.refreshBackImage()}return logger.logError(res.err_msg),$location.path("/home")}),load_chat_message))return $scope.init_cmsg(),chatStorage.messages($scope.mission_id,$scope.chat_id).then(function(messages){if(chatStorage.cache_messages($scope.mission_id,messages),$scope.load_messages(messages),0===messages.length&&!$api.is_empty($scope.chat_id))return chatStorage.messages($scope.mission_id,null,$scope.chat_id).then(function(messages){return chatStorage.cache_messages($scope.mission_id,messages),$scope.load_messages(messages)})}),taskStorage.search($scope.mission_id).then(function(tasks){})},$scope.sync(),$scope.searching=!1,$scope.search_string="",$scope.startSearch=function(){return $scope.searching=!0},$scope.exitSearch=function(){return $scope.search_string="",$scope.searching=!1},$scope.search=function(){$api.is_empty($scope.search_string)||($dialogs.chatSearch(!1,$scope.search_string,$scope.onSelectSearchMessage),$scope.exitSearch())},void($scope.onSelectSearchMessage=function(message){$api.is_empty($scope.cur_mission)||message.mission_id!==$scope.cur_mission.mission_id?$location.path("/chats/"+message.mission_id+"/"+message.cmsg_id):($scope.chat_id=message.cmsg_id,$scope.scrollToMessage($scope.chat_id))})):($rootScope.goto_cmsg_id=$scope.chat_id,$rootScope.goto_mission_id=$scope.mission_id,void $location.path("/chats/"+$scope.mission_id))}).constant("chatInputConfig",{append:""}).directive("chatInput",function($timeout,$window,chatInputConfig){"use strict";return{require:"ngModel",restrict:"A, C",link:function(scope,element,attrs,ngModel){var $mirror,$ta,$win,active,adjust,append,borderBox,boxOuter,copyStyle,forceAdjust,heightValue,initMirror,maxHeight,minHeight,minHeightValue,mirror,mirrorInitStyle,mirrored,resize,ta,taStyle,text;ta=element[0],$ta=element,initMirror=function(){var mirrorStyle,mirrored,taStyle;mirrorStyle=mirrorInitStyle,mirrored=ta,taStyle=getComputedStyle(ta),angular.forEach(copyStyle,function(val){mirrorStyle+=val+":"+taStyle.getPropertyValue(val)+";"}),mirror.setAttribute("style",mirrorStyle)},adjust=function(){var active,mirrorHeight,overflow,taComputedStyleWidth,taHeight,width;taHeight=void 0,taComputedStyleWidth=void 0,mirrorHeight=void 0,width=void 0,overflow=void 0,mirrored!==ta&&initMirror(),active||(active=!0,mirror.value=ta.value+append,mirror.style.overflowY=ta.style.overflowY,taHeight=""===ta.style.height?"auto":parseInt(ta.style.height,10),
taComputedStyleWidth=getComputedStyle(ta).getPropertyValue("width"),"px"===taComputedStyleWidth.substr(taComputedStyleWidth.length-2,2)&&(width=parseInt(taComputedStyleWidth,10)-boxOuter.width,mirror.style.width=width+"px"),mirrorHeight=mirror.scrollHeight,mirrorHeight>maxHeight?(mirrorHeight=maxHeight,overflow="scroll"):mirrorHeight<minHeight&&(mirrorHeight=minHeight),mirrorHeight+=boxOuter.height,mirrorHeight<24&&(mirrorHeight=24),ta.style.overflowY=overflow||"hidden",taHeight!==mirrorHeight&&(ta.style.height=mirrorHeight+"px",scope.$emit("elastic:resize",$ta)),scope.$emit("taResize",$ta),$timeout(function(){active=!1},1))},forceAdjust=function(){var active;active=!1,adjust()},"TEXTAREA"===ta.nodeName&&$window.getComputedStyle&&($ta.css({overflow:"hidden","overflow-y":"hidden","word-wrap":"break-word","max-height":"243px"}),text=ta.value,ta.value="",ta.value=text,append=attrs.chatInput?attrs.chatInput.replace(/\\n/g,"\n"):chatInputConfig.append,$win=angular.element($window),mirrorInitStyle="position: absolute; top: -999px; right: auto; bottom: auto;left: 0; overflow: hidden; -webkit-box-sizing: content-box;-moz-box-sizing: content-box; box-sizing: content-box;min-height: 0 !important; height: 0 !important; padding: 0;word-wrap: break-word; border: 0;",$mirror=angular.element('<textarea tabindex="-1" style="'+mirrorInitStyle+'"/>').data("elastic",!0),mirror=$mirror[0],taStyle=getComputedStyle(ta),resize=taStyle.getPropertyValue("resize"),borderBox="border-box"===taStyle.getPropertyValue("box-sizing")||"border-box"===taStyle.getPropertyValue("-moz-box-sizing")||"border-box"===taStyle.getPropertyValue("-webkit-box-sizing"),boxOuter=borderBox?{width:parseInt(taStyle.getPropertyValue("border-right-width"),10)+parseInt(taStyle.getPropertyValue("padding-right"),10)+parseInt(taStyle.getPropertyValue("padding-left"),10)+parseInt(taStyle.getPropertyValue("border-left-width"),10),height:parseInt(taStyle.getPropertyValue("border-top-width"),10)+parseInt(taStyle.getPropertyValue("padding-top"),10)+parseInt(taStyle.getPropertyValue("padding-bottom"),10)+parseInt(taStyle.getPropertyValue("border-bottom-width"),10)}:{width:0,height:0},minHeightValue=parseInt(taStyle.getPropertyValue("min-height"),10),heightValue=parseInt(taStyle.getPropertyValue("height"),10),minHeight=Math.max(minHeightValue,heightValue)-boxOuter.height,maxHeight=parseInt(taStyle.getPropertyValue("max-height"),10),mirrored=void 0,active=void 0,copyStyle=["font-family","font-size","font-weight","font-style","letter-spacing","line-height","text-transform","word-spacing","text-indent"],$ta.data("elastic")||(maxHeight=maxHeight&&maxHeight>0?maxHeight:9e4,mirror.parentNode!==document.body&&angular.element(document.body).append(mirror),$ta.css({resize:"none"===resize||"vertical"===resize?"none":"horizontal"}).data("elastic",!0),"onpropertychange"in ta&&"oninput"in ta?ta.oninput=ta.onkeyup=adjust:ta.oninput=adjust,$win.bind("resize",forceAdjust),scope.$watch(function(){return ngModel.$modelValue},function(newValue){forceAdjust()}),scope.$on("elastic:adjust",function(){initMirror(),forceAdjust()}),$timeout(adjust),scope.$on("$destroy",function(){$mirror.remove(),$win.unbind("resize",forceAdjust)})))}}})}.call(this),function(){"use strict";angular.module("app.bot",[]).controller("botCtrl",function($scope,$api,$chat,missionStorage,homeStorage,$rootScope,$location,$routeParams,logger,$session,$timeout,$dialogs,HPRIV){$rootScope.nav_id="bot",void 0===$rootScope.bot_params&&($rootScope.bot_params={self_only:!1}),$scope.customFilter=function(task){return!$rootScope.bot_params.self_only||task.performer_id===$session.user_id}})}.call(this),function(){"use strict";angular.module("app.home",[]).controller("homeCtrl",function($scope,$api,$chat,missionStorage,homeStorage,$rootScope,$location,$routeParams,logger,$session,$timeout,$dialogs,HPRIV,chatStorage){$scope.query={search_string:""},$scope.editHome=function(){if(null!==$rootScope.cur_home)return $dialogs.editHome($rootScope.cur_home)},$scope.addHome=function(){return $dialogs.addHome()},$scope.addMission=function(){$dialogs.addMission()},$scope.$on("refresh-missions",function(event,new_mission_id){return $scope.sync()}),$scope.removeMission=function(mission){var message;message=mission.mission_name+"を削除してもよろしいでしょうか？",$dialogs.confirm("チャットルーム削除",message,"削除",function(){return missionStorage.remove(mission,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-missions"),logger.logSuccess("チャットルームが削除されました。")):logger.logError(res.err_msg)})})},$scope.selPriv=function(member){return $dialogs.selPriv(member.priv,function(priv){return homeStorage.priv($rootScope.cur_home.home_id,member.user_id,priv,function(res){return 0!==res.err_code?logger.logError(res.err_msg):(member.priv=res.priv,member.priv_name=$rootScope.get_priv_name(res.priv),member.user_id===$session.user_id?($rootScope.cur_home.priv=res.priv,homeStorage.set_cur_home($rootScope.cur_home)):void 0)})})},$scope.removeMember=function(member){return $dialogs.confirm("メンバー削除","「"+member.user_name+"」をグループから削除します。よろしいでしょうか？","確認",function(){homeStorage.remove_member($rootScope.cur_home.home_id,member.user_id,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-missions"),logger.logSuccess("メンバーをグループから削除しました。")):logger.logError(res.err_msg)})})},$scope.inviteMember=function(){return $dialogs.inviteHome($rootScope.cur_home)},$scope.onSelectSearchMessage=function(message){$location.path("/chats/"+message.mission_id+"/"+message.cmsg_id)},$scope.search=function(){$api.is_empty($scope.query.search_string)||$dialogs.chatSearch(!1,$scope.query.search_string,$scope.onSelectSearchMessage)},$scope.toggleCompleted=function(private_flag){if(null!==$rootScope.cur_home)return $rootScope.cur_home.include_completed=!$rootScope.cur_home.include_completed,missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed)},$scope.importCSV=function(){$dialogs.importCSV($rootScope.cur_home.home_id)},$scope.$on("import-csv",function(event,file){$api.import_csv($rootScope.cur_home.home_id,file).progress(function(evt){}).success(function(data,status,headers,config){return 0===data.err_code?(logger.logSuccess(data.imported+"件のタスクが登録されました。"),$rootScope.$broadcast("refresh-missions"),$rootScope.$broadcast("refresh-tasks")):logger.logError(data.err_msg),angular.element("input[type='file']").val("")})}),$scope.removeHome=function(){return $dialogs.confirm("グループ削除","このグループを削除してもよろしいでしょうか？","確認",function(){return $dialogs.confirm("グループ削除","グループを削除すると元に戻すことができなくなります。よろしいでしょうか？","OK",function(){return homeStorage.remove($rootScope.cur_home.home_id,function(res){return 0===res.err_code?(logger.logSuccess("グループを削除しました。"),$rootScope.$broadcast("removed_home")):logger.logError(res.err_msg)})},null,"btn-danger")})},$scope.breakHome=function(){return $dialogs.confirm("グループ退会","このグループから退会します。よろしいでしょうか？","確認",function(){return $dialogs.confirm("グループ退会","グループから退会すると元に戻すことができなくなります。よろしいでしょうか？","OK",function(){homeStorage.break_home($rootScope.cur_home.home_id,function(res){return 0===res.err_code?(logger.logSuccess("グループから退会しました。"),$rootScope.$broadcast("removed_home")):logger.logError(res.err_msg)})},null,"btn-danger")})},$scope.publicFilter=function(mission){return 0===mission.private_flag},$scope.privateFilter=function(mission){return 1===mission.private_flag},$scope.memberFilter=function(mission){return 2===mission.private_flag},$scope.open_member=function(mission){return null!==mission.mission_id?$location.path("/chats/"+mission.mission_id):mission.user_id!==$session.user_id?missionStorage.open_member($rootScope.cur_home.home_id,mission.user_id,function(res){var new_mission_id;return 0===res.err_code?(new_mission_id=res.mission_id,missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed).then(function(){return $location.path("/chats/"+new_mission_id)})):logger.logError(res.err_msg)}):void 0},$scope.sync=function(){var home_id,include_completed;if($rootScope.nav_id="home",missionStorage.select_mission_in_nav(),null!==$session.user_id){if(void 0===$routeParams.home_id){if($rootScope.cur_home)return void $location.path("/home/"+$rootScope.cur_home.home_id)}else home_id=parseInt($routeParams.home_id,10),$rootScope.cur_home&&$rootScope.cur_home.home_id===home_id&&(include_completed=$rootScope.cur_home.include_completed),void 0===include_completed&&(include_completed=!0),homeStorage.get(home_id,include_completed,include_completed,function(res){return 0===res.err_code?homeStorage.set_cur_home(res.home):logger.logError("ホーム情報を取得できません。")});return chatStorage.refresh_unreads_title()}},$scope.$on("synced-server",function(){return $scope.sync()}),$scope.$on("reload_session",function(){return $scope.sync()}),$scope.sync(),$scope.showInviteQR=function(){null!==$rootScope.cur_home&&$dialogs.showQR($api.base_url()+"#/qr/home/"+$rootScope.cur_home.home_id+"/"+$rootScope.cur_home.invite_key,"handcrowd://invite_home?id="+$rootScope.cur_home.home_id+"&key="+$rootScope.cur_home.invite_key,"招待QRコード("+$rootScope.cur_home.home_name+")")}})}.call(this),function(){angular.module("app.home.add",[]).controller("homeAddCtrl",function($scope,$rootScope,$modalInstance,homeStorage,$api,logger){return $scope.posting=!1,$scope.home={home_name:""},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.canSubmit=function(){return $scope.form_home_add.$valid},$scope.ok=function(){if(!$scope.posting)return $scope.posting=!0,homeStorage.add($scope.home,function(res){return 0===res.err_code?($rootScope.$broadcast("added_home",res.home),$scope.cancel(),logger.logSuccess("新しいグループが作成されました。")):logger.logError(res.err_msg),$scope.posting=!1})}})}.call(this),function(){"use strict";angular.module("app.home.edit",[]).controller("homeEditCtrl",function($rootScope,$scope,$api,$modalInstance,filterFilter,homeStorage,logger,$session,$dialogs,$timeout,home,$location,$chat){$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.init=function(){return $scope.editSummaryMode=!1,$scope.editHomeNameMode=!1,home.org_home_name=home.home_name,home.org_summary=home.summary,$scope.home=home},$scope.init(),$scope.changeHomeName=function(home){var params;return home.home_name=home.home_name.trim(),home.home_name===home.org_home_name?void($scope.editHomeNameMode=!1):(""===home.home_name?home.home_name=home.org_home_name:(params={home_id:home.home_id,home_name:home.home_name},homeStorage.edit(params,function(data){return 0!==data.err_code?logger.logError(data.err_msg):(home.org_home_name=home.home_name,$rootScope.cur_home.home_name=home.home_name,$rootScope.$broadcast("refresh-home",home))})),$scope.editHomeNameMode=!1)},$scope.editHomeName=function(home){if($rootScope.canEditHome())return $scope.editHomeNameMode=!0},$scope.editSummary=function(){$rootScope.canEditHome()&&($scope.editSummaryMode=!0)},$scope.exitEditSummary=function(){$scope.home.summary=$scope.home.org_summary,$scope.editSummaryMode=!1},$scope.submitSaveSummary=function(home){var params;params={home_id:home.home_id,summary:home.summary},homeStorage.edit(params),$scope.home.org_summary=$scope.home.summary,$scope.editSummaryMode=!1},$scope.onUploadLogo=function(files){var file;return file=files[0],homeStorage.upload_logo($scope.home.home_id,file).progress(function(evt){}).success(function(data,status,headers,config){return 0===data.err_code?($scope.home.logo_url=data.logo_url,home=homeStorage.get_home($scope.home.home_id),home.logo_url=$scope.home.logo_url,$chat.home("refresh-logo",$scope.home.home_id),$rootScope.$broadcast("refresh-home",$scope.home)):logger.logError(data.err_msg)})},$scope.onRemoveLogo=function(){homeStorage.remove_logo($scope.home.home_id,function(res){return 0===res.err_code?($scope.home.logo_url=res.logo_url,home=homeStorage.get_home($scope.home.home_id),home.logo_url=$scope.home.logo_url,$chat.home("refresh-logo",$scope.home.home_id),$rootScope.$broadcast("refresh-home",$scope.home)):logger.logError(res.err_msg)})}})}.call(this),function(){angular.module("app.home.invite",[]).controller("homeInviteCtrl",function($scope,$rootScope,$modalInstance,$api,home,email,logger,$timeout,$session,homeStorage,$chat,ALERT_TYPE,$dialogs){var content;return content=$session.user_name+"( "+$session.email+" )様より、「ハンドクラウド」へ招待されました。\n招待されたグループは、下記の通りです。\nグループ名:"+home.home_name+"\n",$scope.posting=!1,$scope.req={email:email,content:content,home_id:home.home_id,signup_url:$api.base_url()+"#/signup",signin_url:$api.base_url()+"#/signin"},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.ok=function(){return $scope.posting=!0,homeStorage.invite($scope.req,function(res){return $scope.posting=!1,0===res.err_code?(null!==res.user_id&&$chat.alert(ALERT_TYPE.INVITE_HOME,res.user_id,{home_id:home.home_id,home_name:home.home_name}),$rootScope.$broadcast("refresh-missions"),logger.logSuccess("グループに招待しました。"),$scope.cancel()):logger.logError(res.err_msg)})},$scope.canSubmit=function(){return $scope.form_home_invite.$valid&&!$scope.posting},$scope.showInviteQR=function(){$scope.cancel(),$dialogs.showQR($api.base_url()+"#/qr/home/"+home.home_id+"/"+home.invite_key,"handcrowd://invite_home?id="+home.home_id+"&key="+home.invite_key,"招待QRコード("+home.home_name+")")}})}.call(this),function(){"use strict";angular.module("app.controller.main",[]).controller("AppCtrl",function($scope,$location,$rootScope){return $scope.isSpecificPage=function(){var found,p,path,_i,_len,_ref;for(path=$location.path(),found=!1,_ref=["/404","/pages/500","/login","/signin","/signup","/signup_facebook","/signup_google","/activate","/forgotpwd","/resetpwd","/loadapp","/qr"],_i=0,_len=_ref.length;_i<_len;_i++)p=_ref[_i],p!==path&&0!==path.indexOf(p+"/")||(found=!0);return found},$rootScope.getMenu=function(path){var f,menu;return void 0===path||""===path?"":(menu=path.substr(1),f=menu.indexOf("/"),f>0&&(menu=menu.substr(0,f)),menu)},$rootScope.isMissionPanel=function(){var menu;return menu=$rootScope.getMenu($rootScope.lastPath),"missions"===menu||"process"===menu},$rootScope.isTeamPanel=function(){var menu;return menu=$rootScope.getMenu($rootScope.lastPath),"team"===menu},$rootScope.isCalendarPanel=function(){var menu;return menu=$rootScope.getMenu($rootScope.lastPath),"calendar"===menu},$rootScope.isCategoryPanel=function(){var menu;return menu=$rootScope.getMenu($rootScope.lastPath),"categories"===menu},$rootScope.isSearchPanel=function(){var menu;return menu=$rootScope.getMenu($rootScope.lastPath),"search"===menu},$scope.main={brand:"ハンドクラウド"}})}.call(this),function(){angular.module("app.mission.add",[]).controller("missionAddCtrl",function($scope,$rootScope,$modalInstance,missionStorage,$api,logger,$location,$timeout){return $scope.posting=!1,$scope.mission={home_id:$rootScope.cur_home.home_id,mission_name:"",private_flag:1},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.canSubmit=function(){return $scope.form_mission_add.$valid},$scope.ok=function(){if(!$scope.posting)return $scope.posting=!0,missionStorage.add($scope.mission,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-missions",res.mission_id),$scope.cancel(),logger.logSuccess("新しいチャットルームが作成されました。")):logger.logError(res.err_msg),$scope.posting=!1})}})}.call(this),function(){"use strict";angular.module("app.mission.attach",[]).controller("missionAttachCtrl",function($scope,$api,taskStorage,missionStorage,chatStorage,filterFilter,$rootScope,$routeParams,logger,$session,$dateutil,$timeout,$dialogs,CONFIG){return $scope.sync=function(){if($scope.mission_id=$api.is_empty($rootScope.cur_mission)?null:$rootScope.cur_mission.mission_id,null!==$scope.mission_id)return missionStorage.attaches($scope.mission_id,function(res){if(0===res.err_code)return $scope.attaches=res.attaches})},$scope.sync(),$scope.$on("synced-server",function(){$scope.sync()}),$scope.onUploadFiles=function(files){return $api.is_empty($scope.files)||0===$scope.files.length?$scope.files=files:$scope.files=$scope.files.concat(files),angular.forEach(files,function(file){var size,upload;file.progress=0,size=Math.round(100*file.size/1048576)/100,file.file_size=size,upload=chatStorage.upload_file($scope.mission_id,file).progress(function(evt){return file.progress=parseInt(100*evt.loaded/evt.total)}).success(function(data,status,headers,config){var attach,attach_url,i;return i=$scope.files.indexOf(file),$scope.files.splice(i,1),0===data.err_code?(attach_url=CONFIG.API_BASE+data.mission_attach_url,attach={mission_attach_id:data.mission_attach_id,create_time:data.create_time,file_name:file.name,attach_url:attach_url,file_size:size},$scope.attaches.unshift(attach)):logger.logError(data.err_msg)}),file.upload=upload})},$scope.onCancelUpload=function(file){var i;file.upload&&($api.cancel_upload(file.upload),i=$scope.files.indexOf(file),$scope.files.splice(i,1))},$scope.remove=function(attach){return missionStorage.remove_attach($scope.mission_id,attach.mission_attach_id,function(res){var i;if(0===res.err_code)return i=$scope.attaches.indexOf(attach),$scope.attaches.splice(i,1)})}})}.call(this),function(){"use strict";angular.module("app.mission.edit",[]).controller("missionEditCtrl",function($rootScope,$scope,$api,$modalInstance,filterFilter,missionStorage,logger,$session,$dialogs,$timeout,mission,$location){$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.init=function(){return $scope.editSummaryMode=!1,$scope.editMissionNameMode=!1,mission.org_mission_name=mission.mission_name,mission.org_summary=mission.summary,mission.org_private_flag=mission.private_flag,mission.org_push_flag=mission.push_flag,$scope.mission=mission},$scope.init(),$scope.canEdit=function(){return $rootScope.canEditMission()&&3!==$scope.mission.private_flag},$scope.canRepeat=function(){return null!==$session.planconfig&&$session.planconfig.repeat_flag===!0},$scope.canBackImage=function(){return null!==$session.planconfig&&$session.planconfig.back_image_flag===!0},$scope.changeMissionName=function(mission){var params;return mission.mission_name=mission.mission_name.trim(),mission.mission_name===mission.org_mission_name?void($scope.editMissionNameMode=!1):(""===mission.mission_name?mission.mission_name=mission.org_mission_name:(params={mission_id:mission.mission_id,mission_name:mission.mission_name},missionStorage.edit(params,function(data){return 0!==data.err_code?logger.logError(data.err_msg):(mission.org_mission_name=mission.mission_name,$rootScope.cur_mission.mission_name=mission.mission_name,missionStorage.set_mission($rootScope.cur_mission),$rootScope.$broadcast("refresh-nav"))})),$scope.editMissionNameMode=!1)},$scope.editMissionName=function(mission){if($scope.canEdit())return $scope.editMissionNameMode=!0},$scope.editSummary=function(){$scope.canEdit()&&($scope.editSummaryMode=!0)},$scope.exitEditSummary=function(){$scope.mission.summary=$scope.mission.org_summary,$scope.editSummaryMode=!1},$scope.submitSaveSummary=function(mission){},$scope.onUploadBackImage=function(files,type){var file;if(0!==files.length)return file=files[0],missionStorage.upload_back_image($scope.mission.mission_id,type,file).progress(function(evt){}).success(function(data,status,headers,config){return 0===data.err_code?($scope.mission.job_back=data.job_back,$scope.mission.job_back_url=data.job_back_url,$scope.mission.job_back_pos=data.job_back_pos,$scope.mission.prc_back=data.prc_back,$scope.mission.prc_back_url=data.prc_back_url,$scope.mission.prc_back_pos=data.prc_back_pos,missionStorage.set_cur_mission($scope.mission),logger.logSuccess("背景画像を変更しました。"),angular.element("input[type='file']").val(""),$rootScope.$broadcast("refresh_back_image")):logger.logError(data.err_msg)})},$scope.onSettingBackImage=function(type){return $dialogs.settingBackImage($scope.mission,type)},$scope.setRepeat=function(){missionStorage.set_repeat($scope.mission.mission_id,$scope.mission.repeat_type,$scope.mission.repeat_weekday,$scope.mission.repeat_month,$scope.mission.repeat_monthday,function(data){if(0!==data.err_code)return logger.logError(data.err_msg)})},$scope.changeMissionPrivateFlag=function(mission){var message;if(parseInt(mission.org_private_flag,10)!==parseInt(mission.private_flag,10)){if("0"===mission.private_flag)message="このチャットルームをパブリックルームに変更してもよろしいでしょうか？";else{if("1"!==mission.private_flag)return;message="このチャットルームをプライベートルームに変更してもよろしいでしょうか？"}$dialogs.confirm("確認",message,"OK","confirm-change-private-flag",mission,"cancel-change-private-flag")}},$scope.$on("confirm-change-private-flag",function(){var params;return mission.private_flag=parseInt(mission.private_flag,10),params={mission_id:mission.mission_id,private_flag:mission.private_flag},missionStorage.edit(params,function(data){return 0!==data.err_code?logger.logError(data.err_msg):(mission.org_private_flag=mission.private_flag,$rootScope.cur_mission.private_flag=mission.private_flag,missionStorage.set_mission($rootScope.cur_mission),$rootScope.$broadcast("refresh-nav"))})}),$scope.$on("cancel-change-private-flag",function(){return mission.private_flag=mission.org_private_flag}),$scope.changeMissionAlertFlag=function(mission){var params;parseInt(mission.org_push_flag,10)!==parseInt(mission.push_flag,10)&&(mission.push_flag=parseInt(mission.push_flag,10),params={mission_id:mission.mission_id,push_flag:mission.push_flag},missionStorage.edit(params,function(data){return 0!==data.err_code?logger.logError(data.err_msg):(mission.org_push_flag=mission.push_flag,$rootScope.cur_mission.push_flag=mission.push_flag,missionStorage.set_mission($rootScope.cur_mission))}))},$scope.canRemove=function(){return $rootScope.cur_mission&&$rootScope.canEditMission()&&3!==$rootScope.cur_mission.private_flag},$scope.removeMissionConfirm=function(){var message;return message=$rootScope.cur_mission.mission_name+"を削除してもよろしいでしょうか？",$dialogs.confirm("チャットルーム削除",message,"削除",function(){return $dialogs.confirm("チャットルーム削除","チャットルームを削除すると元に戻すことができなくなります。よろしいでしょうか？","OK",function(){missionStorage.remove($rootScope.cur_mission,function(data){return 0===data.err_code?(missionStorage.set_cur_mission(null),$rootScope.$broadcast("refresh-missions"),$rootScope.$broadcast("refresh-tasks"),$rootScope.$broadcast("refresh_back_image"),logger.logSuccess("チャットルームが削除されました。"),$location.path("/home")):logger.logError(data.err_msg)}),$scope.cancel()},null,"btn-danger")})}}).controller("missionSummaryCtrl",function($rootScope,$scope,$api,missionStorage,logger,$session,$dialogs,$timeout,$location){var org_summary;$scope.editMode=!1,org_summary=$rootScope.cur_mission.summary,$scope.edit=function(){return $scope.editMode=!0},$scope.cancel=function(){return $rootScope.cur_mission.summary=org_summary,$scope.editMode=!1},$scope.save=function(){var params;return params={mission_id:$rootScope.cur_mission.mission_id,summary:$rootScope.cur_mission.summary},missionStorage.edit(params),org_summary=$rootScope.cur_mission.summary,missionStorage.set_mission($rootScope.cur_mission),$scope.editMode=!1}})}.call(this),function(){"use strict";angular.module("app.mission.emoticon",[]).controller("missionEmoticonCtrl",function($rootScope,$scope,$api,$modalInstance,filterFilter,missionStorage,logger,$session,$dialogs,$timeout,$location,CONFIG){$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.is_custom=function(em){return null!==em.home_id},$scope.onUpload=function(files,type){var file;if(0!==files.length)return file=files[0],missionStorage.upload_emoticon($scope.cur_mission.mission_id,file).progress(function(evt){}).success(function(data,status,headers,config){return 0===data.err_code?($scope.emoticon.image=CONFIG.BASE+data.image,angular.element("input[type='file']").val("")):logger.logError(data.err_msg)})},$scope.change_alt=function(){var alt;if(alt=$scope.emoticon.alt,!$api.is_empty(alt)&&alt.length>0)return":"!==alt[0]&&(alt=":"+alt),";"!==alt[alt.length-1]&&(alt+=";"),$scope.emoticon.alt=alt},$scope.canUpdate=function(){return $scope.form_emoticon.$valid&&!$api.is_empty($scope.emoticon.image)},$scope.edit=function(em){return $scope.emoticon===em?$scope.init():($scope.emoticon=em,$scope.emoticon.mission_id=$rootScope.cur_mission.mission_id)},$scope.add=function(){return missionStorage.add_emoticon($scope.emoticon,function(res){return 0===res.err_code?($api.init_emoticon(res.emoticon),$rootScope.emoticons.push(res.emoticon),$scope.init()):logger.logError(res.err_msg),$scope.cancel()})},$scope.save=function(){return missionStorage.save_emoticon($scope.emoticon,function(res){var i,_i,_ref;if(0===res.err_code){if($api.init_emoticon(res.emoticon),$rootScope.emoticons)for(i=_i=0,_ref=$rootScope.emoticons.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$rootScope.emoticons[i].emoticon_id===res.emoticon.emoticon_id&&($rootScope.emoticons[i]=res.emoticon);$scope.init()}else logger.logError(res.err_msg);return $scope.cancel()})},$scope.remove=function(){var emoticon_id;return emoticon_id=$scope.emoticon.emoticon_id,missionStorage.remove_emoticon(emoticon_id,function(res){var i,_i,_ref;if(0===res.err_code){if($rootScope.emoticons)for(i=_i=0,_ref=$rootScope.emoticons.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if($rootScope.emoticons[i].emoticon_id===emoticon_id){$rootScope.emoticons.splice(i,1);break}$scope.init()}else logger.logError(res.err_msg);return $scope.cancel()})},$scope.init=function(){return $scope.emoticon={mission_id:$rootScope.cur_mission.mission_id,alt:"",title:""}},$scope.init()})}.call(this),function(){angular.module("app.mission.invite",[]).controller("missionInviteCtrl",function($scope,$rootScope,$modalInstance,$api,mission,email,logger,$timeout,$session,missionStorage,$chat,ALERT_TYPE){var content;return content=$session.user_name+"( "+$session.email+" )様より、「ハンドクラウド」へ招待されました。\n招待されたチャットルームは、下記の通りです。\nチャットルーム名:"+mission.mission_name+"\n",$scope.posting=!1,null!==mission.summary&&(content=content+"概要:\n"+mission.summary),$scope.req={email:email,content:content,mission_id:mission.mission_id,signup_url:$api.base_url()+"#/signup",signin_url:$api.base_url()+"#/signin"},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.ok=function(){return $scope.posting=!0,missionStorage.invite($scope.req,function(res){return $scope.posting=!1,0===res.err_code?(null!==res.user_id&&$chat.alert(ALERT_TYPE.INVITE_HOME,res.user_id,{home_id:$rootScope.cur_home.home_id,home_name:$rootScope.cur_home.home_name,mission_id:mission.mission_id,mission_name:mission.mission_name}),logger.logSuccess("チャットルームに招待しました。"),$scope.cancel()):logger.logError(res.err_msg)})},$scope.canSubmit=function(){return $scope.form_mission_invite.$valid&&!$scope.posting}})}.call(this),function(){"use strict";angular.module("app.mission.member",[]).controller("missionMemberCtrl",function($scope,$rootScope,$api,$modalInstance,missionStorage,filterFilter,logger,$session,$dialogs,$timeout,mission,RPRIV){$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.init=function(){return $scope.editSummaryMode=!1,$scope.editMissionNameMode=!1,$scope.mission=mission},$scope.init(),$scope.canRemoveUser=function(member){return $rootScope.canEditMissionMember()},$scope.removeUser=function(user){var message;message="このユーザーを共有解除してもよろしいでしょうか？",$dialogs.confirm("共有解除",message,"確認","deinvite-user",user)},$scope.$on("deinvite-user",function(event,user){missionStorage.remove_member($scope.mission.mission_id,user.user_id,function(res){var i,_i,_j,_ref,_ref1;if(0===res.err_code){for(logger.logSuccess(user.user_name+"が共有解除されました。"),i=_i=0,_ref=$scope.mission.members.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if($scope.mission.members[i].user_id===user.user_id){$scope.mission.members.splice(i,1);break}for(i=_j=0,_ref1=$rootScope.cur_mission.members.length-1;0<=_ref1?_j<=_ref1:_j>=_ref1;i=0<=_ref1?++_j:--_j)if($rootScope.cur_mission.members[i].user_id===user.user_id){$rootScope.cur_mission.members.splice(i,1);break}$scope.init()}else logger.logError(res.err_msg)})}),$scope.addMissionMember=function(mission,search_string){$dialogs.addMissionMember(mission,search_string),$scope.cancel()},$scope.showUserProfile=function(user_id){$dialogs.showUserProfile(user_id)},$scope.selPriv=function(member){return $dialogs.selRoomPriv(member.priv,function(priv){return missionStorage.priv($scope.mission.mission_id,member.user_id,priv,function(res){return 0!==res.err_code?logger.logError(res.err_msg):(member.priv=res.priv,member.priv_name=$rootScope.get_rpriv_name(res.priv),member.user_id===$session.user_id?($rootScope.cur_mission.priv=res.priv,missionStorage.set_cur_mission($rootScope.cur_mission)):void 0)})})},$scope.showInviteQR=function(mission){$scope.cancel(),$dialogs.showQR($api.base_url()+"#/qr/chat/"+mission.mission_id+"/"+mission.invite_key,"handcrowd://invite_chat?id="+mission.mission_id+"&key="+mission.invite_key,"招待QRコード("+mission.mission_name+")")}})}.call(this),function(){angular.module("app.mission.member_add",[]).controller("missionMemberAddCtrl",function($scope,$rootScope,$modalInstance,$api,mission,search_string,$dialogs,logger,missionStorage,$chat,ALERT_TYPE){return $scope.posting=!1,$scope.mission=mission,$scope.search_string=search_string,$scope.users=[],$scope.selecteds=0,$scope.search=function(){missionStorage.invitable_members(mission.mission_id,function(res){0===res.err_code?$scope.users=res.users:logger.logError(res.err_msg)})},$scope.selectUser=function(user){return user.selected?(user.selected=!1,$scope.selecteds=$scope.selecteds-1):(user.selected=!0,$scope.selecteds=$scope.selecteds+1)},$scope.canInvite=function(){return $scope.selecteds>0},$scope.invite=function(){var user,_i,_len,_ref;if($scope.canInvite()){for($scope.posting=!0,$scope.count=0,_ref=$scope.users,_i=0,_len=_ref.length;_i<_len;_i++)user=_ref[_i],user.selected&&($scope.count+=1,$scope.req={user_id:user.user_id,mission_id:mission.mission_id,signup_url:$api.base_url()+"#/signup",signin_url:$api.base_url()+"#/signin"},missionStorage.invite($scope.req,function(res){$scope.count-=1,$scope.posting=!1,0===res.err_code?(null!==res.user_id&&$chat.alert(ALERT_TYPE.INVITE_HOME,res.user_id,{home_id:$rootScope.cur_home.home_id,home_name:$rootScope.cur_home.home_name,mission_id:mission.mission_id,mission_name:mission.mission_name}),logger.logSuccess(res.user_name+"をチャットルームに招待しました。"),$rootScope.$broadcast("invite-user"),$scope.cancel()):logger.logError(res.err_msg),0===$scope.count&&$rootScope.$broadcast("refresh-missions")}));$modalInstance.close("select")}else $api.is_empty($scope.search_string)||$scope.invite_mission()},$scope.invite_mission=function(){$dialogs.inviteMission($scope.mission,$scope.search_string),$modalInstance.dismiss("cancel")},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.search()})}.call(this),function(){"use strict";angular.module("app.mission.open",[]).controller("missionOpenCtrl",function($scope,$api,$modalInstance,missionStorage,filterFilter,$rootScope,logger,$session,$dialogs,$timeout,private_flag){$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.init=function(){return missionStorage.unpinned_missions($rootScope.cur_home.home_id,private_flag,function(res){return $scope.missions=res.missions})},$scope.open=function(mission){2===private_flag?missionStorage.open_member($rootScope.cur_home.home_id,mission.user_id,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-missions"),logger.logSuccess("チャットルームを開きました。"),$scope.cancel()):logger.logError(res.err_msg)}):missionStorage.open(mission.mission_id,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-missions"),logger.logSuccess("チャットルームを開きました。"),$scope.cancel()):logger.logError(res.err_msg)})},$scope.init()})}.call(this),function(){"use strict";angular.module("app.controller.nav",[]).controller("NavCtrl",function($scope,$rootScope,$session,AUTH_EVENTS,$timeout,$location,$dialogs,$route,missionStorage,logger,$api,$window){var app;return app=$("#app"),$scope.init=function(){return $scope.session=$session,$scope.loaded=!1,$timeout(function(){return $scope.loaded=!0;
})},$scope.init(),$scope.$on(AUTH_EVENTS.loginSuccess,function(event,count){return $scope.init()}),$scope.$on("reload_session",function(event,count){return $scope.init()}),$scope.$on("synced-server",function(event,count){return $scope.init()}),$scope.$on("select-home",function(event){return $scope.init()}),$scope.$on("mission-search-post",function(event){return $scope.init()}),$scope.$on("refresh-nav",function(event){return $scope.init()}),$scope.showAlerts=function(){return $dialogs.showAlerts()},$scope.addMission=function(){$dialogs.addMission()},$scope.openMission=function(private_flag){$dialogs.openMission(private_flag)},$scope.pinMission=function(mission_id){var mission,pinned;null!==mission_id&&(mission=missionStorage.get_mission(mission_id),null!==mission&&(pinned=1===mission.pinned?0:1,missionStorage.pin(mission_id,pinned,function(res){var id;return 0===res.err_code?(mission.pinned=pinned,id="#"+missionStorage.mission_html_id(mission),mission.pinned?$(id+" .pin").removeClass("btn-pin"):$(id+" .pin").addClass("btn-pin")):logger.logError(res.err_msg)})))},$scope.inviteMember=function(){return $dialogs.inviteHome($rootScope.cur_home)},$scope.groups=[!0,!0,!0],$scope.toggleGroup=function(index){return $scope.groups[index]=!$scope.groups[index],$scope.refreshGroup(index)},$scope.refreshGroup=function(index){var id,mission,set,show,_i,_len,_ref,_results;if(show=$scope.groups[index],$rootScope.missions){for(_ref=$rootScope.missions,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)mission=_ref[_i],id=missionStorage.mission_html_id(mission),set=!1,0===index?0!==mission.private_flag&&1!==mission.private_flag||(set=!0):2===index&&2===mission.private_flag&&mission.user_id!==$session.user_id&&(set=!0),set?show?_results.push($("#"+id).removeClass("hide")):mission.visible?_results.push(void 0):_results.push($("#"+id).addClass("hide")):_results.push(void 0);return _results}},$scope.selectLogout=function(){var message;message="ログアウトします。よろしいでしょうか？",$dialogs.confirm("ログアウト",message,"ログアウト","logout")},$scope.$on("logout",function(){return app.removeClass("expanded"),$location.path("/signout")}),$scope.search_string="",$scope.onSelectSearchMessage=function(message){$api.is_empty($scope.cur_mission)||message.mission_id!==$scope.cur_mission.mission_id?$location.path("/chats/"+message.mission_id+"/"+message.cmsg_id):$rootScope.$broadcast("scroll-to-message",message.cmsg_id)},$scope.search=function(){$api.is_empty($scope.search_string)||($dialogs.chatSearch(!1,$scope.search_string,$scope.onSelectSearchMessage),$scope.search_string="",$scope.changeSearch())},$scope.exitSearch=function(){return $scope.search_string="",$scope.changeSearch()},$scope.changeSearch=function(){var id,mission,_i,_len,_ref,_results;if($api.is_empty($scope.search_string))return $scope.refreshGroup(0),$scope.refreshGroup(2);if($rootScope.missions){for(_ref=$rootScope.missions,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)mission=_ref[_i],id=missionStorage.mission_html_id(mission),mission.mission_name.indexOf($scope.search_string)>-1||mission.login_id&&mission.login_id.indexOf($scope.search_string)>-1?_results.push($("#"+id).removeClass("hide")):_results.push($("#"+id).addClass("hide"));return _results}},$scope.$on("unread-message",function(event,mission){var id;return id="#"+missionStorage.mission_html_id(mission),$(id+" .unreads").html(missionStorage.mission_unreads_to_html(mission)),0===mission.private_flag||1===mission.private_flag?$(".list-mission").prepend($(id)):$(".list-team-member").prepend($(id)),missionStorage.check_hidden_unreads()}),angular.element($window).bind("resize",function(){return missionStorage.check_hidden_unreads()}),$scope.onScroll=function(){return missionStorage.check_hidden_unreads()},$scope.open_member=function(user_id){var mission,_i,_len,_ref,_results;if($rootScope.missions){for(_ref=$rootScope.missions,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)mission=_ref[_i],2===mission.private_flag&&mission.user_id===user_id?null!==mission.mission_id?_results.push($location.path("/chats/"+mission.mission_id)):_results.push(missionStorage.open_member($rootScope.cur_home.home_id,user_id,function(res){var new_mission_id;return 0===res.err_code?(new_mission_id=res.mission_id,missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed).then(function(){return $location.path("/chats/"+new_mission_id)})):logger.logError(res.err_msg)})):_results.push(void 0);return _results}}}).controller("NavHomeCtrl",function($scope,$rootScope,$session,AUTH_EVENTS,$route,homeStorage,logger,$dialogs,$location,$timeout){var app;return app=$("#app"),$scope.init=function(){return $scope.session=$session,$scope.loaded=!1,$timeout(function(){return $scope.loaded=!0})},$scope.open=function(home_id){$location.path("/home/"+home_id)},$scope.init(),$scope.$on(AUTH_EVENTS.loginSuccess,function(event,count){return $scope.init()}),$scope.$on("reload_session",function(event,count){return $scope.init()}),$scope.$on("synced-server",function(event,count){return $scope.init()}),$scope.$on("refresh-home",function(event,home){var id;return id="#"+homeStorage.home_html_id(home),$(id).html(homeStorage.home_to_html(home,!1)),$(".home-list").prepend($(id))}),$scope.$on("home-search-post",function(event){return $scope.init()}),$scope.addHome=function(){return $dialogs.addHome()},$scope.$on("added_home",function(event,home){null===$rootScope.cur_home?$location.path("/home/"+home.home_id):$rootScope.$broadcast("refresh-homes")})}).directive("chatRooms",function($rootScope,$compile,$filter,$session,$timeout,missionStorage,HPRIV){var getTemplate,linker;return getTemplate=function(scope){var mission,n,t,template,v,_i,_j,_len,_len1,_ref,_ref1;if(n=0,template="",null!==$rootScope.cur_home){if(template+="<li>",$rootScope.cur_home.priv===HPRIV.HMANAGER&&(template+='<a href="javascript:;" title="チャットルーム新規作成" ng-click="addMission()" class="right-button"><i class="icon-plus"></i></a>'),template+='    <a href="javascript:;" ng-click="toggleGroup(0)"><i class="icon-bubbles"></i><span>ルーム</span></a>',template+='    <ul class="list-mission">',$rootScope.missions)for(t=0,v=0,_ref=$rootScope.missions,_i=0,_len=_ref.length;_i<_len;_i++)mission=_ref[_i],0!==mission.private_flag&&1!==mission.private_flag||(t+=1,mission.visible&&(v+=1),template+=missionStorage.mission_to_html(mission,scope.groups));if(t>v&&(template+="    <li>",template+='        <a href="javascript:;" ng-click="toggleGroup(0)" class="more-link"><span ng-show="!groups[0]"><i class="fa fa-chevron-down"></i> すべて開く</span><span ng-show="groups[0]"><i class="fa fa-chevron-up"></i> 最新だけを表示...</span></a>',template+="    </li>"),template+="    </ul>",template+="</li>",template+="<li>",$rootScope.cur_home.priv===HPRIV.HMANAGER&&(template+='<a href="javascript:;" title="メンバーを招待" ng-click="inviteMember()" class="right-button"><i class="icon-plus"></i></a>'),template+='    <a href="javascript:;" ng-click="toggleGroup(2)"><i class="icon-people"></i><span>メンバー</span></a>',template+='    <ul class="list-team-member">',$rootScope.missions)for(t=0,v=0,_ref1=$rootScope.missions,_j=0,_len1=_ref1.length;_j<_len1;_j++)mission=_ref1[_j],2===mission.private_flag&&mission.user_id!==$session.user_id&&1===mission.accepted&&(t+=1,mission.visible&&(v+=1),template+=missionStorage.mission_to_html(mission,scope.groups));t>v&&(template+="    <li>",template+='        <a href="javascript:;" ng-click="toggleGroup(2)" class="more-link"><span ng-show="!groups[2]"><i class="fa fa-chevron-down"></i> すべて開く</span><span ng-show="groups[2]"><i class="fa fa-chevron-up"></i> 最新だけを表示...</span></a>',template+="    </li>"),template+="    </ul>",template+="</li>"}return template},linker=function(scope,element,attrs){return element.html(getTemplate(scope)),$compile(element.contents())(scope),$timeout(function(){return missionStorage.check_hidden_unreads()})},{restrict:"E",replace:!0,link:linker}}).directive("homeList",function($rootScope,$compile,$filter,$session,homeStorage){var getTemplate,linker;return getTemplate=function(scope){var home,template,_i,_len,_ref;if(template="",null!==$rootScope.homes)for(_ref=$rootScope.homes,_i=0,_len=_ref.length;_i<_len;_i++)home=_ref[_i],template+=homeStorage.home_to_html(home);return template+='<li title="グループ新規作成" ng-click="addHome()">',template+='    <span><i class="icon-plus"></i></span>',template+="</li>"},linker=function(scope,element,attrs){return element.html(getTemplate(scope)),$compile(element.contents())(scope)},{restrict:"E",replace:!0,link:linker}})}.call(this),function(){"use strict";angular.module("app.qr",[]).controller("qrHomeCtrl",function($scope,$location,$session,$rootScope,$api,$routeParams,homeStorage,$dialogs,$window,logger,$timeout){var home,home_id,invite_key;home_id=parseInt($routeParams.home_id,10),invite_key=$routeParams.invite_key,$window.isIOS()||$window.isAndroid()?$timeout(function(){return document.location.href="handcrowd://invite_home?id="+home_id+"&key="+invite_key},1e3):null===$session.user_id?($rootScope.redirect_url="/qr/home/"+home_id+"/"+invite_key,$location.path("/signin")):(home=homeStorage.get_home(home_id),null!==home?$location.path("/home/"+home_id):homeStorage.get_name(home_id,function(res){return 0!==res.err_code||$api.is_empty(res.home_name)?(logger.logError("グループが存在しません。"),$location.path("/home")):$dialogs.confirm("招待","グループ「"+res.home_name+"」に参加します。よろしいでしょうか？","確認",function(){return homeStorage.self_invite(home_id,invite_key,function(res){return 0===res.err_code?homeStorage.search().then(function(){return $location.path("/home/"+res.home_id)}):logger.logError(res.err_msg)})})}))}).controller("qrChatCtrl",function($scope,$location,$session,$rootScope,$api,$routeParams,missionStorage,homeStorage,$dialogs,$window,logger,$timeout){var invite_key,mission,mission_id;mission_id=parseInt($routeParams.mission_id,10),invite_key=$routeParams.invite_key,$window.isIOS()||$window.isAndroid()?$timeout(function(){return document.location.href="handcrowd://invite_chat?id="+mission_id+"&key="+invite_key},1e3):null===$session.user_id?($rootScope.redirect_url="/qr/chat/"+mission_id+"/"+invite_key,$location.path("/signin")):(mission=missionStorage.get_mission(mission_id),null!==mission?$location.path("/chats/"+mission_id):missionStorage.get_name(mission_id,function(res){return 0!==res.err_code||$api.is_empty(res.mission_name)?(logger.logError("チャットルームが存在しません。"),$location.path("/home")):$dialogs.confirm("招待","チャットルーム「"+res.mission_name+"」に参加します。よろしいでしょうか？","確認",function(){return missionStorage.self_invite(mission_id,invite_key,function(res){return 0===res.err_code?homeStorage.search().then(function(){return $location.path("/chats/"+res.mission_id)}):logger.logError(res.err_msg)})})}))})}.call(this),function(){"use strict";angular.module("app.search",[]).controller("searchCtrl",function($scope,searchHistoryStorage,filterFilter,$rootScope,logger,$session){return $scope.histories=searchHistoryStorage.get(),void 0===$scope.search_string&&($scope.search_string=""),void 0===$rootScope.task_search_string&&($rootScope.task_search_string=""),$scope.refreshSearch=function(search_string){return""!==search_string&&$rootScope.task_search_string===search_string&&(search_string=""),$rootScope.task_search_string=search_string,$scope.search_string=search_string,$rootScope.$broadcast("search-task")},$scope.selectSearch=function(search_string){return $scope.refreshSearch(search_string),$("body").addClass("collapsed")},$scope.saveHistory=function(search_string){var found,history;return""!==search_string&&void 0!==search_string&&(history={search_string:$scope.search_string},found=!1,$scope.histories.forEach(function(h){if(h.search_string===history.search_string)return found=!0}),found||($scope.histories.push(history),searchHistoryStorage.put($scope.histories)),$("body").addClass("collapsed")),null},$scope.canRemove=function(){return $scope.histories.length>0},$scope.removeHistory=function(){return $scope.histories=[],searchHistoryStorage.put($scope.histories)}})}.call(this),function(){"use strict";angular.module("app.sel_budget",[]).directive("selBudget",function($timeout,$session,$rootScope,HPRIV){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){return element.on("click",function(){var panel;if($rootScope.canEditTask())return panel=$("#panel-sel-budget"),panel.is(":hidden")&&$timeout(function(){return $rootScope.$broadcast("show-panel","sel-budget",element.attr("ng-model"),ngModel.$viewValue)},10),panel.toggle("slide",{direction:"down"})}),scope.$on("task-select-budget",function(event,budget){return budget?ngModel.$setViewValue(budget):ngModel.$setViewValue(null)})},$timeout(function(){return initPanel()},10)}}}).controller("selBudgetCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,$timeout,$numutil){return $scope.budget="",$scope.$on("show-panel",function(event,panel_name,model_name,budget){"sel-budget"===panel_name?($scope.budget=budget,$timeout(function(){return $("#txt_budget").focus()},0,!1)):$scope.closePanel()}),$scope.$on("select-task",function(){return $scope.closePanel()}),$scope.$on("select-mission",function(){return $scope.closePanel()}),$scope.clickOk=function(){var budget;return $scope.closePanel(),budget=$numutil.to_num($scope.budget),$rootScope.$broadcast("task-select-budget",budget)},$scope.canSubmit=function(){return $scope.form_sel_budget.$valid},$scope.closePanel=function(){$("#panel-sel-budget").hide("slide",{direction:"down"})},$scope.changeBudget=function(){var budget;return budget=$numutil.to_num($scope.budget),budget<0&&(budget=0),$timeout(function(){return $scope.budget=budget})}})}.call(this),function(){"use strict";angular.module("app.sel_date",[]).directive("selDate",function($timeout,$session,$rootScope,$parse,HPRIV){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){return element.on("click",function(){var end_date,panel,start_date,timeValue;if($rootScope.canEditTask())return panel=$("#panel-sel-date"),start_date=attrs.startDate?$parse(attrs.startDate)(scope):null,end_date=attrs.endDate?$parse(attrs.endDate)(scope):null,attrs.timeModel&&(timeValue=$parse(attrs.timeModel)(scope)),panel.is(":hidden")?($timeout(function(){return $rootScope.$broadcast("show-panel","sel-date",element.attr("ng-model"),ngModel.$modelValue,attrs.timeModel,timeValue,start_date,end_date)},10),panel.show("slide",{direction:"down"})):$rootScope.$broadcast("hide-panel","sel-date",element.attr("ng-model"),ngModel.$modelValue)}),scope.$on("set-date-to-control",function(event,model_name,date,time_model_name,time){var dt,setter;element.attr("ng-model")===model_name&&(ngModel.$setViewValue(date),element.attr("data-time-model")===time_model_name&&(setter=$parse(time_model_name).assign,null===time?setter(scope,null):(dt=moment.tz(date,$session.time_zone),setter(scope,dt.format("YYYY-MM-DD")+" "+time))),$rootScope.$broadcast("change_"+model_name))})},$timeout(function(){return initPanel()},10)}}}).controller("selDateCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,$dateutil){return $scope.init=function(model_name,date,time_model_name,time,start_date,end_date){var dt,_i,_results;return $scope.hours=function(){for(_results=[],_i=0;_i<=23;_i++)_results.push(_i);return _results}.apply(this),$scope.minutes=[0,15,30,45],$scope.model_name=model_name,$scope.curdate=date,$scope.time_model_name=time_model_name,time?($scope.timeMode=!0,dt=moment.tz(time,$session.time_zone),$scope.curtime={hour:dt.format("H"),minute:dt.format("m")}):($scope.timeMode=!1,$scope.curtime={hour:0,minute:0}),null!==start_date&&void 0!==start_date&&(start_date=start_date.substr(0,10)),null!==end_date&&void 0!==end_date&&(end_date=end_date.substr(0,10)),null!==date&&void 0!==date&&(date=date.substr(0,10)),$("#panel-sel-date .calendar").datepicker({format:"yyyy-mm-dd",language:"ja",startDate:start_date,endDate:end_date,todayHighlight:!0}).datepicker("update",date)},$scope.init("",null,"",null,null,null),$("#panel-sel-date .calendar").on("changeDate",function(){var date;return date=$(this).datepicker("getDate"),date=isNaN(date)?null:$dateutil.std_date_string(date),$scope.curdate=date}),$scope.clearDate=function(){$("#panel-sel-date .calendar").val("").datepicker("update",""),$rootScope.$broadcast("set-date-to-control",$scope.model_name,null,$scope.time_model_name,null),$scope.closePanel()},$scope.setDate=function(){var time;return time=null!==$scope.curdate&&$scope.timeMode?moment($scope.curtime.hour+":"+$scope.curtime.minute,"H:m").format("HH:mm:00"):null,$rootScope.$broadcast("set-date-to-control",$scope.model_name,$scope.curdate,$scope.time_model_name,time),$scope.closePanel()},$scope.closePanel=function(){$("#panel-sel-date").hide("slide",{direction:"down"}),$("#panel-sel-date .calendar").datepicker("remove"),$scope.model_name="",$scope.curdate=null},$scope.setTime=function(){return $scope.timeMode=!0},$scope.clearTime=function(){return $scope.timeMode=!1},$scope.$on("hide-panel",function(event,panel_name,model_name,date,time_model_name,time,start_date,end_date){return $scope.closePanel()}),$scope.$on("show-panel",function(event,panel_name,model_name,date,time_model_name,time,start_date,end_date){return"sel-date"===panel_name&&model_name!==$scope.model_name?$scope.init(model_name,date,time_model_name,time,start_date,end_date):$scope.closePanel()}),$scope.$on("select-task",function(){return $scope.closePanel()}),$scope.$on("select-mission",function(){return $scope.closePanel()})})}.call(this),function(){"use strict";angular.module("app.sel_hours",[]).directive("selHours",function($timeout,$session,$rootScope,HPRIV){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){return element.on("click",function(){var panel;if($rootScope.canEditTask())return panel=$("#panel-sel-hours"),panel.is(":hidden")&&$timeout(function(){return $rootScope.$broadcast("show-panel","sel-hours",element.attr("ng-model"),ngModel.$viewValue)},10),panel.toggle("slide",{direction:"down"})}),scope.$on("task-select-hours",function(event,hours){return hours?ngModel.$setViewValue(hours):ngModel.$setViewValue(null)})},$timeout(function(){return initPanel()},10)}}}).controller("selHoursCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,$timeout,$numutil){$scope.init=function(hours){var day,hour;return null===hours?$scope.hours={day:0,hour:0}:(day=Math.floor(hours/8),hour=$numutil.to_decimal(hours-8*day,2),$scope.hours={day:day,hour:hour})},$scope.init(null),$scope.$on("show-panel",function(event,panel_name,model_name,hours){"sel-hours"===panel_name?($scope.init(hours),$timeout(function(){return $("#txt_hours").focus()},0,!1)):$scope.closePanel()}),$scope.$on("select-task",function(){return $scope.closePanel()}),$scope.$on("select-mission",function(){return $scope.closePanel()}),$scope.clickOk=function(){var day,hours;if($scope.form_sel_hours.$valid)return day=$numutil.to_num($scope.hours.day),hours=8*day+$numutil.to_num($scope.hours.hour),$scope.closePanel(),$rootScope.$broadcast("task-select-hours",hours)},$scope.canSubmit=function(){return $scope.form_sel_hours.$valid},$scope.closePanel=function(){$("#panel-sel-hours").hide("slide",{direction:"down"})},$scope.changeDay=function(){var day;return day=$numutil.to_num($scope.hours.day),day<0&&(day=0),$timeout(function(){return $scope.hours.day=day})},$scope.changeHour=function(){var hour;return hour=$numutil.to_num($scope.hours.hour),hour>7&&(hour=7),hour<0&&(hour=0),$timeout(function(){return $scope.hours.hour=hour})}})}.call(this),function(){"use strict";angular.module("app.sel_mission",[]).directive("selMission",function($timeout,$session,$rootScope,logger){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){return element.on("click",function(){var panel;return panel=$("#panel-sel-mission"),1===scope.task.processed?(panel.hide("slide",{direction:"down"}),logger.logWarning("プロセス化されたタスクはチャットルームを選択することができません。")):(panel.is(":hidden")&&$timeout(function(){return $rootScope.$broadcast("show-panel","sel-mission",element.attr("ng-model"),ngModel.$viewValue)},10),panel.toggle("slide",{direction:"down"}))}),scope.$on("task-select-mission",function(event,mission){return mission?(ngModel.$setViewValue(mission.mission_id),scope.task.mission_name=mission.mission_name):(ngModel.$setViewValue(null),scope.task.mission_name=null)})},$timeout(function(){return initPanel()},10)}}}).controller("selMissionCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,missionStorage){return $scope.selected_mission_id="",$scope.$on("show-panel",function(event,panel_name,model_name,mission_id){"sel-mission"===panel_name?$scope.selected_mission_id=mission_id:$scope.closePanel()}),$scope.$on("select-task",function(){return $scope.closePanel()}),$scope.$on("select-mission",function(){return $scope.closePanel()}),$scope.closePanel=function(){$("#panel-sel-mission").hide("slide",{direction:"down"})},$scope.selectMission=function(mission){var mission_id;return mission_id=null===mission?null:mission.mission_id,$scope.selected_mission_id=mission_id,$scope.closePanel(),$rootScope.$broadcast("task-select-mission",mission)}})}.call(this),function(){"use strict";angular.module("app.sel_performer",[]).directive("selPerformer",function($timeout,$session,$rootScope,$parse,HPRIV){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){return element.on("click",function(){var mission_id,panel,task_id;if($rootScope.canEditTask()&&(panel=$("#panel-sel-performer"),attrs.taskId&&(task_id=$parse(attrs.taskId)(scope)),mission_id=$parse(attrs.missionId)(scope),null!==mission_id))return panel.is(":hidden")&&$timeout(function(){return $rootScope.$broadcast("show-panel","sel-performer",element.attr("ng-model"),ngModel.$viewValue,task_id)},10),panel.toggle("slide",{direction:"down"})}),scope.$on("task-select-performer",function(event,user){user?(ngModel.$setViewValue(user.user_id),$parse(attrs.performerName).assign(scope,user.user_name),$parse(attrs.avartar).assign(scope,user.avartar)):ngModel.$setViewValue(null)})},$timeout(function(){return initPanel()},10)}}}).controller("selPerformerCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,$dialogs,taskStorage){return $scope.performer_id="",$scope.users=[],$scope.level_readonly=!0,$scope.$on("show-panel",function(event,panel_name,model_name,performer_id,task_id){"sel-performer"===panel_name?($scope.performer_id=performer_id,$scope.search(task_id)):$scope.closePanel()}),$scope.$on("select-task",function(){return $scope.closePanel()}),$scope.$on("select-mission",function(){return $scope.closePanel()}),$scope.search=function(task_id){taskStorage.get_candidates(task_id,function(res){0===res.err_code?$scope.users=res.users:logger.logError(res.err_msg)})},$scope.closePanel=function(){$("#panel-sel-performer").hide("slide",{direction:"down"})},$scope.selectPerformer=function(user){var message;user.mission_member===!1?(message="チャットルーム共有されないユーザーにタスクを割り当てるようにしています。よろしいでしょうか？",$dialogs.confirm("割り当て確認",message,"はい","confirm-perform",user)):($rootScope.$broadcast("task-select-performer",user),$scope.closePanel())},$scope.$on("confirm-perform",function(event,user){$rootScope.$broadcast("task-select-performer",user),$scope.closePanel()})})}.call(this),function(){"use strict";angular.module("app.sel_skill",[]).directive("selSkill",function($timeout,$session,$rootScope,HPRIV){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){return element.on("click",function(){var can,panel;if(can=element.attr("sel-skill"),$rootScope.canEditTask()||"1"===can)return panel=$("#panel-sel-skill"),panel.is(":hidden")&&$timeout(function(){return $rootScope.$broadcast("show-panel","sel-skill",element.attr("ng-model"),ngModel.$viewValue)},10),panel.toggle("slide",{direction:"down"})}),scope.$on("task-select-skill",function(event,skills){return skills?ngModel.$setViewValue(skills):ngModel.$setViewValue(null)})},$timeout(function(){return initPanel()},10)}}}).controller("selSkillCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,taskStorage){return $scope.skills=[],$scope.all_skills=[],$scope.search_string="",$scope.$on("show-panel",function(event,panel_name,model_name,skills){"sel-skill"===panel_name?($scope.skills=skills,$scope.search()):$scope.closePanel()}),$scope.$on("select-task",function(){return $scope.closePanel()}),$scope.$on("select-mission",function(){return $scope.closePanel()}),$scope.canAddSkill=function(){var can;return can=!0,!$api.is_empty($scope.search_string)&&($scope.all_skills.forEach(function(skill){if(skill.skill_name===$scope.search_string)return can=!1}),can)},$scope.addSkill=function(){$scope.all_skills.push({selected:!0,skill_name:$scope.search_string})},$scope.clickOk=function(){var skills;return skills=[],$scope.all_skills.forEach(function(skill){if(skill.selected)return skills.push(skill.skill_name)}),$scope.closePanel(),$rootScope.$broadcast("task-select-skill",skills)},$scope.search=function(){var home_id;return home_id=null!==$rootScope.cur_home?$rootScope.cur_home.home_id:null,taskStorage.all_skills(home_id,function(res){var skills;return skills=[],$scope.all_skills=[],0===res.err_code&&(skills=res.skills),skills.forEach(function(askill){var selected;return selected=!1,$scope.skills.forEach(function(skill){if(askill===skill)return selected=!0}),$scope.all_skills.push({selected:selected,skill_name:askill})})})},$scope.closePanel=function(){$("#panel-sel-skill").hide("slide",{direction:"down"})},$scope.selectSkill=function(skill){return skill.selected=!skill.selected}})}.call(this),function(){"use strict";angular.module("app.sel_template",[]).directive("selTemplate",function($timeout,$session,$rootScope,logger){return{restrict:"A",link:function(scope,element,attrs){var initPanel;return initPanel=function(){return element.on("click",function(){var panel;if(null!==$rootScope.cur_mission)return panel=$("#panel-sel-template"),panel.is(":hidden")&&$timeout(function(){return $rootScope.$broadcast("show-panel","sel-template")},10),panel.toggle("slide",{direction:"right"})}),scope.$on("task-select-template",function(event,template){})},$timeout(function(){return initPanel()},10)}}}).controller("selTemplateCtrl",function($scope,$api,filterFilter,$rootScope,logger,$session,templateStorage,taskStorage,missionStorage,$dialogs){return $scope.selected_template_id=null,$scope.$on("show-panel",function(event,panel_name){"sel-template"!==panel_name?$scope.closePanel():templateStorage.search()}),$scope.closePanel=function(){$("#panel-sel-template").hide("slide",{direction:"right"})},$scope.selectTemplate=function(template){return $scope.selected_template_id===template.template_id?$scope.selected_template_id=null:$scope.selected_template_id=template.template_id},$scope.removeTemplate=function(template){var message;message="このテンプレートを削除してもよろしいでしょうか？",$dialogs.confirm("テンプレート削除",message,"削除","remove-template",template.template_id)},$scope.$on("remove-template",function(event,template_id){return $api.call("template/remove",{template_ids:template_id}).success(function(data,status,headers,config){return 0===data.err_code?($rootScope.$broadcast("refresh-templates"),logger.logSuccess("テンプレートが削除されました。")):logger.logError(data.err_msg)})}),$scope.canImport=function(){return null!==$scope.selected_template_id},$scope.$on("refresh-templates",function(event){return templateStorage.search()}),$scope.$on("select-mission",function(){$scope.closePanel()}),$scope.$on("import-template",function(){var params;return params={mission_id:$rootScope.cur_mission.mission_id,template_id:$scope.selected_template_id},$api.call("template/import",params).success(function(data,status,headers,config){return 0===data.err_code?($rootScope.cur_mission.summary=data.summary,$rootScope.cur_mission.job_back=data.job_back,$rootScope.cur_mission.job_back_url=data.job_back_url,$rootScope.cur_mission.job_back_pos=data.job_back_pos,$rootScope.cur_mission.prc_back=data.prc_back,$rootScope.cur_mission.prc_back_url=data.prc_back_url,$rootScope.cur_mission.prc_back_pos=data.prc_back_pos,$rootScope.$broadcast("select-mission"),$rootScope.$broadcast("refresh-tasks"),missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed),logger.logSuccess("プロセスが生成されました。")):logger.logError(data.err_msg)})}),$scope.importConfirm=function(){var count;count=taskStorage.get_taskcount($rootScope.cur_mission.mission_id),count>0?$dialogs.confirm("テンプレートから生成","選択されたテンプレートからプロセスを生成します。\n【※注意：現在のチャットルームのすべてのタスクを上書きされます。】","生成","import-template"):$scope.$broadcast("import-template")}}).controller("templateAddCtrl",function($scope,$api,filterFilter,$rootScope,logger){return $scope.initData=function(){if($scope.template={template_name:""},$scope.form_template_add)return $scope.form_template_add.$setPristine()},$scope.initData(),$scope.canSubmit=function(){return $scope.form_template_add.$valid},$scope.submitForm=function(){return $scope.template.mission_id=$rootScope.cur_mission.mission_id,$api.call("template/add",$scope.template).success(function(data,status,headers,config){return 0===data.err_code?($rootScope.$broadcast("refresh-templates"),logger.logSuccess("新しテンプレートが登録されました。")):logger.logError(data.err_msg)})}})}.call(this),function(){angular.module("app.api",[]).factory("$api",function($rootScope,$http,$session,$upload,logger,CONFIG,$location){var call_api,cancel_upload,get_base_url,import_csv,init_emoticon,init_notification,is_empty,qr_image_url,show_notification,upload_file;return call_api=function(url,data){var req;return data=data||{},"user/signin"!==url&&is_empty(data.TOKEN)&&(data.TOKEN=$session.getTOKEN()),req={method:"POST",cache:!1,url:CONFIG.API_BASE+url,headers:{"Content-Type":void 0},data:data},$http(req).error(function(data,status,headers,config){return logger.logError("エラーで読み込めませんでした。ページを更新して下さい。"),$rootScope.g_finished_ajax=!0})},upload_file=function(url,file,params){var data;return data={},void 0!==params&&(data=params),data.TOKEN=$session.getTOKEN(),$upload.upload({url:CONFIG.API_BASE+url,data:data,file:file})},cancel_upload=function(upload){upload.abort()},import_csv=function(home_id,file){return $upload.upload({url:CONFIG.API_BASE+"mission/import_csv",data:{TOKEN:$session.getTOKEN(),home_id:home_id},file:file})},is_empty=function(value){return null===value||void 0===value||""===value||0===value},get_base_url=function(){var url;return url=$location.absUrl(),url.substr(0,url.lastIndexOf("#"))},init_notification=function(){var error;try{"granted"!==Notification.permission&&Notification.requestPermission()}catch(_error){return void(error=_error)}},show_notification=function(img,title,text,path){var e,notification;try{text.length>30&&(text=text.substr(0,30),text=text.replace(/\n/g," "),text+=" ..."),notification=new Notification(title,{icon:img,body:text}),notification.onclick=function(){if(void 0!==path)return $location.path(path),window.focus()}}catch(_error){e=_error}},qr_image_url=function(url,size){return void 0===size&&(size=300),"http://chart.apis.google.com/chart?cht=qr&chs="+size+"x"+size+"&chl="+encodeURIComponent(url)+"&chld=H|0"},init_emoticon=function(icon){return icon.image=CONFIG.BASE+icon.image,icon.exp=icon.alt.replace(/\)/g,"\\)"),icon.exp=icon.exp.replace(/\(/g,"\\("),icon.exp=icon.exp.replace(/\:/g,"\\:"),icon.exp=icon.exp.replace(/\|/g,"\\|"),icon.exp=icon.exp.replace(/\*/g,"\\*"),icon.exp=icon.exp.replace(/\^/g,"\\^"),icon.exp=new RegExp(icon.exp,"g")},{call:call_api,upload_file:upload_file,cancel_upload:cancel_upload,import_csv:import_csv,is_empty:is_empty,base_url:get_base_url,init_notification:init_notification,show_notification:show_notification,qr_image_url:qr_image_url,init_emoticon:init_emoticon}}).factory("$numutil",function(logger){var to_decimal,to_num;
return to_num=function(num_str){return""!==num_str||null!==num_str||NaN===num_str?(num_str+="",num_str=num_str.replace(/[．。]+/g,"."),num_str=num_str.replace(/０/g,"0"),num_str=num_str.replace(/１/g,"1"),num_str=num_str.replace(/２/g,"2"),num_str=num_str.replace(/３/g,"3"),num_str=num_str.replace(/４/g,"4"),num_str=num_str.replace(/５/g,"5"),num_str=num_str.replace(/６/g,"6"),num_str=num_str.replace(/７/g,"7"),num_str=num_str.replace(/８/g,"8"),num_str=num_str.replace(/９/g,"9"),num_str=num_str.replace(/,/g,""),1*num_str):""},to_decimal=function(v,places){var factor;return isNaN(v)?v:(factor="1"+Array(+(places>0&&places+1)).join("0"),Math.round(v*factor)/factor)},{to_num:to_num,to_decimal:to_decimal}})}.call(this),function(){angular.module("app.auth",[]).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{all:"*",user:"user"}).service("$session",function($rootScope,$http,CONFIG,logger,$location,$timeout){var $this,SESSION;return SESSION="session",$this=this,this.session_id=null,this.user_id=null,this.planconfig=null,this.fromStorage=function(){var encoded,err,s;try{encoded=localStorage.getItem(SESSION),s=JSON.parse(sjcl.decrypt("hc2015",encoded)||{}),void 0===s.session_id&&(s.session_id=null),void 0===s.user_id&&(s.user_id=null),void 0===s.planconfig&&(s.planconfig=null)}catch(_error){err=_error,s={session_id:null}}return s},this.statesFromStorage=function(){var err;try{return JSON.parse(localStorage.getItem("states")||{})}catch(_error){return err=_error,{}}},this.statesToStorage=function(){var err;try{return localStorage.setItem("states",JSON.stringify({lastPath:$rootScope.lastPath,cur_home:$rootScope.cur_home,cur_mission:$rootScope.cur_mission}))}catch(_error){err=_error}},this.signinParamsFromStorage=function(){var err;try{return JSON.parse(localStorage.getItem("signin_params")||{})}catch(_error){return err=_error,{}}},this.signinParamsToStorage=function(params){var err;try{return localStorage.setItem("signin_params",JSON.stringify(params))}catch(_error){return err=_error,{}}},$rootScope.$on("select-mission",function(){return $this.statesToStorage()}),$rootScope.$on("refresh-task-date",function(){return $this.statesToStorage()}),$rootScope.$on("refresh-task-date",function(){return $this.statesToStorage()}),$rootScope.$on("search-task",function(){return $this.statesToStorage()}),$rootScope.$on("select-member",function(){return $this.statesToStorage()}),this.saveStates=function(path){return $rootScope.lastPath=path,$this.statesToStorage()},this.create=function(data){var encoded,err;this.session_id=data.session_id,this.user_id=data.user_id,this.user_role="user",this.user_name=data.user_name,this.email=data.email,this.avartar=data.avartar,this.language=data.language,this.time_zone=data.time_zone,this.states={},this.planconfig=data.plan,$rootScope.alerts=data.alerts,$rootScope.unreads=data.unreads,$rootScope.chat_uri=data.chat_uri,$rootScope.cache_uris=data.cache_uris,$rootScope.cache_uri=$rootScope.cache_uris[Math.floor(Math.random()*$rootScope.cache_uris.length)],this.statesToStorage(),encoded=sjcl.encrypt("hc2015",JSON.stringify({session_id:this.session_id,user_id:this.user_id}));try{return localStorage.setItem(SESSION,encoded)}catch(_error){err=_error}},this.destroy=function(){var err;this.session_id=null,this.user_id=null,this.user_role=null,this.user_name=null,this.email=null,this.avartar=null,this.language=null,this.time_zone=null,this.states=null,this.planconfig=null,$rootScope.homes=[],$rootScope.cur_home=null,$rootScope.missions=[],$rootScope.cur_mission=null,$rootScope.tasks=[],$rootScope.alerts=[],$rootScope.unreads=[];try{return localStorage.setItem(SESSION,null)}catch(_error){err=_error}},this.getTOKEN=function(){return void 0===this.user_id||void 0===this.session_id||null===this.user_id||null===this.session_id?"":this.user_id+":"+this.session_id},this}).factory("$auth",function($api,$session,$rootScope,$location,$http,AUTH_EVENTS,CONFIG,logger,missionStorage,homeStorage){var authService;return authService={},authService.autoLogin=function(session_id,authorizedRoles,event){var cur_home_id,path,session,states,token;session=$session.fromStorage(),states=$session.statesFromStorage(),null===session_id?session_id=session.session_id:session_id!==session.session_id&&(states.cur_mission=null,states.lastPath=null,states.cur_home=null),null!==session_id?(path=$location.path(),token=session.user_id+":"+session_id,cur_home_id=null!==states.cur_home?states.cur_home.home_id:null,$api.call("user/get_profile",{TOKEN:token,cur_home_id:cur_home_id}).success(function(data,status,headers,config){return 0===data.err_code?($session.create(data.user),homeStorage.set_cur_home(data.user.cur_home,!1),missionStorage.set_cur_mission(null!==states.cur_mission?states.cur_mission:null,!1),$rootScope.$broadcast("reload_session"),0===path.indexOf("/signin")?$location.path("/home"):$location.path(path)):authService.checkAuth(authorizedRoles,event)}).error(function(data,status,headers,config){return logger.logError("サーバーへ接続することができません。"),authService.checkAuth(authorizedRoles,event)})):authService.checkAuth(authorizedRoles,event)},authService.checkAuth=function(authorizedRoles,event){return authService.isAuthorized(authorizedRoles)||(null!==event&&event.preventDefault(),$location.path("signin")),authService.isAuthenticated()?$rootScope.$broadcast(AUTH_EVENTS.notAuthorized):$rootScope.$broadcast(AUTH_EVENTS.notAuthenticated)},authService.login=function(credentials){return $api.call("user/signin",credentials).then(function(res){return 0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),res.data.err_code})},authService.signup=function(user,callback){return $api.call("user/signup",user).then(function(res){if(0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),void 0!==callback)return callback(res.data)})},authService.signupGoogle=function(user,callback){return $api.call("google/register",user).then(function(res){if(0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),void 0!==callback)return callback(res.data)})},authService.signupFacebook=function(user,callback){return $api.call("facebook/register",user).then(function(res){if(0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),void 0!==callback)return callback(res.data)})},authService.activate=function(credentials){return $api.call("user/activate",credentials).then(function(res){return 0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),res.data})},authService.loginFacebook=function(token){return $api.call("facebook/signin",{token:token}).then(function(res){return 0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),res.data.err_code})},authService.loginGoogle=function(token){return $api.call("google/signin",{token:token}).then(function(res){return 0===res.data.err_code&&($session.create(res.data),homeStorage.set_cur_home(res.data.cur_home,!1),missionStorage.set_cur_mission(res.data.cur_mission,!1)),res.data.err_code})},authService.logout=function(){return $api.call("user/signout").then(function(res){return $session.destroy(),$rootScope.$broadcast("closed_session")})},authService.isAuthenticated=function(){return!!$session.user_id},authService.isAuthorized=function(authorizedRoles){return angular.isArray(authorizedRoles)||(authorizedRoles=[authorizedRoles]),authService.isAuthenticated()&&authorizedRoles.indexOf($session.user_role)!==-1},authService})}.call(this),function(){angular.module("app.cache",[]).factory("$cache",function($rootScope,$http,$session,logger,CONFIG,$location){var call_api,get_message,set_message;return call_api=function(url,data,method){var req;return data=data||{},method=method||"POST",req={method:method,url:$rootScope.cache_uri+url,headers:{"Content-Type":void 0},data:data},$http(req).error(function(data,status,headers,config){return logger.logError("エラーで読み込めませんでした。ページを更新して下さい。")})},set_message=function(cache_id,content,callback){var params,url;params={content:content},url="ms/",null!==cache_id&&(url+=cache_id),call_api(url,params).then(function(res){if(void 0!==callback)return callback(res.data)})},get_message=function(cache_id,callback){call_api("mg/"+cache_id,null,"GET").then(function(res){if(void 0!==callback)return callback(res.data)})},{set_message:set_message,get_message:get_message}})}.call(this),function(){angular.module("app.service.chat",[]).service("$chat",function($rootScope,$session,chatStorage,userStorage,$http,CONFIG,logger,$location,$timeout,$interval,AUTH_EVENTS,$websocket,$api,$cache,chatizeService){var $this;return $this=this,$this.socket=null,$this.out_queue=[],$this.out_key=0,$this.client_key=Math.floor(1e6*Math.random()+1),$this.connect=function(){var uri;null!==$session.user_id&&(uri=$rootScope.chat_uri+$session.user_id+"/"+$this.client_key,$this.socket=$websocket.$new(uri),$this.socket.$$config.enqueue=!0,$this.socket.$$config.reconnect===!1&&$this.socket.$open(),$this.socket.$on("$open",function(){return $rootScope.error_disconnected=!1,$rootScope.$apply()}),$this.socket.$on("$error",function(ev){}),$this.socket.$on("$close",function(){return $timeout($rootScope.error_disconnected=!($this.socket&&$this.socket.$ready()),$rootScope.$apply(),3e3)}),$this.socket.$on("chat_message",function(cmsg){var found_home;return found_home=!1,$cache.get_message(cmsg.cache_id,function(res){var delta_to_unreads,delta_unreads,home,mission,title,unread,_i,_j,_len,_len1,_ref,_ref1;if(cmsg.content=res.content,$session.user_id!==cmsg.user_id){if(unread=chatStorage.get_unread(cmsg),delta_unreads=0,delta_to_unreads=0,cmsg.to_flag=chatStorage.is_to_mine(cmsg),unread||(delta_unreads=1),(!unread||unread&&!unread.to_flag)&&cmsg.to_flag&&(delta_to_unreads=1),$rootScope.cur_home.home_id===cmsg.home_id&&$rootScope.missions)for(_ref=$rootScope.missions,_i=0,_len=_ref.length;_i<_len;_i++)mission=_ref[_i],mission.mission_id===cmsg.mission_id&&(mission.unreads+=delta_unreads,mission.to_unreads+=delta_to_unreads,(delta_unreads>0||delta_to_unreads>0)&&chatStorage.set_unread(cmsg),mission.visible=!0,$rootScope.$broadcast("unread-message",mission));if(delta_unreads>0&&$rootScope.homes)for(_ref1=$rootScope.homes,_j=0,_len1=_ref1.length;_j<_len1;_j++)home=_ref1[_j],home.home_id===cmsg.home_id&&(found_home=!0,home.unreads+=delta_unreads,home.to_unreads+=delta_to_unreads,chatStorage.sound_alert(),$rootScope.$broadcast("refresh-home",home))}else found_home=!0;return chatStorage.reorder_home_mission(cmsg.home_id,cmsg.mission_id),found_home||$rootScope.$broadcast("refresh-homes"),"hidden"===$rootScope.windowState&&cmsg.push_flag&&(title="",null!==cmsg.user_name&&(title=cmsg.user_name+"さん  "),title+="(ハンドクラウド",null!==cmsg.home_name&&(title+=":"+cmsg.home_name),title+=")",$api.show_notification(CONFIG.AVARTAR_URL+cmsg.user_id+".jpg",title,chatizeService.strip(cmsg.content),"/chats/"+cmsg.mission_id)),$rootScope.$broadcast("receive_message",cmsg)})}),$this.socket.$on("react_message",function(cmsg){if($rootScope.cur_mission.mission_id===cmsg.mission_id)return $rootScope.$broadcast("react_message",cmsg)}),$this.socket.$on("remove_message",function(cmsg){var found_mission;return found_mission=!1,angular.forEach($rootScope.missions,function(mission){if(mission.mission_id===cmsg.mission_id)return found_mission=!0}),found_mission||$rootScope.$broadcast("refresh-homes"),$rootScope.$broadcast("remove_message",cmsg)}),$this.socket.$on("alert",function(cmsg){return $rootScope.$broadcast("alert",cmsg),$rootScope.$apply(function(){return userStorage.alerts()})}),$this.socket.$on("task",function(msg){if(null!==$rootScope.cur_mission&&$rootScope.cur_mission.mission_id===msg.mission_id)return $rootScope.$broadcast("refresh-tasks",msg)}),$this.socket.$on("mission",function(msg){if(null!==$rootScope.cur_home&&$rootScope.cur_home.home_id===msg.home_id)return $rootScope.$broadcast("refresh-missions")}),$this.socket.$on("home",function(msg){return"refresh-logo"===msg.type?void $rootScope.$broadcast("refresh-home-logo",msg.home_id):null!==$rootScope.cur_home&&$rootScope.cur_home.home_id===msg.home_id?"remove_member"===msg.type&&msg.user_id===$session.user_id||"remove"===msg.type?(logger.logSuccess("グループから削除されました。"),$rootScope.$broadcast("removed_home")):"accept_invite"===msg.type?$rootScope.$broadcast("refresh-missions"):$rootScope.$broadcast("refresh-homes",msg):$rootScope.$broadcast("refresh-homes",msg)}),$this.socket.$on("ok",function(msg){var i,m,_i,_len,_ref,_results;for(i=0,_ref=$this.out_queue,_results=[],_i=0,_len=_ref.length;_i<_len;_i++){if(m=_ref[_i],m.key===msg.key){$this.out_queue.splice(i,1);break}_results.push(i+=1)}return _results}))},$this.disconnect=function(){if(null!==$this.socket)return $this.socket.$un("$open"),$this.socket.$un("$error"),$this.socket.$un("$close"),$this.socket.$un("chat_message"),$this.socket.$un("remove_message"),$this.socket.$close(),$this.socket=null},$this.retryConnect=function(){return $timeout(function(){return $this.connect()},3e3)},$this.onLogin=function(){return null!==$this.socket&&$this.disconnect(),$this.connect()},$this.send=function(cmsg_id,home_id,mission_id,content,to_id,is_file){if(null!==$this.socket)return $cache.set_message(null,content,function(res){var cache_id,msg;if(cache_id=res.cache_id)return msg={cmsg_id:cmsg_id,home_id:home_id,mission_id:mission_id,cache_id:cache_id,to_id:to_id,is_file:is_file,home_name:$rootScope.cur_home.home_name},$this.emit("chat_message",msg)})},$this.react=function(cmsg_id,mission_id,emoticon_id){var msg;if(null!==$this.socket)return msg={cmsg_id:cmsg_id,mission_id:mission_id,emoticon_id:emoticon_id},$this.emit("react_message",msg)},$this.remove=function(cmsg_id,mission_id){var msg;if(null!==$this.socket)return msg={cmsg_id:cmsg_id,mission_id:mission_id},$this.emit("remove_message",msg)},$this.alert=function(alert_type,user_id,info){var msg;if(null!==$this.socket)return msg={alert_type:alert_type,user_id:user_id,info:info},$this.emit("alert",msg)},$this.task=function(type,task_id,mission_id){var msg;if(null!==$this.socket)return msg={type:type,task_id:task_id,mission_id:mission_id},$this.emit("task",msg)},$this.mission=function(type,mission_id,home_id){var msg;if(null!==$this.socket)return msg={type:type,mission_id:mission_id,home_id:home_id},$this.emit("mission",msg)},$this.home=function(type,home_id,user_id){var msg;if(null!==$this.socket)return msg={type:type,home_id:home_id,user_id:user_id},$this.emit("home",msg)},$this.bot_message=function(home_id){var msg;if(null!==$this.socket)return msg={home_id:home_id},$this.emit("bot_message",msg)},$this.emit=function(evt,msg){return void 0===msg.key&&"alive"!==evt&&($this.out_key=$this.out_key+1,msg.key=$this.out_key,msg.event=evt,$this.out_queue.push(msg)),$this.socket.$emit(evt,msg),$timeout(function(){return $this.resend(msg)},2e3)},$this.resend=function(msg){var m,_i,_len,_ref,_results;for(_ref=$this.out_queue,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)m=_ref[_i],m.key===msg.key?_results.push($this.emit(m.event,m)):_results.push(void 0);return _results},$rootScope.$on("reload_session",$this.onLogin),$rootScope.$on(AUTH_EVENTS.loginSuccess,$this.onLogin),$rootScope.$on("closed_session",function(){if(null!==$this.socket)return $this.disconnect()}),$interval(function(){var msg;if($this.socket&&$this.socket.$ready())return msg={time:(new Date).getTime()},$this.emit("alive",msg)},15e3),$this})}.call(this),function(){"use strict";angular.module("app.consts",[]).constant("HPRIV",{GUEST:0,MEMBER:1,RMANAGER:2,HMANAGER:3}).constant("RPRIV",{MEMBER:0,MANAGER:1}).constant("ALERT_TYPE",{INVITE_HOME:0}).service("$consts",function($rootScope,$timeout,$session,HPRIV,RPRIV){var consts;return consts=this,consts.init=function(){return $rootScope.g_week_days=[{id:0,text:"日曜日"},{id:1,text:"月曜日"},{id:2,text:"火曜日"},{id:3,text:"水曜日"},{id:4,text:"木曜日"},{id:5,text:"金曜日"},{id:6,text:"土曜日"}],$rootScope.g_repeat_types=[{id:0,text:"なし"},{id:1,text:"毎日"},{id:2,text:"平日"},{id:3,text:"毎週"},{id:4,text:"毎月"},{id:5,text:"毎年"}],$rootScope.HPRIV=HPRIV,$rootScope.get_priv_name=function(priv){return priv===HPRIV.GUEST?"ゲスト":priv===HPRIV.MEMBER?"メンバー":priv===HPRIV.RMANAGER?"ルーム管理者":priv===HPRIV.HMANAGER?"グループ管理者":""},$rootScope.RPRIV=RPRIV,$rootScope.get_rpriv_name=function(priv){return priv===RPRIV.MEMBER?"メンバー":priv===RPRIV.MANAGER?"管理者":""},$rootScope.canEditTask=function(){return null!==$rootScope.cur_home&&($rootScope.cur_home.priv===HPRIV.HMANAGER||$rootScope.cur_home.priv===HPRIV.RMANAGER||$rootScope.cur_mission&&$rootScope.cur_mission.priv===RPRIV.MANAGER)},$rootScope.canChat=function(){return null!==$rootScope.cur_home&&($rootScope.cur_home.priv!==HPRIV.GUEST||null!==$rootScope.cur_mission&&(2===$rootScope.cur_mission.private_flag||3===$rootScope.cur_mission.private_flag))},$rootScope.canOpenPrivChat=function(){return null!==$rootScope.cur_home&&$rootScope.cur_home.priv!==HPRIV.GUEST},$rootScope.canEditMission=function(){return null!==$rootScope.cur_home&&($rootScope.cur_home.priv===HPRIV.HMANAGER||$rootScope.cur_home.priv===HPRIV.RMANAGER||$rootScope.cur_mission&&$rootScope.cur_mission.priv===RPRIV.MANAGER)},$rootScope.canEditMissionMember=function(){return null!==$rootScope.cur_home&&($rootScope.cur_home.priv===HPRIV.HMANAGER||$rootScope.cur_home.priv===HPRIV.RMANAGER||$rootScope.cur_mission&&$rootScope.cur_mission.priv===RPRIV.MANAGER)},$rootScope.canInviteChat=function(){return $rootScope.cur_home&&$rootScope.cur_mission&&(0===$rootScope.cur_mission.private_fla||1===$rootScope.cur_mission.private_flag)&&($rootScope.cur_home.priv===HPRIV.HMANAGER||$rootScope.cur_home.priv===HPRIV.RMANAGER||$rootScope.cur_mission.priv===RPRIV.MANAGER)},$rootScope.canEditHome=function(){return null!==$rootScope.cur_home&&$rootScope.cur_home.priv===HPRIV.HMANAGER},$rootScope.canBreakHome=function(){return!0},$rootScope.canEditHomeMember=function(){return null!==$rootScope.cur_home&&$rootScope.cur_home.priv===HPRIV.HMANAGER}},consts}).filter("priv_label",function($rootScope,HPRIV){return function(input){return $rootScope.get_priv_name(input)}})}.call(this),function(){angular.module("app.dateutil",[]).factory("$dateutil",function($session,numberFilter,$numutil){var check_is_past,get_date_label,get_date_time_label,get_ellipsis_time_str,get_hours_label,get_min_date_label,get_times_label,std_date_string,twoDigit;return get_date_label=function(date){var d,diff,dt,format,now,sod;return null===date||void 0===date?"":(dt=moment.tz(date,$session.time_zone),now=moment.tz($session.time_zone),sod=now.startOf("day"),diff=dt.diff(sod,"days",!0),format=diff<-6?"sameElse":diff<-1?"lastWeek":diff<0?"lastDay":diff<1?"sameDay":diff<2?"nextDay":diff<7?"nextWeek":"sameElse",format=dt.localeData().calendar(format,dt,moment(now)),format=format.replace(/\ LT$/,""),d=dt.format(format),"Invalid date"===d&&(d=""),dt.format(format))},get_min_date_label=function(date){var d,diff,dt,format,now,sod;return null===date||void 0===date?"":(dt=moment.tz(date,$session.time_zone),now=moment.tz($session.time_zone),sod=now.startOf("day"),diff=dt.diff(sod,"days",!0),format=diff<-6?"L":diff<-1?"lastWeek":diff<0?"lastDay":diff<1?"sameDay":diff<2?"nextDay":diff<7?"nextWeek":"L","L"!==format&&(format=dt.localeData().calendar(format,dt,moment(now)),format=format.replace(/\ LT$/,"")),d=dt.format(format),"Invalid date"===d&&(d=""),dt.format(format))},get_date_time_label=function(date){var diff,dt,format,lbl,now,sod;return null===date||void 0===date?"":(date+="",date=date.replace(/\ /gi,"T"),dt=moment.tz(date,$session.time_zone),now=moment.tz($session.time_zone),sod=now.startOf("day"),diff=dt.diff(sod,"days",!0),format=diff<-6?"sameElse":diff<-1?"lastWeek":diff<0?"lastDay":diff<1?"sameDay":diff<2?"nextDay":diff<7?"nextWeek":"sameElse",format=dt.localeData().calendar(format,dt,moment(now)),format=format.replace(/\ LT$/,""),format+=" LT",lbl=dt.format(format))},check_is_past=function(date){return null!==date&&void 0!==date&&moment.tz(date,$session.time_zone).isBefore(moment())},get_times_label=function(hours){var day,hour;return null===hours||void 0===hours||NaN===hours?"":(day=Math.floor(hours/8),hour=$numutil.to_decimal(hours-8*day,2),0===day?hour+"時間":0===hour?numberFilter(day)+"人日":numberFilter(day)+"人日"+hour+"時間")},get_hours_label=function(hours){return null===hours||void 0===hours||NaN===hours?"":numberFilter(hours)+"時間"},std_date_string=function(date){return date.getFullYear()+"-"+twoDigit(date.getMonth()+1)+"-"+twoDigit(date.getDate())},twoDigit=function(val){return isNaN(val)||1!==val.toString().length?val:"0"+val},get_ellipsis_time_str=function(date_time_str,compare_date_time_str){var comp_date,comp_hours,comp_minutes,comp_month,comp_time,comp_year,date,diff,hours,minutes,month,now,ret_str,sod,time,year;return ret_str=date_time_str,null===compare_date_time_str||""===compare_date_time_str?get_date_time_label(ret_str):(time=moment.tz(date_time_str,$session.time_zone),year=time.year(),month=time.month()+1,date=time.date(),hours=time.hours(),minutes=time.minutes(),comp_time=moment.tz(compare_date_time_str,$session.time_zone),comp_year=comp_time.year(),comp_month=comp_time.month()+1,comp_date=comp_time.date(),comp_hours=comp_time.hours(),comp_minutes=comp_time.minutes(),now=moment(),sod=now.startOf("day"),diff=time.diff(sod,"days",!0),year===comp_year?month===comp_month&&date===comp_date?hours===comp_hours&&minutes===comp_minutes?"":ret_str=twoDigit(hours)+":"+twoDigit(minutes):ret_str=diff>=-1&&diff<=1?get_date_time_label(ret_str):twoDigit(month)+"/"+twoDigit(date)+" "+twoDigit(hours)+":"+twoDigit(minutes):get_date_time_label(ret_str))},{date_label:get_date_label,min_date_label:get_min_date_label,date_time_label:get_date_time_label,times_label:get_times_label,hours_label:get_hours_label,is_past:check_is_past,ellipsis_time_str:get_ellipsis_time_str,std_date_string:std_date_string}})}.call(this),function(){angular.module("app.dialogs",[]).service("$dialogs",function($rootScope,logger,$modal){var $this;return $this=this,this.confirm=function(title,message,ok_label,callback,param,ok_class){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_confirm.html"+$rootScope.ver,controller:"modalConfirmCtrl",resolve:{title:function(){return title},message:function(){return message},ok_label:function(){return ok_label},ok_class:function(){return ok_class}}}),modalInstance.result.then(function(ret){var getType;return getType={},callback&&"[object Function]"===getType.toString.call(callback)?callback(param):$rootScope.$broadcast(callback,param)},function(){})},this.selPerformer=function(task){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_performer.html"+$rootScope.ver,controller:"modalPerformerCtrl",resolve:{task:function(){return task}}})},this.addMissionMember=function(mission,search_string){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/mission/mission_member_add.html"+$rootScope.ver,controller:"missionMemberAddCtrl",resolve:{mission:function(){return mission},search_string:function(){return search_string}}})},this.addTask=function(mission,task_name){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/task/task_add.html"+$rootScope.ver,controller:"modalAddTaskCtrl",resolve:{mission:function(){return mission},task_name:function(){return task_name}}})},this.showContract=function(title,content){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_contract.html"+$rootScope.ver,controller:"modalContractCtrl",resolve:{title:function(){return title},content:function(){return content}}})},this.settingBackImage=function(mission,back_type){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_back_image.html"+$rootScope.ver,controller:"modalBackImageCtrl",resolve:{mission:function(){return mission},back_type:function(){return back_type}}})},this.uploadAttach=function(type,object_id){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_upload.html"+$rootScope.ver,controller:"modalUploadCtrl",resolve:{type:function(){return type},object_id:function(){return object_id}}})},this.addHome=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/home/home_add.html"+$rootScope.ver,controller:"homeAddCtrl"})},this.inviteHome=function(home,email){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/home/home_invite.html"+$rootScope.ver,controller:"homeInviteCtrl",resolve:{home:function(){return home},email:function(){return email}}})},this.editHome=function(home){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/home/home_edit.html"+$rootScope.ver,controller:"homeEditCtrl",resolve:{home:function(){return home}}})},this.selPriv=function(priv,callback){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_sel_priv.html"+$rootScope.ver,controller:"selPrivCtrl",resolve:{priv:function(){return priv},callback:function(){return callback}}})},this.selRoomPriv=function(priv,callback){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_sel_rpriv.html"+$rootScope.ver,controller:"selRPrivCtrl",resolve:{priv:function(){return priv},callback:function(){return callback}}})},this.importCSV=function(home_id){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_import_csv.html"+$rootScope.ver,controller:"importCSVCtrl",resolve:{home_id:function(){return home_id}}})},this.addMission=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/mission/mission_add.html"+$rootScope.ver,controller:"missionAddCtrl"})},this.openMission=function(private_flag){var modalInstance;return modalInstance=2===private_flag?$modal.open({templateUrl:"views/mission/mission_open_member.html"+$rootScope.ver,controller:"missionOpenCtrl",resolve:{private_flag:function(){return private_flag}}}):$modal.open({templateUrl:"views/mission/mission_open.html"+$rootScope.ver,controller:"missionOpenCtrl",resolve:{private_flag:function(){return private_flag}}})},this.editMission=function(mission){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/mission/mission_edit.html"+$rootScope.ver,controller:"missionEditCtrl",resolve:{mission:function(){return mission}}})},this.memberMission=function(mission){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/mission/mission_member.html"+$rootScope.ver,controller:"missionMemberCtrl",resolve:{mission:function(){return mission}}})},this.reqEntrance=function(task){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_req_entr.html"+$rootScope.ver,controller:"modalReqEntrCtrl",resolve:{task:function(){return task}}})},this.helpEntrance=function(task){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_help_entr.html"+$rootScope.ver,controller:"modalHelpEntrCtrl",resolve:{task:function(){return task}}})},this.inviteMission=function(mission,email){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/mission/mission_invite.html"+$rootScope.ver,controller:"missionInviteCtrl",resolve:{mission:function(){return mission},email:function(){return email}}})},this.missionEmoticon=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/mission/mission_emoticon.html"+$rootScope.ver,controller:"missionEmoticonCtrl"})},this.chatSearch=function(search_this_room,search_string,callback){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/chatroom/chat_search.html"+$rootScope.ver,controller:"chatMessageCtrl",size:"lg",resolve:{search_this_room:function(){return search_this_room},search_string:function(){return search_string},callback:function(){return callback}}})},this.showAlerts=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_alerts.html"+$rootScope.ver,controller:"modalAlertsCtrl"})},this.previewImage=function(url,title){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_preview.html"+$rootScope.ver,controller:"modalPreviewImageCtrl",size:"lg",resolve:{url:function(){return url},title:function(){return title}}})},this.previewVideo=function(url){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_preview_video.html"+$rootScope.ver,controller:"modalPreviewVideoCtrl",size:"lg",resolve:{url:function(){return url}}})},this.showUserProfile=function(user_id){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_profile.html"+$rootScope.ver,controller:"modalProfileCtrl",resolve:{user_id:function(){return user_id}}})},this.showQR=function(url,deep_link,title){var modalInstance;return modalInstance=$modal.open({templateUrl:"views/dialogs/mdl_qr.html"+$rootScope.ver,controller:"modalShowQRCtrl",size:"lg",resolve:{url:function(){return url},deep_link:function(){return deep_link},title:function(){return title}}})},this}).controller("modalConfirmCtrl",function($scope,$rootScope,$modalInstance,title,message,ok_label,ok_class){return $scope.title=title,$scope.message=message,$scope.ok_label=ok_label,void 0===ok_class?$scope.ok_class="btn-warning":$scope.ok_class=ok_class,$scope.ok=function(){return $modalInstance.close("ok")},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}}).controller("modalPerformerCtrl",function($scope,$rootScope,$modalInstance,$api,task,taskStorage){return $scope.task=task,$scope.max_level=5,$scope.level_readonly=!0,$scope.search=function(task_id){taskStorage.get_candidates(task_id,function(res){0===res.err_code?$scope.users=res.users:logger.logError(res.err_msg)})},$scope.selectPerformer=function(user){$modalInstance.close("select"),task.performer_id=user.user_id,task.performer_name=user.user_name,task.avartar=user.avartar,taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,performer_id:user.user_id},function(res){if(0!==data.err_code)return logger.logError(data.err_msg)})},$scope.complete=function(){$modalInstance.close("complete"),task.complete_flag=!0,$rootScope.$broadcast("complete_task",task)},$scope.uncomplete=function(){$modalInstance.close("uncomplete"),task.complete_flag=!1,$rootScope.$broadcast("complete_task",task)},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.search(task.task_id)}).controller("modalAddTaskCtrl",function($scope,$rootScope,$modalInstance,$api,mission,task_name,logger,taskStorage,chatizeService){return $scope.mission=mission,$scope.posting=!1,$scope.task={mission_id:mission.mission_id,task_name:chatizeService.strip(task_name)},$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.ok=function(){""!==$scope.task.task_name&&($scope.posting=!0,taskStorage.add($scope.task,function(res){return $scope.posting=!1,0===res.err_code?($modalInstance.close("ok"),$rootScope.$broadcast("refresh-tasks"),logger.logSuccess("新しいタスクが登録されました。")):logger.logError(res.err_msg)}))}}).controller("modalReqEntrCtrl",function($scope,$rootScope,$modalInstance,$api,task,logger,$timeout,$session,$dateutil,numberFilter){var content;return content="下記のタスクの見積もり依頼します。\n（※有償プランの場合、1～2営業日以内に担当者よりご連絡します。）\nタスク名:"+task.task_name+"\n",null!==task.summary&&(content=content+"概要:\n"+task.summary+"\n"),content+="開始予定日付: ",content+=null!==task.plan_start_date?null!==task.plan_start_time?$dateutil.date_time_label(task.plan_start_time):$dateutil.date_label(task.plan_start_date):" - ",
content+="\n",content+="完了予定日付: ",content+=null!==task.plan_end_date?null!==task.plan_end_time?$dateutil.date_time_label(task.plan_end_time):$dateutil.date_label(task.plan_end_date):" - ",content+="\n",content+="工数: ",content+=null!==task.plan_hours?$dateutil.times_label(task.plan_hours):" - ",content+="\n",content+="予算: ",null!==task.plan_budget?content=content+numberFilter(task.plan_budget,0)+"円":content+=" - ",content=content+"\n\n依頼主: "+$session.user_name+"\n",$rootScope.content=content,$rootScope.req_task_id=task.task_id,$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.ok=function(){return $timeout(function(){return angular.element("#form_req_ent").trigger("submit")},5)},$scope.$on("request_entrance_ok",function(){return $modalInstance.dismiss("ok")})}).controller("frmReqEntrCtrl",function($scope,$rootScope,$api,logger,taskStorage){return $scope.req={title:"サポートチームにお見積依頼",content:$rootScope.content,task_id:$rootScope.req_task_id},$scope.submitForm=function(){$scope.form_req_ent.$valid&&(taskStorage.request_entrance($scope.req,function(res){return 0===res.err_code?logger.logSuccess("外部への依頼が完了しました。"):logger.logError(res.err_msg)}),$rootScope.$broadcast("request_entrance_ok"))}}).controller("modalHelpEntrCtrl",function($scope,$rootScope,$modalInstance,$api,task,logger,$timeout,$session){var content;return content="下記のタスクについて確認をお願いします。\nタスク名:"+task.task_name+"\n",null!==task.summary&&(content=content+"概要:\n"+task.summary),content=content+"\n\n"+$session.user_name+"("+$session.email+")\n作成者",$rootScope.content=content,$rootScope.help_task_id=task.task_id,$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.ok=function(){return $timeout(function(){return angular.element("#form_help_ent").trigger("submit")},5)},$scope.$on("help_entrance_ok",function(){return $modalInstance.dismiss("ok")})}).controller("frmHelpEntrCtrl",function($scope,$rootScope,$api,logger){return $scope.req={email:"",title:"タスクのヘルプ",content:$rootScope.content,task_id:$rootScope.help_task_id},$scope.submitForm=function(){$scope.form_help_ent.$valid&&(taskStorage.help_entrance($scope.req,function(res){return 0===res.err_code?logger.logSuccess("タスクの担当者たちへメールが届きました。"):logger.logError(res.err_msg)}),$rootScope.$broadcast("help_entrance_ok"))}}).controller("modalContractCtrl",function($scope,$rootScope,$modalInstance,title,content){return $scope.title=title,$scope.content=content,$scope.close=function(){return $modalInstance.dismiss("close")}}).controller("modalBackImageCtrl",function($scope,$rootScope,$modalInstance,$api,logger,mission,back_type,missionStorage){return $scope.back_image=0===back_type?mission.job_back_url:mission.prc_back_url,$scope.back_pos=0===back_type?mission.job_back_pos:mission.prc_back_pos,$scope.back_pos_options=[{id:0,text:"画面に合わせて伸縮"},{id:1,text:"並べて表示"},{id:2,text:"中央に表示"},{id:3,text:"そのまま表示"}],$scope.close=function(){return $modalInstance.dismiss("close")},$scope.ok=function(){missionStorage.set_back_pos(mission.mission_id,back_type,$scope.back_pos,function(res){return 0===res.err_code?(mission.job_back_pos=res.job_back_pos,mission.prc_back_pos=res.prc_back_pos,missionStorage.set_cur_mission(mission),logger.logSuccess("配置情報を更新しました。"),$rootScope.$broadcast("refresh_back_image"),$scope.close()):logger.logError(res.err_msg)})},$scope.delete=function(){missionStorage.delete_back_image(mission.mission_id,back_type,function(res){return 0===res.err_code?(mission.job_back=res.job_back,mission.job_back_url=res.job_back_url,mission.prc_back=res.prc_back,mission.prc_back_url=res.prc_back_url,missionStorage.set_cur_mission(mission),logger.logSuccess("背景画像を削除しました。"),$rootScope.$broadcast("refresh_back_image"),$scope.close()):logger.logError(res.err_msg)})}}).controller("modalUploadCtrl",function($scope,$rootScope,$modalInstance,$session,type,object_id){return $scope.type=type,$scope.object_id=object_id,$scope.TOKEN=$session.getTOKEN(),$scope.close=function(){return $modalInstance.dismiss("close"),0===type?$rootScope.$broadcast("refresh_mission_attach"):$rootScope.$broadcast("refresh-comments")}}).directive("uploadForm",function(CONFIG,logger,$api){return function(scope,element,attrs){var url;return url=0===scope.type?CONFIG.API_BASE+"mission/upload_attach":CONFIG.API_BASE+"task/upload_attach",element.dropzone({url:url,maxFilesize:500,paramName:"file",maxThumbnailFilesize:5,init:function(){return this.on("success",function(file,json){var ret;return ret=JSON.parse(json),0===ret.err_code?(0===scope.type?file.object_id=ret.mission_attach_id:file.object_id=ret.task_comment_id,logger.logSuccess("ファイルをアップロードしました。")):(logger.logError(ret.err_msg),file.object_id=null,this.removeFile(file))}),this.on("addedfile",function(file){return scope.$apply(function(){})}),this.on("drop",function(file){})},removedfile:function(file){var params,_ref;return null===file.object_id||void 0===file.object_id?(_ref=file.previewElement,void(null!==_ref&&_ref.parentNode.removeChild(file.previewElement))):(0===scope.type?(url="mission/delete_attach",params={mission_id:scope.object_id,mission_attach_id:file.object_id}):(url="task/remove_comment",params={task_comment_id:file.object_id}),$api.call(url,params).success(function(data,status,headers,config){return 0!==data.err_code?logger.logError(data.err_msg):(logger.logSuccess("ファイルを削除しました。"),_ref=file.previewElement,null!==_ref?_ref.parentNode.removeChild(file.previewElement):void 0)}))}})}}).controller("selPrivCtrl",function($scope,$rootScope,$modalInstance,$api,callback,priv){return $scope.priv=priv,$scope.ok=function(){return callback($scope.priv),$scope.cancel()},$scope.cancel=function(){return $modalInstance.dismiss("close")}}).controller("selRPrivCtrl",function($scope,$rootScope,$modalInstance,$api,callback,priv){return $scope.priv=priv,$scope.ok=function(){return callback($scope.priv),$scope.cancel()},$scope.cancel=function(){return $modalInstance.dismiss("close")}}).controller("importCSVCtrl",function($scope,$rootScope,$modalInstance,$api,$dialogs,home_id){return $scope.home_id=home_id,$scope.importCSV=function(files){var file,message;0!==files.length&&(file=files[0],message="このCSVファイルを取り込みます。よろしいでしょうか？",$dialogs.confirm("CSVインポート",message,"確認","import-csv",file),$scope.close())},$scope.close=function(){return $modalInstance.dismiss("close")}}).controller("modalAlertsCtrl",function($scope,$api,$modalInstance,filterFilter,$rootScope,logger,$session,homeStorage){$scope.posting=!1,$scope.cancel=function(){return $modalInstance.dismiss("cancel")},$scope.accept=function(alert,accept){$scope.posting=!0,homeStorage.accept_invite(alert.data.home_id,accept,function(res){var i,_i,_ref;if($scope.posting=!1,0===res.err_code)1===accept?(logger.logSuccess(alert.data.home_name+"への招待が完了しました。"),$rootScope.$broadcast("refresh-homes")):logger.logSuccess(alert.data.home_name+"への招待を取消しました。");else{if(61!==res.err_code&&63!==res.err_code)return void logger.logError(res.err_msg);logger.logError(res.err_msg)}for(i=_i=0,_ref=$rootScope.alerts.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$rootScope.alerts[i].data.home_id===alert.data.home_id&&$rootScope.alerts.splice(i,1);0===$rootScope.alerts.length&&$scope.cancel()})}}).controller("modalPreviewImageCtrl",function($scope,$rootScope,$modalInstance,$api,logger,url,title){var len;return url&&(len=url.length,"gif"===url.substring(len-3)?$scope.url=url:$scope.url=url+"/1000"),$api.is_empty(title)?$scope.title="プレビュー":$scope.title=title,$scope.close=function(){return $modalInstance.dismiss("close")}}).controller("modalPreviewVideoCtrl",function($scope,$rootScope,$modalInstance,$api,logger,url,$sce){return $scope.url=$sce.trustAsResourceUrl(url),$scope.close=function(){return $modalInstance.dismiss("close")}}).controller("modalProfileCtrl",function($scope,$rootScope,$modalInstance,$api,logger,user_id,userStorage){return $scope.user_id=user_id,userStorage.get_profile(user_id,function(res){if(0===res.err_code)return $scope.user=res.user}),$scope.close=function(){return $modalInstance.dismiss("close")}}).controller("modalShowQRCtrl",function($scope,$rootScope,$modalInstance,$api,logger,url,deep_link,title){return $scope.url=url,$scope.qr_url=$api.qr_image_url(url,300),$api.is_empty(title)?$scope.title="QRコード":$scope.title=title,$scope.close=function(){return $modalInstance.dismiss("close")}})}.call(this),function(){angular.module("app.directives",[]).directive("customBackground",function(){return{restrict:"A",controller:["$scope","$element","$location",function($scope,$element,$location){var addBg,path;return path=function(){return $location.path()},addBg=function(path){var p,_i,_len,_ref;for($element.removeClass("body-home body-special body-lock"),_ref=["/404","/pages/500","/login","/signin","/signup","/signup_facebook","/signup_google","/activate","/forgotpwd","/resetpwd","/loadapp","/qr"],_i=0,_len=_ref.length;_i<_len;_i++)p=_ref[_i],p!==path&&0!==path.indexOf(p+"/")||$element.addClass("body-special").removeClass("expanded");switch(path){case"/":return $element.addClass("body-home");case"/pages/lock-screen":return $element.addClass("body-special body-lock").removeClass("expanded")}},addBg($location.path()),$scope.$watch(path,function(newVal,oldVal){if(newVal!==oldVal)return addBg($location.path())})}]}}).directive("uiColorSwitch",[function(){return{restrict:"A",link:function(scope,ele,attrs){return ele.find(".color-option").on("click",function(event){var $this,hrefUrl,style;if($this=$(this),hrefUrl=void 0,style=$this.data("style"),"loulou"===style)hrefUrl="styles/main.css",$('link[href^="styles/main"]').attr("href",hrefUrl);else{if(!style)return!1;style="-"+style,hrefUrl="styles/main"+style+".css",$('link[href^="styles/main"]').attr("href",hrefUrl)}return event.preventDefault()})}}}]).directive("slimScroll",[function(){return{restrict:"A",link:function(scope,ele,attrs){return ele.slimScroll({height:attrs.scrollHeight||"100%"})}}}]).directive("goBack",[function(){return{restrict:"A",controller:["$scope","$element","$window",function($scope,$element,$window){return $element.on("click",function(){return $window.history.back()})}]}}]).directive("uiFileUpload",[function(){return{restrict:"A",link:function(scope,ele){return ele.bootstrapFileInput()}}}]).directive("uiSpinner",[function(){return{restrict:"A",compile:function(ele,attrs){return ele.addClass("ui-spinner"),{post:function(){return ele.spinner()}}}}}]).directive("equals",[function(){return{restrict:"A",require:"?ngModel",link:function(scope,elem,attrs,ngModel){var validate;if(ngModel)return scope.$watch(attrs.ngModel,function(){return validate()}),attrs.$observe("equals",function(val){return validate()}),validate=function(){var val1,val2;return val1=ngModel.$viewValue,val2=attrs.equals,ngModel.$setValidity("equals",!val1||!val2||val1===val2)}}}}]).filter("htmlfy",function($sce){return function(text){var html,t;return text+="",t=text.replace(/(https?:\/\/)([\d\w\.-]+)\.([\d\w\.]{2,6})([\:][\d]+)?([\(\)\/\w \?\=\&\;\#\%\.\+\@\,\!\:-]*)*\/?/g,function(url){return'<a href="'+url+'" target="_blank">'+url+"</a>"}),t=t.replace(/\n/g,"<br/>"),html=$sce.trustAsHtml(t)}}).service("chatizeService",function($rootScope,$api){return this.stripAttachString=function(str){return $api.is_empty(str)?"":str.replace(/\[file id=(\d+) url=\'([^\]]*)\'\]([^\]]*)\[\/file\]/g,function(item,id,url,name){return name})},this.stripLinkString=function(str){return $api.is_empty(str)?"":str.replace(/\[link href=\'([^\]]*)\'\]\[\/link\]/g,function(item,href){return"メッセージリンク"})},this.stripToString=function(str){return $api.is_empty(str)?"":str.replace(/\[to:([^\]]*)\]/g,function(item,user_id){return""})},this.stripQuoteString=function(str){var content,endIndex,headEndIndex,prefix,quote,startIndex,suffix;return $api.is_empty(str)?"":(startIndex=str.indexOf("[引用 "),startIndex===-1?str:(endIndex=str.lastIndexOf("[/引用]"),endIndex===-1?str:(prefix=str.substring(0,startIndex),suffix=str.substring(endIndex+5),quote=str.substring(startIndex,endIndex+5),headEndIndex=quote.indexOf("]"),content=quote.substring(headEndIndex+1,quote.length-5),str=prefix,str+=this.stripQuoteString(content),str+=suffix)))},this.strip=function(str){return $api.is_empty(str)?"":(str=this.stripQuoteString(str),str=this.stripLinkString(str),str=this.stripToString(str),str=this.stripAttachString(str),$api.is_empty(str)||(str=str.replace(/\n*/,"")),str)},this.emoticon=function(emoticon_id){var e,_i,_len,_ref;if($rootScope.emoticons&&$rootScope.emoticons.length>0)for(_ref=$rootScope.emoticons,_i=0,_len=_ref.length;_i<_len;_i++)if(e=_ref[_i],e.emoticon_id===emoticon_id)return'<i class="emoticon" style="background-image:url('+e.image+')"></i>';return""},this}).filter("chatize",function($rootScope,$api,$sce,$dateutil,CONFIG,$compile,$session){return function(text,hideThumb){var e,getFileAttachString,getLinkString,getOneQuoteString,getQuoteInfo,getQuoteString,getToString,html,i,isImage,isVideo,l,t,_i,_ref;if($api.is_empty(text))return"";if(isImage=function(filename){var ext;return ext=filename.split(".").pop(),""!==ext&&(ext=ext.toLowerCase(),"jpg"===ext||"jpeg"===ext||"png"===ext||"bmp"===ext||"gif"===ext)},isVideo=function(filename){var ext;return ext=filename.split(".").pop(),""!==ext&&(ext=ext.toLowerCase(),"mp4"===ext||"mov"===ext)},getFileAttachString=function(str){return $api.is_empty(str)?"":str.replace(/\[file id=(\d+) url=\'([^\]]*)\'\]([^\]]*)\[\/file\]/g,function(item,id,url,name){var rep_str;return rep_str="<div class='attach-name'>",hideThumb!==!0&&isImage(name)&&(rep_str+="<a href='javascript:;' class='preview-image' preview-image='"+CONFIG.BASE+url+"'><img src='"+CONFIG.BASE+url+"/150' style='max-width:150px'></a><br/>"),rep_str+="<i class='icon-paper-clip'></i>&nbsp;",rep_str+=hideThumb!==!0&&isVideo(name)?"<a href='javascript:;' class='preview-video' preview-video='"+CONFIG.BASE+url+"'>"+name+"</a>":"<a href='"+CONFIG.BASE+url+"' target='_blank'>"+name+"</a>",rep_str+="</div>"})},getLinkString=function(str){return $api.is_empty(str)?"":str.replace(/\[link href=\'([^\]]*)\'\]\[\/link\]/g,function(item,href){return href="#/chats/"+href,"<a class='btn btn-xs btn-default' href='"+href+"'><i class='icon-link'></i> メッセージリンク</a>"})},getToString=function(str){return $api.is_empty(str)?"":str.replace(/\[to:([^\]]*)\]/g,function(item,user_id){return hideThumb!==!0?"<span class='label label-info'>TO</span><img class='img-circle avartar-mini' src='"+CONFIG.AVARTAR_URL+user_id+".jpg'>":""})},getQuoteInfo=function(str){var endIndex,quoteInfo,timeAttr,timeIndex,timePart,uidAttr,uidIndex,uidPart,unameAttr,unameIndex,unamePart;return quoteInfo={uid:null,uname:null,time:null},uidAttr="id=",uidIndex=str.indexOf(uidAttr),uidIndex!==-1&&(uidIndex+=uidAttr.length,uidPart=str.substr(uidIndex),endIndex=uidPart.indexOf(" "),endIndex===-1&&(endIndex=uidPart.length-1),quoteInfo.uid=uidPart.substring(0,endIndex)),unameAttr="name=",unameIndex=str.indexOf(unameAttr),unameIndex!==-1&&(unameIndex+=unameAttr.length,unamePart=str.substr(unameIndex),endIndex=unamePart.indexOf(" "),endIndex===-1&&(endIndex=unamePart.length-1),quoteInfo.uname=unamePart.substring(0,endIndex)),timeAttr="time=",timeIndex=str.indexOf(timeAttr),timeIndex!==-1&&(timeIndex+=timeAttr.length,timePart=str.substr(timeIndex),endIndex=timePart.indexOf(" "),endIndex===-1&&(endIndex=timePart.length-1),quoteInfo.time=timePart.substring(0,endIndex)),quoteInfo},getOneQuoteString=function(str){var content,date,dateStr,dates,endIndex,hours,minutes,months,prev,quoteEnd,quoteHead,quoteHeadIndex,quoteInfo,ret,seconds,startIndex,time,uid,uname,years;return ret={index:-1,str:str},startIndex=str.indexOf("[引用 "),startIndex===-1?ret:(prev=str.substr(0,startIndex),quoteHeadIndex=str.indexOf("]",startIndex),quoteHead=str.substring(startIndex,quoteHeadIndex+1),quoteInfo=getQuoteInfo(quoteHead),uid=quoteInfo.uid,uname=quoteInfo.uname,time=quoteInfo.time,quoteEnd="[/引用 time="+time+"]",endIndex=str.indexOf(quoteEnd,quoteHeadIndex+1),endIndex===-1?ret:(content=str.substring(quoteHeadIndex+1,endIndex),endIndex+=quoteEnd.length,"<br/>"===str.substr(endIndex,5)&&(endIndex+=5),ret.index=endIndex,hideThumb!==!0?null!==uid||null!==uname?(date=new Date(1e3*time),years=date.getFullYear(),months="0"+(date.getMonth()+1),dates="0"+date.getDate(),hours="0"+date.getHours(),minutes="0"+date.getMinutes(),seconds="0"+date.getSeconds(),dateStr=years+"-"+months.substr(-2)+"-"+dates.substr(-2)+" "+hours.substr(-2)+":"+minutes.substr(-2)+":"+seconds.substr(-2),date=$dateutil.date_time_label(dateStr),str=prev,str+="<div class='chat-quote'>",str+="<img class='img-circle avartar-mini' src='"+CONFIG.AVARTAR_URL+uid+".jpg'> <i class='fa fa-fw fa-quote-left'></i>",str+="<div class='title'>"+uname+"<time>"+date+"</time></div>",str+="<div class='content'>",str+=getQuoteString(content),str+="</div><div class='clear'></div>",str+="</div>"):(str=prev,str+="<div class='chat-quote no-title'>",str+="<i class='fa fa-fw fa-quote-left'></i> <div class='content'>",str+=getQuoteString(content),str+="</div><div class='clear'></div>",str+="</div>"):str=prev,ret.str=str,ret))},getQuoteString=function(str){var inputStr,ret,retOne;for(ret="",inputStr=str,retOne=getOneQuoteString(inputStr);retOne.index!==-1;)ret+=retOne.str,inputStr=inputStr.substr(retOne.index),retOne=getOneQuoteString(inputStr);return ret+=retOne.str},text+="",text=text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&amp;&amp;&lt;\;\;/g,"<").replace(/&amp;&amp;&gt;\;\;/g,">").replace(/\n/g,"<br/>"),t=text.replace(/(https?:\/\/)([\d\w\.-]+)\.([\d\w\.]{2,6})([\:][\d]+)?([\(\)\/\w \?\=\&\;\#\%\.\+\@\,\!\:-]*)*\/?/g,function(url){return'<a href="'+url+'" target="_blank">'+url+"</a>"}),$rootScope.emoticons&&$rootScope.emoticons.length>0)for(l=$rootScope.emoticons.length,i=_i=0,_ref=l-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)e=$rootScope.emoticons[l-i-1],t=t.replace(e.exp,'<i class="emoticon" style="background-image:url('+e.image+')"></i>');return t=getFileAttachString(t),t=getLinkString(t),t=getQuoteString(t),t=getToString(t),html=$sce.trustAsHtml(t)}}).filter("noHTML",[function(){return function(text){return null===text?"":void 0===text?"":(text+="",text.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"))}}]).directive("enterSubmit",[function(){return{restrict:"A",link:function(scope,elem,attrs){return elem.bind("keydown",function(event){var code;if(code=event.keyCode||event.which,13===code&&(event.shiftKey||event.ctrlKey)&&(event.preventDefault(),scope.$apply(attrs.enterSubmit)),27===code)return scope.$apply(attrs.esc)})}}}]).directive("scrollTop",function($timeout){return{restrict:"A",link:function(scope,elem,attrs){var postedScrolledTop,scrollHeight,scrollTop;return scrollTop=0,scrollHeight=0,postedScrolledTop=!1,elem.on("scroll",function(){var curScrollHeight,curScrollTop;if(curScrollHeight=elem[0].scrollHeight-elem.outerHeight(),curScrollTop=elem.scrollTop(),curScrollHeight>0&&0===curScrollTop)return $timeout(function(){if(0===curScrollTop&&!postedScrolledTop)return scope.$apply(attrs.scrollTop),postedScrolledTop=!0,$timeout(function(){return postedScrolledTop=!1},1e3)},1e3)})}}}).directive("scrollBottom",function($timeout){return{restrict:"A",link:function(scope,elem,attrs){var postedScrolledBottom,scrollHeight,scrollTop;return scrollTop=0,scrollHeight=0,postedScrolledBottom=!1,elem.on("scroll",function(){var curScrollHeight,curScrollTop;if(curScrollHeight=elem[0].scrollHeight-elem.outerHeight(),curScrollTop=elem.scrollTop(),curScrollHeight>0&&curScrollTop>=curScrollHeight)return $timeout(function(){if(curScrollTop>=curScrollHeight&&!postedScrolledBottom)return scope.$apply(attrs.scrollBottom),postedScrolledBottom=!0,$timeout(function(){return postedScrolledBottom=!1},1e3)},1e3)})}}}).directive("scroll",function($timeout){return{restrict:"A",link:function(scope,elem,attrs){return elem.on("scroll",function(){return scope.$apply(attrs.scroll)})}}}).directive("autoFocus",["$timeout",function($timeout){return{link:function(scope,ele,attrs){return scope.$watch(attrs.autoFocus,function(newVal){if(newVal)return $timeout(function(){return ele[0].focus()},0,!1)})}}}]).filter("date_label",function($dateutil){return function(input){return $dateutil.date_label(input)}}).filter("min_date_label",function($dateutil){return function(input){return $dateutil.min_date_label(input)}}).filter("times_label",function($dateutil){return function(input){return $dateutil.times_label(input)}}).filter("hours_label",function($dateutil){return function(input){return $dateutil.hours_label(input)}}).filter("date_time_label",function($dateutil){return function(input){return $dateutil.date_time_label(input)}}).filter("home_label",function($rootScope){return function(input){return null===$rootScope.cur_home?"グループなし":input}}).filter("sir_label",function($rootScope){return function(input){return null===input||""===input||"全員"===input?input:input+"さん"}}).filter("abbr",function($rootScope){return function(input){var abbr;return abbr=input.substr(0,1),(abbr>="A"&&abbr<="Z"||abbr>="a"&&abbr<="z"||abbr>="0"&&abbr<="9")&&(abbr=input.substr(0,2)),abbr}}).filter("room_member_label",function($rootScope){return function(input){return $rootScope.get_rpriv_name(input)}})}.call(this),function(){"use strict";angular.module("app.localization",[]).factory("localize",function($http,$rootScope,$window){var localize;return localize={language:"",url:void 0,resourceFileLoaded:!1,successCallback:function(data){return localize.dictionary=data,localize.resourceFileLoaded=!0,$rootScope.$broadcast("localizeResourcesUpdated")},setLanguage:function(value){return localize.language=value.toLowerCase().split("-")[0],localize.initLocalizedResources()},setUrl:function(value){return localize.url=value,localize.initLocalizedResources()},buildUrl:function(){return localize.language||(localize.language=($window.navigator.userLanguage||$window.navigator.language).toLowerCase(),localize.language=localize.language.split("-")[0]),"i18n/resources-locale_"+localize.language+".js"},initLocalizedResources:function(){var url;return url=localize.url||localize.buildUrl(),$http({method:"GET",url:url,cache:!1}).success(localize.successCallback).error(function(){return $rootScope.$broadcast("localizeResourcesUpdated")})},getLocalizedString:function(value){var result,valueLowerCase;return result=void 0,localize.dictionary&&value?(valueLowerCase=value.toLowerCase(),result=""===localize.dictionary[valueLowerCase]?value:localize.dictionary[valueLowerCase]):result=value,result}}}).directive("i18n",function(localize){var i18nDirective;return i18nDirective={restrict:"EA",updateText:function(ele,input,placeholder){var result;return result=void 0,"i18n-placeholder"===input?(result=localize.getLocalizedString(placeholder),ele.attr("placeholder",result)):input.length>=1?(result=localize.getLocalizedString(input),ele.text(result)):void 0},link:function(scope,ele,attrs){return scope.$on("localizeResourcesUpdated",function(){return i18nDirective.updateText(ele,attrs.i18n,attrs.placeholder)}),attrs.$observe("i18n",function(value){return i18nDirective.updateText(ele,value,attrs.placeholder)})}}}).controller("LangCtrl",function($scope,localize){return $scope.lang="日本語",$scope.setLang=function(lang){switch(lang){case"English":localize.setLanguage("EN-US");break;case"日本語":localize.setLanguage("JA-JP")}return $scope.lang=lang},$scope.setLang($scope.lang),$scope.getFlag=function(){var lang;switch(lang=$scope.lang){case"English":return"flags-american";case"日本語":return"flags-japan"}}})}.call(this),function(){"use strict";angular.module("app.logger",[]).factory("logger",[function(){var logIt;return toastr.options={closeButton:!0,positionClass:"toast-bottom-right",timeOut:"3000"},logIt=function(message,type){return toastr[type](message)},{log:function(message){logIt(message,"info")},logWarning:function(message){logIt(message,"warning")},logSuccess:function(message){logIt(message,"success")},logError:function(message){logIt(message,"error")}}}])}.call(this),function(){"use strict";angular.module("app.storage",[]).service("$syncServer",function($rootScope,$timeout,AUTH_EVENTS,homeStorage,missionStorage,taskStorage,$session,$consts,$location){var init,syncServer;return syncServer=this,init=function(){$consts.init(),void 0===$rootScope.tasks&&($rootScope.tasks=[],$rootScope.priorityTasks=0,$rootScope.remainingITasks=0,$rootScope.remainingMTasks=0),void 0===$rootScope.complete_offsets&&($rootScope.complete_offsets={}),void 0===$rootScope.calendar_date&&($rootScope.calendar_date=null),$rootScope.remainingSelTasks=0,void 0===$rootScope.homes&&($rootScope.homes=[]),void 0===$rootScope.cur_home&&($rootScope.cur_home=null),$rootScope.cur_home_name=function(){return null!==$rootScope.cur_home?$rootScope.cur_home.home_name:"「グループなし」"},void 0===$rootScope.missions&&($rootScope.missions=[]),$rootScope.mission_complete_offset=0,void 0===$rootScope.cur_mission&&($rootScope.cur_mission=null),void 0===$rootScope.templates&&($rootScope.templates=[]),void 0===$rootScope.alerts&&($rootScope.alerts=[])},init(),$rootScope.$on(AUTH_EVENTS.logoutSuccess,function(){return $rootScope.tasks=[],$rootScope.priorityTasks=0,$rootScope.remainingITasks=0,$rootScope.remainingMTasks=0,$rootScope.complete_offsets={},$rootScope.calendar_date=null,$rootScope.remainingSelTasks=0,$rootScope.homes=[],$rootScope.cur_home=null,$rootScope.missions=[],$rootScope.cur_mission=null,$rootScope.mission_complete_offset=0,$rootScope.templates=[],$rootScope.alerts=[]}),syncServer.sync=function(resync){null!==$session.user_id&&void 0!==$session.user_id&&homeStorage.search().then(function(){null!==$rootScope.cur_home&&missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed).then(function(){return $rootScope.$broadcast("synced-server")})})},$rootScope.$on("refresh-homes",function(event,msg){return syncServer.sync()}),$rootScope.$on("refresh-home-logo",function(event,home_id){return homeStorage.refresh_logo(home_id)}),$rootScope.$on("refresh-missions",function(event,new_mission_id){if(null!==$rootScope.cur_home)return missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed).then(function(){if(void 0!==new_mission_id)return $timeout(function(){return $location.path("/chats/"+new_mission_id)})})}),$rootScope.$on("refresh-tasks",function(event,msg){if(null!==$rootScope.cur_mission)return taskStorage.search($rootScope.cur_mission.mission_id)}),$rootScope.$on("select-home",function(event,new_mission_id){if(null!==$rootScope.cur_home)return missionStorage.search($rootScope.cur_home.home_id,$rootScope.cur_home.include_completed)}),$rootScope.$on("removed_home",function(){return homeStorage.search().then(function(homes){return homes.length>0?$location.path("/home/"+homes[0].home_id):$rootScope.cur_home=null})}),syncServer}).directive("syncServer",function($timeout,$rootScope,$parse,$api,$session,$syncServer){return{restrict:"A",link:function(scope,element,attrs,ngModel){var init;return init=function(){return $(element).click(function(){return $syncServer.sync()})},$timeout(function(){return init()},10)}}}).factory("templateStorage",function($rootScope,$api,$session,$dateutil,filterFilter,AUTH_EVENTS){var search;return search=function(){return $api.call("template/search").then(function(res){return 0===res.data.err_code?($rootScope.templates=res.data.templates,$rootScope.templates):[]})},{search:search}}).factory("searchHistoryStorage",function(){var EMPTY,STORAGE_ID;return STORAGE_ID="search_history",EMPTY="[]",{get:function(){var err;try{return JSON.parse(localStorage.getItem(STORAGE_ID)||EMPTY)}catch(_error){return err=_error,[]}},put:function(history){return localStorage.setItem(STORAGE_ID,JSON.stringify(history))}}})}.call(this),function(){"use strict";angular.module("app.storage.chat",[]).factory("chatStorage",function($api,$session,$dateutil,$rootScope,CONFIG,$filter,chatizeService){var cache_messages,cancel_upload_file,delete_message,get_unread,is_to_mine,message_to_html,messages,messages_to_html,read_messages,refresh_unreads_title,remove_message,remove_unread,reorder_home_mission,search_messages,search_read,set_message,set_unread,sound_alert,star_message,unread_messages,upload_file;return cache_messages=function(mission_id,messages){var tmp;return void 0===$rootScope.g_messages&&($rootScope.g_messages=[]),void 0===messages?(messages=$rootScope.g_messages[mission_id],void 0===messages&&(messages=[])):(null===messages&&(messages=[]),tmp=messages.length>200?messages.splice(messages.length-200):messages.splice(),$rootScope.g_messages[mission_id]=tmp),messages},is_to_mine=function(message){var mine;return!$api.is_empty(message)&&(!$api.is_empty(message.content)&&(mine=!1,message.content+="",message.content.replace(/\[to:([^\]]*)\]/g,function(item,user_id){if($session.user_id+""===user_id||"all"===user_id)return mine=!0}),mine))},message_to_html=function(message,chat_id,uninclude_self){var avartar_cls,btn_group_cls,cls,date_label,html,message_cls,react,rtitle,sending_cls,star_cls,star_fa_cls,u,username_cls,_i,_j,_len,_len1,_ref,_ref1;if(html="",cls="",is_to_mine(message)&&(cls+=" to-mine"),message.cmsg_id===chat_id&&(cls+=" linked"),avartar_cls="",message.show_avartar||(avartar_cls+=" hide"),message_cls="",$session.user_id===message.user_id&&(message_cls+=" me"),message.show_avartar&&(message_cls+=" border-top"),message.editing&&(message_cls+=" editing"),sending_cls="",message.cmsg_id>=0&&(sending_cls+=" hide"),username_cls="",message.show_avartar||(username_cls+=" hide"),message.star?(star_cls="",star_fa_cls=" fa-star"):(star_cls=" show-hover",star_fa_cls=" fa-star-o"),date_label=message.date_label,void 0===date_label&&(date_label=""),btn_group_cls=" "+message.editing,message.cmsg_id<0&&(btn_group_cls+=" hide"),uninclude_self!==!0&&(html+='<div id="chat_'+message.cmsg_id+'" >'),html+='<div class="message-wrapper'+cls+'" data-cmsg_id="'+message.cmsg_id+'">',html+='   <img class="avartar clickable left'+avartar_cls+'" src="'+message.avartar+'" onerror="this.src = \'\';" ng-click="showUserProfile(\''+message.user_id+"')\"/>",html+='   <div class="chat-message left'+message_cls+'">',html+='       <div class="sending'+sending_cls+'"><span>メッセージ送信中 <i class="fa fa-spinner fa-spin"></i></span></div>',html+='       <div class="message-detail">',html+='           <span class="user-name'+username_cls+'" ng-click="showUserProfile('+message.user_id+')">'+message.user_name+"</span>",html+='           <span class="time">'+date_label+"</span>",html+='           <a href="javascript:;" class="star'+star_cls+'" ng-click="star('+message.cmsg_id+')" title="スター付き"><i class="fa text-warning'+star_fa_cls+'"></i></a>',html+='           <span class="unread-mark"><i class="fa fa-circle text-danger '+message.read_class+'"></i></span>',html+="       </div>",html+='       <div class="message">'+$filter("chatize")(message.content),message.reacts&&message.reacts.length>0){for(html+='       <ul class="reacts">',_ref=message.reacts,_i=0,_len=_ref.length;_i<_len;_i++){if(react=_ref[_i],rtitle="",react[2]){for(_ref1=react[2],_j=0,_len1=_ref1.length;_j<_len1;_j++)u=_ref1[_j],""!==rtitle&&(rtitle+=","),rtitle+=u[1];rtitle=' title="'+rtitle+'"'}html+='       <li ng-click="react('+message.cmsg_id+", "+react[0]+')" '+rtitle+">"+chatizeService.emoticon(react[0])+react[1]+"</li>"}html+="       </ul>"}return html+="       </div>",html+="   </div>",html+='   <ul class="button-group'+btn_group_cls+'">',html+="       <li>",html+='           <button type="button" class="btn btn-default btn-xs btn-circle btn-react" title="リアクション" ng-click="add_react('+message.cmsg_id+', $event)"><i class="icon-emotsmile"></i></button>',html+="       </li>",$rootScope.canEditTask()&&(html+="   <li>",html+='       <button type="button" class="btn btn-default btn-xs btn-circle" title="タスク新規登録" ng-click="addTask('+message.cmsg_id+')"><i class="ln-icon-check-square"></i></button>',html+="   </li>"),html+="       <li>",html+='           <button type="button" class="btn btn-default btn-xs btn-circle" title="リンク" ng-click="link('+message.cmsg_id+')"><i class="icon-link"></i></button>',
html+="       </li>",html+="       <li>",html+='           <button type="button" class="btn btn-default btn-xs btn-circle" title="引用" ng-click="quote('+message.cmsg_id+')"><i class="ln-icon-quote-open"></i></button>',html+="       </li>",$session.user_id===message.user_id&&(html+="   <li>",html+='       <button type="button" class="btn btn-default btn-xs btn-circle" title="編集" ng-click="edit('+message.cmsg_id+')"><i class="icon-pencil"></i></button>',html+="   </li>",html+="   <li>",html+='       <button type="button" class="btn btn-default btn-xs btn-circle" title="削除" ng-click="remove('+message.cmsg_id+')"><i class="icon-trash"></i></button>',html+="   </li>"),html+="       <li>",html+='           <button type="button" class="btn btn-default btn-xs btn-circle" title="未読にする" ng-click="unread('+message.cmsg_id+', $event)">未読</button>',html+="       </li>",html+="   </ul>",html+='   <div class="clear"></div>',html+="</div>",uninclude_self!==!0&&(html+="</div>"),html},messages_to_html=function(messages,chat_id){var html;return html="",messages.forEach(function(message){return html+=message_to_html(message,chat_id)}),html},messages=function(mission_id,prev_id,next_id,star){var params;return params={home_id:$rootScope.cur_home.home_id,mission_id:mission_id,prev_id:prev_id,next_id:next_id,star:star,limit:60},$api.call("chat/messages",params).then(function(res){var prev_date,user_id;return 0===res.data.err_code?(messages=res.data.messages,user_id=null,prev_date=null,messages.forEach(function(cmsg){var date_label;return cmsg.content=cmsg.content+"",cmsg.avartar=CONFIG.AVARTAR_URL+cmsg.user_id+".jpg",cmsg.read_class=cmsg.unread?"unread":"read",date_label=$dateutil.ellipsis_time_str(cmsg.date,prev_date),prev_date=cmsg.date,cmsg.date_label=date_label,cmsg.user_id!==user_id?(cmsg.show_avartar=!0,user_id=cmsg.user_id):cmsg.show_avartar=!1}),$rootScope.read_message_offset=0,refresh_unreads_title(),messages):[]})},search_messages=function(home_id,mission_id,search_string,prev_id,next_id){var params;return params={home_id:home_id,mission_id:mission_id,search_string:search_string,prev_id:prev_id,next_id:next_id},$api.call("chat/search_messages",params).then(function(res){var prev_date,user_id;return 0===res.data.err_code?(messages=res.data.messages,user_id=null,prev_date=null,mission_id=null,messages.forEach(function(cmsg){var date_label;return cmsg.avartar=CONFIG.AVARTAR_URL+cmsg.user_id+".jpg",date_label=$dateutil.ellipsis_time_str(cmsg.date,prev_date),prev_date=cmsg.date,cmsg.date_label=date_label,cmsg.mission_id!==mission_id||cmsg.user_id!==user_id?(cmsg.show_avartar=!0,user_id=cmsg.user_id,mission_id=cmsg.mission_id):cmsg.show_avartar=!1}),messages):[]})},read_messages=function(mission_id,cmsg_ids){var params;return params={mission_id:mission_id,cmsg_ids:cmsg_ids},$api.call("chat/read_messages",params).then(function(res){return res.data})},unread_messages=function(mission_id,cmsg_ids){var params;return params={mission_id:mission_id,cmsg_ids:cmsg_ids},$api.call("chat/unread_messages",params).then(function(res){return res.data})},delete_message=function(messages,cid){var i,message,_i,_ref;if(!$api.is_empty(messages))for(i=0,i=_i=_ref=messages.length-1;_i>=0;i=_i+=-1)message=messages[i],message.cmsg_id===cid&&(messages.splice(i,1),$("#chat_"+cid).remove())},set_message=function(mission_id,messages,cmsg,callback){var i,l_cmsg,prev_message,setted,_i,_ref;if(cmsg.avartar=CONFIG.AVARTAR_URL+cmsg.user_id+".jpg",cmsg.unread=$session.user_id!==cmsg.user_id,cmsg.read_class=cmsg.unread?"unread":"read",cmsg.cmsg_id<0)messages.length>0?(l_cmsg=messages[messages.length-1],l_cmsg.user_id===cmsg.user_id?cmsg.show_avartar=!1:cmsg.show_avartar=!0):cmsg.show_avartar=!0,messages.push(cmsg),callback&&callback(cmsg);else{if(setted=!1,$api.is_empty(cmsg.temp_cmsg_id)||delete_message(messages,cmsg.cmsg_id),messages.length>0)for(i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if(messages[i].cmsg_id===cmsg.temp_cmsg_id&&(messages[i].cmsg_id=cmsg.cmsg_id),messages[i].cmsg_id===cmsg.cmsg_id){cmsg.inserted=!1,messages[i]=cmsg,setted=!0,0===i?(cmsg.show_avartar=!0,cmsg.date_label=$dateutil.ellipsis_time_str(cmsg.date,null)):(prev_message=messages[i-1],prev_message.user_id!==cmsg.user_id&&(cmsg.show_avartar=!0),cmsg.date_label=$dateutil.ellipsis_time_str(cmsg.date,prev_message.date)),setted=!0,callback&&callback(cmsg);break}cmsg.inserted&&setted===!1&&(messages.length>0?(l_cmsg=messages[messages.length-1],l_cmsg.user_id===cmsg.user_id?(cmsg.show_avartar=!1,cmsg.date_label=$dateutil.ellipsis_time_str(cmsg.date,l_cmsg.date)):(cmsg.show_avartar=!0,cmsg.date_label=$dateutil.ellipsis_time_str(cmsg.date,null))):(cmsg.show_avartar=!0,cmsg.date_label=$dateutil.ellipsis_time_str(cmsg.date,null)),messages.push(cmsg),callback&&callback(cmsg))}cache_messages(mission_id,messages)},remove_message=function(messages,cmsg){var i,message,next_message,prev_message,_i,_ref;for(i=_i=0,_ref=messages.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if(message=messages[i],message.cmsg_id===cmsg.cmsg_id){i<messages.length-1&&(next_message=messages[i+1],message.show_avartar&&(next_message.show_avartar=!0),i>0?(prev_message=messages[i-1],next_message.date_label=$dateutil.ellipsis_time_str(next_message.date,prev_message.date)):next_message.date_label=$dateutil.ellipsis_time_str(next_message.date,null)),messages.splice(i,1);break}},star_message=function(cmsg_id,star){var params;return params={cmsg_id:cmsg_id,star:star},$api.call("chat/star_message",params).then(function(res){return 0===res.data.err_code&&$rootScope.$broadcast("refresh-star"),res.data})},upload_file=function(mission_id,file){return $api.upload_file("mission/upload_attach",file,{mission_id:mission_id})},cancel_upload_file=function(file){$api.cancel_upload(file.upload)},get_unread=function(cmsg){var mission_id,u,unreads,_i,_len;if(mission_id=cmsg.mission_id,unreads=$rootScope.unreads[mission_id])for(_i=0,_len=unreads.length;_i<_len;_i++)if(u=unreads[_i],u.cmsg_id===cmsg.cmsg_id)return u;return null},set_unread=function(cmsg){var mission_id,unread,unreads;unread=get_unread(cmsg),unread?unread.to_flag=cmsg.to_flag:(mission_id=cmsg.mission_id,unreads=$rootScope.unreads[mission_id],void 0===unreads&&($rootScope.unreads[mission_id]=[],unreads=$rootScope.unreads[mission_id]),unreads.push({cmsg_id:cmsg.cmsg_id,to_flag:cmsg.to_flag}))},remove_unread=function(cmsg){var i,mission_id,u,unreads,_i,_len,_results;if(mission_id=cmsg.mission_id,unreads=$rootScope.unreads[mission_id]){for(_results=[],i=_i=0,_len=unreads.length;_i<_len;i=++_i){if(u=unreads[i],u.cmsg_id===cmsg.cmsg_id){unreads.splice(i,1);break}_results.push(void 0)}return _results}},refresh_unreads_title=function(refresh_home){var home,t_to_unreads,t_unreads,title,to_unreads,unreads,_i,_len,_ref;if(void 0===refresh_home&&(refresh_home=!0),unreads=0,to_unreads=0,angular.forEach($rootScope.missions,function(mission){mission.unreads>0&&(unreads+=mission.unreads),mission.to_unreads>0&&(to_unreads+=mission.to_unreads)}),$rootScope.homes)for(t_unreads=0,t_to_unreads=0,_ref=$rootScope.homes,_i=0,_len=_ref.length;_i<_len;_i++)home=_ref[_i],$rootScope.cur_home&&home.home_id===$rootScope.cur_home.home_id&&(home.unreads=unreads,home.to_unreads=to_unreads,refresh_home&&$rootScope.$broadcast("refresh-home",home)),t_unreads+=home.unreads,t_to_unreads+=home.to_unreads;title="",t_unreads>0&&(title="["+t_unreads,t_to_unreads>0&&(title+="("+t_to_unreads+")"),title+="]"),document.title=title+"ハンドクラウド"},reorder_home_mission=function(last_home_id,last_mission_id){var home,mission,order,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3;if(void 0!==last_home_id){for(order=0,_ref=$rootScope.homes,_i=0,_len=_ref.length;_i<_len;_i++)home=_ref[_i],home.order<order&&home.home_id!==last_home_id&&(order=home.order);for(_ref1=$rootScope.homes,_j=0,_len1=_ref1.length;_j<_len1;_j++)home=_ref1[_j],home.home_id===last_home_id&&(home.order=order-1)}if(void 0!==last_mission_id){for(order=0,_ref2=$rootScope.missions,_k=0,_len2=_ref2.length;_k<_len2;_k++)mission=_ref2[_k],mission.order<order&&mission.mission_id!==last_mission_id&&(order=mission.order);for(_ref3=$rootScope.missions,_l=0,_len3=_ref3.length;_l<_len3;_l++)mission=_ref3[_l],mission.mission_id===last_mission_id&&(mission.order=order-1)}return refresh_unreads_title(!1)},sound_alert=function(){var audioElement;return audioElement=document.createElement("audio"),navigator.userAgent.match("Firefox/")?audioElement.setAttribute("src","sound/alert.ogg"):audioElement.setAttribute("src","sound/alert.mp3"),$.get(),audioElement.addEventListener("load",function(){return audioElement.play()},!0),audioElement.pause(),audioElement.play()},search_read=function(){var params;return params={},params.offset=$rootScope.read_message_offset,params.limit=10},{cache_messages:cache_messages,is_to_mine:is_to_mine,message_to_html:message_to_html,messages_to_html:messages_to_html,messages:messages,search_messages:search_messages,read_messages:read_messages,unread_messages:unread_messages,delete_message:delete_message,set_message:set_message,remove_message:remove_message,star_message:star_message,upload_file:upload_file,cancel_upload_file:cancel_upload_file,get_unread:get_unread,set_unread:set_unread,remove_unread:remove_unread,refresh_unreads_title:refresh_unreads_title,reorder_home_mission:reorder_home_mission,sound_alert:sound_alert,search_read:search_read}})}.call(this),function(){"use strict";angular.module("app.storage.home",[]).factory("homeStorage",function($rootScope,$api,$session,$dateutil,$filter,$chat,logger){var accept_invite,add,break_handcrowd,break_home,edit,get,get_home,get_name,home_html_id,home_to_html,home_unreads_to_html,invite,open,priv,refresh_logo,remove,remove_logo,remove_member,search,select_home_in_nav,self_invite,set_cur_home,set_home,upload_logo;return search=function(){return $api.call("home/search").then(function(res){var home,homes,order,_i,_len;if(0===res.data.err_code){for(homes=res.data.homes,order=0,_i=0,_len=homes.length;_i<_len;_i++)home=homes[_i],home.order=order,order+=1;return $rootScope.homes=homes,$rootScope.$broadcast("home-search-post"),$rootScope.homes}return[]})},add=function(home,callback){return $api.call("home/add",home).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("add",res.data.home.home_id)})},remove=function(home_id,callback){var params;return params={home_id:home_id},$api.call("home/remove",params).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("remove",home_id)})},break_home=function(home_id,callback){var params;return params={home_id:home_id},$api.call("home/break_home",params).then(function(res){if(void 0!==callback)return callback(res.data)})},break_handcrowd=function(callback){return $api.call("home/break_handcrowd").then(function(res){if(void 0!==callback)return callback(res.data)})},get_home=function(home_id){var home,_i,_len,_ref;if($rootScope.homes)for(_ref=$rootScope.homes,_i=0,_len=_ref.length;_i<_len;_i++)if(home=_ref[_i],home.home_id===home_id)return home;return null},set_home=function(home){var i,_i,_ref;if(null!==$rootScope.homes&&$rootScope.homes.length>0)for(i=_i=0,_ref=$rootScope.homes.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if($rootScope.homes[i].home_id===home.home_id)return void($rootScope.homes[i]!==home&&(home.order=$rootScope.homes[i].order,$rootScope.homes[i]=home));$rootScope.homes.push(home)},set_cur_home=function(home,toStorage){var new_home_id,old_home_id;void 0===toStorage&&(toStorage=!0),old_home_id=null,new_home_id=null,void 0===$rootScope.cur_home&&($rootScope.cur_home=null),null!==$rootScope.cur_home&&(old_home_id=$rootScope.cur_home.home_id),null!==home&&null!==home.home_id&&(new_home_id=home.home_id),$rootScope.cur_home=home,select_home_in_nav(),$rootScope.cur_home&&set_home($rootScope.cur_home),toStorage&&$session.statesToStorage(),old_home_id!==new_home_id&&$rootScope.$broadcast("select-home")},get_name=function(home_id,callback){var params;return params={home_id:home_id},$api.call("home/get_name",params).then(function(res){if(void 0!==callback)return callback(res.data)})},get=function(home_id,public_complete_flag,private_complete_flag,callback){var params;return params={home_id:home_id,public_complete_flag:public_complete_flag,private_complete_flag:private_complete_flag},$api.call("home/get",params).then(function(res){var i,_i,_ref;if(0===res.data.err_code&&res.data.home.members.length>0)for(i=_i=0,_ref=res.data.home.members.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)res.data.home.members[i].priv_name=$rootScope.get_priv_name(res.data.home.members[i].priv);if(void 0!==callback)return callback(res.data)})},edit=function(home,callback){return $api.call("home/edit",home).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("edit",home.home_id)})},open=function(home_id,callback){var params;return params={home_id:home_id},$api.call("home/open",params).then(function(res){if(void 0!==callback)return callback(res.data)})},priv=function(home_id,user_id,priv,callback){var params;return params={home_id:home_id,user_id:user_id,priv:priv},$api.call("home/priv",params).then(function(res){if(void 0!==callback)return callback(res.data)})},remove_member=function(home_id,user_id,callback){var params;return params={home_id:home_id,user_id:user_id},$api.call("home/remove_member",params).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("remove_member",home_id,user_id)})},invite=function(req,callback){return $api.call("home/invite",req).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("invite",req.home_id)})},self_invite=function(home_id,invite_key,callback){var req;return req={home_id:home_id,invite_key:invite_key},$api.call("home/self_invite",req).then(function(res){if(void 0!==callback)return callback(res.data)})},accept_invite=function(home_id,accept,callback){var params;return params={home_id:home_id,accept:accept},$api.call("home/accept_invite",params).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("accept_invite",home_id)})},upload_logo=function(home_id,file){return $api.upload_file("home/upload_logo",file,{home_id:home_id})},remove_logo=function(home_id,callback){var params;params={home_id:home_id},$api.call("home/remove_logo",params).then(function(res){if(void 0!==callback)return callback(res.data)})},refresh_logo=function(home_id){var params;params={home_id:home_id},$api.call("home/logo_url",params).then(function(res){var home;if(0===res.data.err_code)return home=get_home(home_id),home.logo_url=res.data.logo_url})},home_html_id=function(home){return"home_"+home.home_id},select_home_in_nav=function(){var id;$("#navHome li").removeClass("active"),$rootScope.cur_home&&(id=home_html_id($rootScope.cur_home),$("#"+id).addClass("active"))},home_unreads_to_html=function(home){var txt;return txt="",home.unreads>0&&(txt+='<i class="badge badge-danger">'+home.unreads+"</i> "),home.to_unreads>0&&(txt+='<br/><i class="badge badge-success to"><small>TO</small>'+home.to_unreads+"</i> "),txt},home_to_html=function(home,include_self){var home_id,html,item_class;return html="",void 0===include_self&&(include_self=!0),home_id=home.home_id,item_class=" ",$rootScope.cur_home&&$rootScope.cur_home.home_id===home.home_id&&(item_class+="active "),include_self&&(html+='<li id="'+home_html_id(home)+'" class="'+item_class+'" title="'+home.home_name+'" ng-click="open('+home.home_id+')">'),html+=$api.is_empty(home.logo_url)?"    <span>"+$filter("abbr")(home.home_name)+"</span>":'    <img src="'+home.logo_url+'" class="img30_30 logo">',html+='        <span class="unreads">'+home_unreads_to_html(home)+"</span>",include_self&&(html+="</li>"),html},{search:search,add:add,remove:remove,get_home:get_home,set_home:set_home,set_cur_home:set_cur_home,get_name:get_name,get:get,edit:edit,open:open,priv:priv,remove_member:remove_member,invite:invite,accept_invite:accept_invite,self_invite:self_invite,upload_logo:upload_logo,remove_logo:remove_logo,refresh_logo:refresh_logo,break_home:break_home,break_handcrowd:break_handcrowd,home_html_id:home_html_id,select_home_in_nav:select_home_in_nav,home_unreads_to_html:home_unreads_to_html,home_to_html:home_to_html}})}.call(this),function(){"use strict";angular.module("app.storage.mission",[]).factory("missionStorage",function($rootScope,$api,$session,$dateutil,$chat,CONFIG){var add,add_emoticon,attaches,break_mission,check_hidden_unreads,complete,delete_back_image,edit,get,get_bot_messages,get_mission,get_name,invitable_members,invite,mission_html_id,mission_to_html,mission_unreads_to_html,open,open_member,pin,priv,refresh_remaining,refresh_sort,remove,remove_attach,remove_emoticon,remove_member,reset_order,save_emoticon,search,search_completed,select_mission_in_nav,self_invite,set_back_pos,set_cur_mission,set_mission,set_repeat,unpinned_missions,upload_back_image,upload_emoticon;return search=function(home_id,include_completed){var params;return params={home_id:home_id,include_completed:include_completed},$api.call("mission/search",params).then(function(res){return 0===res.data.err_code?($rootScope.missions=reset_order(res.data.missions),$rootScope.missions.sort(function(a,b){return a.order-b.order}),$rootScope.mission_complete_offset=0):$rootScope.missions=[],$rootScope.$broadcast("mission-search-post"),$rootScope.missions})},reset_order=function(missions){var order;return order=0,missions.forEach(function(mission){if(mission.order=order,order+=1,mission.complete_flag=1===mission.complete_flag,3===mission.private_flag)return $rootScope.bot_mission=mission}),missions},unpinned_missions=function(home_id,private_flag,callback){var $params;return $params={home_id:home_id,private_flag:private_flag},$api.call("mission/unpinned_missions",$params).then(function(res){var missions;if(0===res.data.err_code&&(missions=res.data.missions,missions.forEach(function(mission){return mission.complete_flag=1===mission.complete_flag})),void 0!==callback)return callback(res.data)})},search_completed=function(){var params;return params={offset:$rootScope.mission_complete_offset,complete_flag:1,limit:10},$api.call("mission/search",params).then(function(res){var missions;return 0===res.data.err_code?(missions=res.data.missions,missions.forEach(function(mission){return mission.complete_flag=1===mission.complete_flag,$rootScope.missions.push(mission)}),refresh_remaining(),$rootScope.mission_complete_offset=params.offset+missions.length,$rootScope.missions):[]})},refresh_remaining=function(){var sel_mission_id;if(null!==$rootScope.cur_mission&&(sel_mission_id=$rootScope.cur_mission.mission_id),void 0!==$rootScope.missions)return $rootScope.missions.forEach(function(mission){var remaining;if(void 0!==$rootScope.tasks)return remaining=0,$rootScope.tasks.forEach(function(task){if(task.complete_flag===!1&&task.performer_id===$session.user_id&&task.mission_id===mission.mission_id)return remaining+=1}),mission.remainingTasks=remaining})},refresh_sort=function(){var sort;return sort=0,$rootScope.missions.forEach(function(mission){if(mission.complete_flag===!1)return mission.sort0=sort,mission.sort=sort,sort+=1})},get_mission=function(mission_id){var mission,_i,_len,_ref;if($rootScope.missions)for(_ref=$rootScope.missions,_i=0,_len=_ref.length;_i<_len;_i++)if(mission=_ref[_i],mission.mission_id===mission_id)return mission;return null},set_mission=function(mission){var i,_i,_ref;if(null!==$rootScope.missions&&$rootScope.missions.length>0)for(i=_i=0,_ref=$rootScope.missions.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if($rootScope.missions[i].mission_id===mission.mission_id)return void($rootScope.missions[i]!==mission&&($rootScope.missions[i]=mission,$rootScope.missions=reset_order($rootScope.missions)));return $rootScope.missions.push(mission),$rootScope.missions=reset_order($rootScope.missions),null},set_cur_mission=function(mission,toStorage){void 0===toStorage&&(toStorage=!0),$rootScope.cur_mission=mission,select_mission_in_nav(),$rootScope.cur_mission&&($rootScope.cur_mission.visible=!0,set_mission($rootScope.cur_mission)),toStorage&&$session.statesToStorage()},add=function(mission,callback){return $api.call("mission/add",mission).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.mission("add",res.data.mission_id,res.data.home_id)})},get_name=function(mission_id,callback){var params;return params={mission_id:mission_id},$api.call("mission/get_name",params).then(function(res){if(void 0!==callback)return callback(res.data)})},get=function(mission_id,callback){var params;return params={mission_id:mission_id},$api.call("mission/get",params).then(function(res){var icon,_i,_len,_ref;if(0===res.data.err_code){for(res.data.mission.complete_flag=1===res.data.mission.complete_flag,_ref=res.data.mission.emoticons,_i=0,_len=_ref.length;_i<_len;_i++)icon=_ref[_i],$api.init_emoticon(icon);$rootScope.emoticons=res.data.mission.emoticons}if(void 0!==callback)return callback(res.data)})},edit=function(mission,callback){return $api.call("mission/edit",mission).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.mission("edit",res.data.mission_id,res.data.home_id)})},open=function(mission_id,callback){var params;return params={mission_id:mission_id},$api.call("mission/open",params).then(function(res){if(void 0!==callback)return callback(res.data)})},pin=function(mission_id,pinned,callback){var params;return params={mission_id:mission_id,pinned:pinned},$api.call("mission/pin",params).then(function(res){if(void 0!==callback)return callback(res.data)})},attaches=function(mission_id,callback){var params;return params={mission_id:mission_id},$api.call("mission/attaches",params).then(function(res){if(void 0!==callback)return callback(res.data)})},remove=function(mission,callback){var params;return params={mission_id:mission.mission_id},$api.call("mission/remove",params).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.mission("remove",res.data.mission_id,res.data.home_id)})},open_member=function(home_id,user_id,callback){var params;return params={home_id:home_id,user_id:user_id},$api.call("mission/open",params).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.home("open_member",home_id)})},remove_member=function(mission_id,user_id,callback){var params;return params={mission_id:mission_id,user_id:user_id},$api.call("mission/remove_member",params).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.mission("remove_member",res.data.mission_id,res.data.home_id)})},invitable_members=function(mission_id,callback){var params;return params={mission_id:mission_id},$api.call("mission/invitable_members",params).then(function(res){if(void 0!==callback)return callback(res.data)})},invite=function(req,callback){return $api.call("mission/invite",req).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.mission("invite",res.data.mission_id,res.data.home_id)})},self_invite=function(mission_id,invite_key,callback){var req;return req={mission_id:mission_id,invite_key:invite_key},$api.call("mission/self_invite",req).then(function(res){if(void 0!==callback)return callback(res.data)})},remove_attach=function(mission_id,mission_attach_id,callback){var params;return params={mission_id:mission_id,mission_attach_id:mission_attach_id},$api.call("mission/delete_attach",params).then(function(res){if(void 0!==callback)return callback(res.data)})},complete=function(mission_id,complete_flag,callback){var params;return params={mission_ids:mission_id,complete_flag:complete_flag},$api.call("mission/complete",params).then(function(res){if(void 0!==callback)return callback(res.data)})},break_mission=function(mission_id,callback){var params;return params={mission_id:mission_id},$api.call("mission/break_mission",params).then(function(res){var i,_i,_ref;if(0===res.data.err_code&&$rootScope.missions)for(i=_i=0,_ref=$rootScope.missions.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if($rootScope.missions[i].mission_id===mission_id){$rootScope.missions.splice(i,1);break}if(void 0!==callback)return callback(res.data)})},set_repeat=function(mission_id,repeat_type,repeat_weekday,repeat_month,repeat_monthday,callback){var params;(void 0===repeat_weekday||repeat_weekday<0||repeat_weekday>6)&&(repeat_weekday=1),(void 0===repeat_month||repeat_month<1||repeat_month>12)&&(repeat_month=1),(void 0===repeat_monthday||repeat_monthday<1||repeat_monthday>31)&&(repeat_monthday=1),params={mission_id:mission_id,repeat_type:repeat_type,repeat_weekday:repeat_weekday,repeat_month:repeat_month,repeat_monthday:repeat_monthday},$api.call("mission/set_repeat",params).then(function(res){if(void 0!==callback)return callback(res.data)})},set_back_pos=function(mission_id,type,back_pos,callback){var params;params={mission_id:mission_id,type:type,back_pos:back_pos},$api.call("mission/set_back_pos",params).then(function(res){if(void 0!==callback)return callback(res.data)})},upload_back_image=function(mission_id,type,file){return $api.upload_file("mission/upload_back_image",file,{mission_id:mission_id,type:type})},delete_back_image=function(mission_id,type,callback){var params;params={mission_id:mission_id,type:type},$api.call("mission/delete_back_image",params).then(function(res){if(void 0!==callback)return callback(res.data)})},get_bot_messages=function(home_id){$chat.bot_message(home_id)},mission_html_id=function(mission){return 0===mission.private_flag||1===mission.private_flag?"mission_"+mission.mission_id:2===mission.private_flag?"mission2_"+mission.user_id:void 0},select_mission_in_nav=function(){var id;$rootScope.nav_id&&($(".nav-bar>li").removeClass("active"),$(".nav-bar .list-item").removeClass("active"),0===$rootScope.nav_id.indexOf("chatroom_")?$rootScope.cur_mission&&(id=mission_html_id($rootScope.cur_mission),$("#"+id).addClass("active").removeClass("hide")):"home"===$rootScope.nav_id?$(".nav-bar .nav-home").addClass("active"):"settings"===$rootScope.nav_id&&$(".nav-bar .my-avartar").addClass("active"))},mission_unreads_to_html=function(mission){var txt;return txt="",mission.unreads>0&&(txt+='<i class="badge badge-danger">'+mission.unreads+"</i> "),mission.to_unreads>0&&(txt+='<i class="badge badge-success"><small>TO</small>'+mission.to_unreads+"</i> "),txt},mission_to_html=function(mission,groups,include_self){var html,item_class,mission_id,pin_class,private_show;return html="",void 0===include_self&&(include_self=!0),mission_id=mission.mission_id,0===mission.private_flag||1===mission.private_flag?(item_class=" ",$rootScope.nav_id==="chatroom_"+mission.mission_id&&(item_class+="active "),groups[0]||mission.visible||(item_class+="hide"),pin_class=" ",1!==mission.pinned&&(pin_class=" btn-pin"),private_show=" hide",1===mission.private_flag&&(private_show=""),include_self&&(html+='<li id="'+mission_html_id(mission)+'" class="list-item '+item_class+'" data-mission-id="'+mission.mission_id+'">'),html+='    <div class="info">',html+='        <span class="unreads">'+mission_unreads_to_html(mission)+"</span>",html+='        <a href="javascript:;" class="pin '+pin_class+'" ng-click="pinMission('+mission_id+')"><i class="icon-pin"></i></a>',html+="    </div>",html+='    <a ng-href="#/chats/'+mission.mission_id+'" title="'+mission.mission_name+'"><i class="fa fa-lock'+private_show+'"></i> '+mission.mission_name+"</a>",include_self&&(html+="</li>")):2===mission.private_flag&&(item_class=" ",$rootScope.nav_id==="chatroom_"+mission.mission_id&&(item_class+="active "),groups[2]||mission.visible||(item_class+="hide"),pin_class=" ",1!==mission.pinned&&(pin_class=" btn-pin"),include_self&&(html+='<li id="'+mission_html_id(mission)+'" class="list-item '+item_class+'" data-mission-id="'+mission.mission_id+'">'),html+='    <img alt="" ng-src="'+mission.avartar+'" class="avartar">',html+='    <div class="info">',html+='        <span class="unreads">'+mission_unreads_to_html(mission)+"</span>",html+='        <a href="javascript:;" class="pin '+pin_class+'" ng-click="pinMission('+mission_id+')"><i class="icon-pin"></i></a>',html+="    </div>",html+='    <a href="javascript:;" ng-click="open_member('+mission.user_id+')" title="'+mission.mission_name+'">'+mission.mission_name+"</a>",include_self&&(html+="</li>")),html},check_hidden_unreads=function(){var avartar,el,hidden,id,logout,mission,offset,parentRect,_i,_len,_ref;if(hidden=!1,parentRect=angular.element("#nav")[0].getBoundingClientRect(),avartar=$(".nav-bar .my-avartar").height(),logout=$(".nav-bar .logout").height(),$rootScope.missions)for(_ref=$rootScope.missions,_i=0,_len=_ref.length;_i<_len;_i++)if(mission=_ref[_i],mission.unreads>0&&(id=mission_html_id(mission),el=angular.element("#"+id)[0],el&&(offset=el.getBoundingClientRect(),offset&&offset.top>parentRect.bottom-avartar-logout))){hidden=!0;break}return hidden?$(".unread_hint").show():$(".unread_hint").hide()},priv=function(mission_id,user_id,priv,callback){var params;return params={mission_id:mission_id,user_id:user_id,priv:priv},$api.call("mission/priv",params).then(function(res){if(void 0!==callback)return callback(res.data)})},upload_emoticon=function(mission_id,file){return $api.upload_file("mission/upload_emoticon",file,{mission_id:mission_id})},add_emoticon=function(emoticon,callback){return $api.call("mission/add_emoticon",emoticon).then(function(res){if(void 0!==callback)return callback(res.data)})},save_emoticon=function(emoticon,callback){return $api.call("mission/save_emoticon",emoticon).then(function(res){if(void 0!==callback)return callback(res.data)})},remove_emoticon=function(emoticon_id,callback){var params;return params={emoticon_id:emoticon_id},$api.call("mission/remove_emoticon",params).then(function(res){if(void 0!==callback)return callback(res.data)})},{search:search,unpinned_missions:unpinned_missions,search_completed:search_completed,refresh_remaining:refresh_remaining,get_mission:get_mission,set_mission:set_mission,set_cur_mission:set_cur_mission,add:add,get_name:get_name,get:get,edit:edit,open:open,pin:pin,attaches:attaches,remove:remove,open_member:open_member,remove_member:remove_member,invitable_members:invitable_members,invite:invite,self_invite:self_invite,remove_attach:remove_attach,complete:complete,break_mission:break_mission,set_repeat:set_repeat,set_back_pos:set_back_pos,upload_back_image:upload_back_image,delete_back_image:delete_back_image,get_bot_messages:get_bot_messages,select_mission_in_nav:select_mission_in_nav,mission_html_id:mission_html_id,mission_unreads_to_html:mission_unreads_to_html,mission_to_html:mission_to_html,check_hidden_unreads:check_hidden_unreads,priv:priv,upload_emoticon:upload_emoticon,add_emoticon:add_emoticon,save_emoticon:save_emoticon,remove_emoticon:remove_emoticon}})}.call(this),function(){"use strict";angular.module("app.storage.task",[]).factory("taskStorage",function($rootScope,$api,$session,$dateutil,filterFilter,missionStorage,AUTH_EVENTS,$chat){var add,add_comment,add_proclink,all_skills,edit,get_candidates,get_comments,get_completed_offset,get_proclinks,get_skills,get_task,get_taskcount,help_entrance,isEqual,isEqualLink,isEqualLinks,isEqualTasks,push_tasks,refresh_remaining,refresh_sort,remove,remove_comment,remove_proclink,request_entrance,search,search_completed,set_completed_offset,set_skills;return search=function(mission_id,priority_only){var params;return params=null,void 0!==mission_id?params={mission_id:mission_id,search_mode:1}:void 0!==priority_only?(params={priority_only:1},null!==$rootScope.cur_home&&(params.home_id=$rootScope.cur_home.home_id)):null!==$rootScope.calendar_date&&(params={search_date:$rootScope.calendar_date,search_mode:1
}),$api.call("task/search",params).then(function(res){var tasks;return 0===res.data.err_code?(tasks=res.data.tasks,tasks.forEach(function(task){return task.priority=1===task.priority,task.complete_flag=1===task.complete_flag,task.checked=!1}),null===params&&($rootScope.complete_offsets={}),void 0!==mission_id?$rootScope.tasks=tasks:($rootScope.tasks=tasks,refresh_remaining(),refresh_sort())):$rootScope.tasks=[],$rootScope.$broadcast("refreshed-tasks"),$rootScope.tasks})},get_proclinks=function(mission_id,callback){$api.call("task/get_proclinks",{mission_id:mission_id}).then(function(res){if(void 0!==callback)return callback(res.data)})},get_completed_offset=function(mission_id){var offset;return offset=$rootScope.complete_offsets[mission_id],void 0===offset&&(offset=0),offset},set_completed_offset=function(mission_id,offset){return $rootScope.complete_offsets[mission_id]=offset},search_completed=function(mission_id,priority_only){var offset_key,params;if(params={},null===$rootScope.calendar_date)return void 0!==mission_id?(params={mission_id:mission_id,search_mode:2},offset_key=mission_id):void 0!==priority_only&&(params={priority_only:1},null!==$rootScope.cur_home&&(params.home_id=$rootScope.cur_home.home_id),offset_key="home_"+params.home_id),params.offset=get_completed_offset(offset_key),params.search_mode=2,params.limit=10,$api.call("task/search",params).then(function(res){var tasks;return 0===res.data.err_code?(tasks=res.data.tasks,tasks.forEach(function(task){return task.priority=1===task.priority,task.complete_flag=1===task.complete_flag,task.checked=!1}),set_completed_offset(offset_key,params.offset+tasks.length),push_tasks(tasks),tasks):[]})},push_tasks=function(tasks){var found,t,task,_i,_j,_len,_len1,_ref;for(_i=0,_len=tasks.length;_i<_len;_i++){for(task=tasks[_i],found=!1,_ref=$rootScope.tasks,_j=0,_len1=_ref.length;_j<_len1;_j++)if(t=_ref[_j],t.task_id===task.task_id){found=!0;break}found||$rootScope.tasks.push(task)}},refresh_sort=function(){var sort;return sort=0,$rootScope.tasks.forEach(function(task){if(task.complete_flag===!1&&0===task.processed)return task.sort0=sort,task.sort=sort,sort+=1})},refresh_remaining=function(){var remainingSel;return $rootScope.priorityTasks=0,$rootScope.remainingITasks=0,$rootScope.remainingMTasks=0,remainingSel=0,$rootScope.tasks.forEach(function(task){if(task.complete_flag===!1&&task.performer_id===$session.user_id&&(task.priority===!0&&($rootScope.priorityTasks+=1),null===task.mission_id?$rootScope.remainingITasks+=1:$rootScope.remainingMTasks+=1,null!==$rootScope.cur_mission&&task.mission_id===$rootScope.cur_mission.mission_id))return remainingSel+=1}),null!==$rootScope.cur_mission?$rootScope.remainingSelTasks=remainingSel:$rootScope.remainingSelTasks=0,missionStorage.refresh_remaining()},get_task=function(task_id){var task,_i,_len,_ref;for(_ref=$rootScope.tasks,_i=0,_len=_ref.length;_i<_len;_i++)if(task=_ref[_i],task.task_id===task_id)return task;return null},get_taskcount=function(mission_id){var count,task,_i,_len,_ref;for(count=0,_ref=$rootScope.tasks,_i=0,_len=_ref.length;_i<_len;_i++)task=_ref[_i],task.mission_id===mission_id&&(count+=1);return count},isEqualTasks=function(tasks1,tasks2){var i,_i,_ref;if($api.is_empty(tasks1)&&$api.is_empty(tasks2))return!0;if($api.is_empty(tasks1)||$api.is_empty(tasks2))return!1;if(tasks1.length!==tasks2.length)return!1;for(i=_i=0,_ref=tasks1.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if(!isEqual(tasks1[i],tasks2[i]))return!1;return!0},isEqual=function(task1,task2){return!(!$api.is_empty(task1)||!$api.is_empty(task2))||task1.task_id===task2.task_id&&(task1.task_name===task2.task_name&&(task1.progress===task2.progress&&(task1.avartar===task2.avartar&&(task1.complete_flag===task2.complete_flag&&(task1.complete_time===task2.complete_time&&(task1.plan_end_date===task2.plan_end_date&&(task1.plan_hours===task2.plan_hours&&(task1.x===task2.x&&task1.y===task2.y))))))))},isEqualLinks=function(links1,links2){var i,_i,_ref;if($api.is_empty(links1)&&$api.is_empty(links2))return!0;if($api.is_empty(links1)||$api.is_empty(links2))return!1;if(links1.length!==links2.length)return!1;for(i=_i=0,_ref=links1.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)if(!isEqualLink(links1[i],links2[i]))return!1;return!0},isEqualLink=function(link1,link2){return!(!$api.is_empty(link1)||!$api.is_empty(link2))||link1.from_task_id===link2.from_task_id&&link1.to_task_id===link2.to_task_id},add=function(task,callback){$api.call("task/add",task).then(function(res){void 0!==callback&&(callback(res.data),0===res.data.err_code&&$chat.task("add",res.data.task_id,res.data.mission_id))})},edit=function(task,callback){$api.call("task/edit",task).then(function(res){void 0!==callback&&(callback(res.data),0===res.data.err_code&&$chat.task("edit",res.data.task_id,res.data.mission_id))})},remove=function(task,callback){$api.call("task/remove",{task_id:task.task_id}).then(function(res){if(void 0!==callback&&(callback(res.data),0===res.data.err_code))return $chat.task("remove",res.data.task_id,res.data.mission_id)})},get_skills=function(task_id,callback){return $api.call("task/get_skills",{task_id:task_id}).then(function(res){void 0!==callback&&callback(res.data)})},all_skills=function(home_id,callback){$api.call("task/all_skills",{home_id:home_id}).then(function(res){void 0!==callback&&callback(res.data)})},set_skills=function(task_id,skills,callback){return $api.call("task/set_skills",{task_id:task_id,skills:skills}).then(function(res){void 0!==callback&&callback(res.data)})},get_comments=function(task_id,callback){$api.call("task/get_comments",{task_id:task_id}).then(function(res){void 0!==callback&&callback(res.data)})},add_comment=function(task_id,comment,callback){var params;params={task_id:task_id,comment_type:0,content:comment},$api.call("task/add_comment",params).then(function(res){void 0!==callback&&callback(res.data)})},remove_comment=function(task_comment_id,callback){var params;params={task_comment_id:task_comment_id},$api.call("task/remove_comment",params).then(function(res){void 0!==callback&&callback(res.data)})},get_candidates=function(task_id,callback){var params;params={task_id:task_id},$api.call("task/get_candidates",params).then(function(res){void 0!==callback&&callback(res.data)})},request_entrance=function(req,callback){$api.call("task/request_entrance",req).then(function(res){void 0!==callback&&callback(res.data)})},help_entrance=function(req,callback){$api.call("task/help_entrance",req).then(function(res){void 0!==callback&&callback(res.data)})},add_proclink=function(mission_id,from_task_id,to_task_id,callback){$api.call("task/add_proclink",{mission_id:mission_id,from_task_id:from_task_id,to_task_id:to_task_id}).then(function(res){void 0!==callback&&callback(res.data)})},remove_proclink=function(from_task_id,to_task_id,callback){$api.call("task/remove_proclink",{from_task_id:from_task_id,to_task_id:to_task_id}).then(function(res){void 0!==callback&&callback(res.data)})},{search:search,search_completed:search_completed,get_proclinks:get_proclinks,refresh_remaining:refresh_remaining,get_task:get_task,get_taskcount:get_taskcount,isEqualTasks:isEqualTasks,isEqual:isEqual,isEqualLinks:isEqualLinks,isEqualLink:isEqualLink,add:add,edit:edit,remove:remove,get_skills:get_skills,all_skills:all_skills,set_skills:set_skills,get_comments:get_comments,add_comment:add_comment,remove_comment:remove_comment,get_candidates:get_candidates,request_entrance:request_entrance,help_entrance:help_entrance,add_proclink:add_proclink,remove_proclink:remove_proclink,set_completed_offset:set_completed_offset}})}.call(this),function(){angular.module("app.storage.user",[]).factory("userStorage",function($rootScope,$api,$session){var alerts,get_profile,resend_activate_mail,unreads,update_profile,upload_avartar;return resend_activate_mail=function(user,callback){$api.call("user/resend_activate_mail",user).then(function(res){if(void 0!==callback)return callback(res.data)})},get_profile=function(user_id,callback){var params;params=null!==user_id?{user_id:user_id}:null,$api.call("user/get_profile",params).then(function(res){if(void 0!==callback)return callback(res.data)})},update_profile=function(user,callback){$api.call("user/update_profile",user).then(function(res){if(void 0!==callback)return callback(res.data)})},alerts=function(callback){$api.call("user/alerts").then(function(res){if(0===res.data.err_code&&($rootScope.alerts=res.data.alerts),void 0!==callback)return callback(res.data)})},unreads=function(callback){$api.call("user/unreads").then(function(res){if(0===res.data.err_code&&($rootScope.unreads=res.data.unreads),void 0!==callback)return callback(res.data)})},upload_avartar=function(file){return $api.upload_file("user/upload_avartar",file)},{resend_activate_mail:resend_activate_mail,get_profile:get_profile,update_profile:update_profile,alerts:alerts,unreads:unreads,upload_avartar:upload_avartar}})}.call(this),function(){"use strict";var checkLineIntersection,checkLineRectIntersection,drawConnect,drawLine,getArrowPos,getContext,isOnLine,last_process;last_process={x:10,y:10,z:1},angular.module("app.task.process",[]).directive("taskDraggable",function($timeout,$rootScope,$parse,$api,taskStorage,HPRIV){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){if($rootScope.canEditTask())return $(element).draggable({drag:function(event,ui){var $this,difx,dify;return $this=$(this),difx=parseInt($this.css("left"))-$this.data("start-left"),dify=parseInt($this.css("top"))-$this.data("start-top"),$(".task-item.selected").each(function(){if($(this).data("taskId")!==$this.data("taskId"))return $(this).css("left",$(this).data("start-left")+difx+"px"),$(this).css("top",$(this).data("start-top")+dify+"px")}),scope.refreshLinks()},start:function(){var maxz;return maxz=0,$(".task-item").each(function(){var z;if(z=parseInt($(this).css("z-index")),z>maxz)return maxz=z}),$(this).css("z-index")<maxz&&$(this).css("z-index",maxz+1),$(".task-item.selected").each(function(){return $(this).data("start-left",parseInt($(this).css("left"))),$(this).data("start-top",parseInt($(this).css("top")))})},stop:function(){return $(".task-item.selected").each(function(){var pos,task,task_id,_i,_len,_ref,_results;for(task_id=$(this).data("taskId"),pos=$(this).position(),pos.left<0&&(pos.left=0,$(this).css("left",0)),pos.top<0&&(pos.top=0,$(this).css("top",0)),_ref=scope.ptasks,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)task=_ref[_i],task.task_id===task_id?(task.x=pos.left,task.y=pos.top,_results.push(taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,x:task.x,y:task.y}))):_results.push(void 0);return _results}),scope.refreshLinks()}}).droppable({accept:".complete-handle",activeClass:"ui-state-active",hoverClass:"ui-state-hover",drop:function(event,ui){return scope.addLink(ui.draggable.parent().parent().data("taskId"),$(this).data("taskId"))}}),$(element).find(".complete-handle").draggable({revert:!0,helper:function(){return $("<div class='connector'><i class='fa fa-arrows-alt'></i></div>")},start:function(){var maxz;if(maxz=0,$(".task-item").each(function(){var z;if(z=parseInt($(this).css("z-index")),z>maxz)return maxz=z}),$(this).parent().parent().css("z-index")<maxz)return $(this).parent().parent().css("z-index",maxz+1)}}),scope.$on("refresh-progress",function(event,t){var $this,pr;if($this=$(element),t.task_id===$this.data("taskId"))return pr=t.progress,null!==pr&&void 0!==pr&&100!==pr||(pr=0),$(element).find(".progress").css("width",pr+"%")})},$timeout(function(){return initPanel()},10)}}}).controller("processCtrl",function($scope,taskStorage,missionStorage,filterFilter,$rootScope,$routeParams,HPRIV,logger,$session,$api,$timeout,$dateutil,$dialogs,$window){return $scope.sync=function(){return $scope.mission_id=null!==$rootScope.cur_mission?$rootScope.cur_mission.mission_id:null},$scope.sync(),$scope.$on("synced-server",function(){$scope.sync(),$scope.drag||$scope.refreshTasks(!0)}),$scope.init=function(){$scope.showCritical=!1,$scope.critical=!1,$scope.root_tasks=[],$scope.taskEditMode=!1,$scope.selectedTasks=[],$scope.drag=!1,$scope.dragRect=null,$scope.refreshTasks()},$scope.canTemplate=function(){return $rootScope.canEditTask()},$scope.canEdit=function(){return $rootScope.canEditTask()&&1===$scope.selectedTasks.length},$scope.refreshLinks=function(fromView){var board,context,h,oh,ow,page,w,wh;return context=getContext(),null!==context&&(board=$("#board"),page=$(".page-process"),wh=$scope.maxWH(),w=wh.width,h=wh.height,ow=board.width(),oh=board.height(),context.clearRect(0,0,ow,oh),ow<w?w+=100:w=ow<w+100?ow+100:ow,context.canvas.width!==w&&(context.canvas.width=w,board.width(w)),oh<h?h+=100:h=oh<h+100?oh+100:oh,context.canvas.height!==h&&(context.canvas.height=h,board.height(h)),$scope.links.forEach(function(link){return drawConnect(link,$scope.taskItemFromId(link.from_task_id),$scope.taskItemFromId(link.to_task_id),link.critical)}),null!==$scope.dragRect&&(context.beginPath(),context.rect($scope.dragRect.x,$scope.dragRect.y,$scope.dragRect.w,$scope.dragRect.h),context.lineWidth=1,context.strokeStyle="#7C4DFF",context.stroke()),!0)},$scope.maxWH=function(){var board,mh,mw;return board=$("#board"),mw=board.width()-100,mh=board.height()-100,$(".task-item").each(function(){var pos;if(pos=$(this).position(),pos.left+$(this).outerWidth()>mw&&(mw=pos.left+$(this).outerWidth()),pos.top+$(this).outerHeight()>mh)return mh=pos.top+$(this).outerHeight()}),{width:mw,height:mh}},$scope.refreshBackImage=function(){var back_pos,cover;cover="",2===$rootScope.taskMode&&$rootScope.cur_mission&&null!==$rootScope.cur_mission.prc_back_url?(1===$rootScope.cur_mission.prc_back_pos?back_pos=" repeat":2===$rootScope.cur_mission.prc_back_pos?back_pos=" no-repeat center center":3===$rootScope.cur_mission.prc_back_pos?back_pos=" no-repeat left top":(back_pos=" no-repeat center center",cover="cover"),$("#board").removeClass("default-back"),$("#board").css("background","url("+encodeURI($rootScope.cur_mission.prc_back_url)+") "+back_pos)):($("#board").addClass("default-back"),$("#board").css("background","")),$("#board").css("-webkit-background-size",cover),$("#board").css("-moz-background-size",cover),$("#board").css("-o-background-size",cover),$("#board").css("background-size",cover)},$scope.refreshBackImage(),$scope.$on("refresh_back_image",function(){return $scope.refreshBackImage()}),$scope.refreshTasks=function(sync){var tasks;last_process={x:10,y:10,z:1},$scope.showCritical=!1,$scope.removableProclink=!1,sync!==!0&&($scope.ptasks=[],$scope.links=[]),null!==$scope.mission_id&&null!==$rootScope.cur_mission&&(tasks=$rootScope.tasks,tasks.forEach(function(task){return task.inited=null}),taskStorage.isEqualTasks($scope.ptasks,tasks)||($scope.ptasks=tasks),taskStorage.get_proclinks($scope.mission_id,function(res){return 0!==res.err_code?logger.logError(res.err_msg):taskStorage.isEqualLinks($scope.links,res.links)?void 0:($scope.links=res.links,$timeout(function(){return $scope.checkCritical(),$scope.refreshLinks(),$scope.refreshBackImage()},200))}))},$scope.searchFilter=function(task){return!0},$scope.$on("reload_session",function(){return $scope.init()}),$scope.$on("select-mission",function(event){}),$scope.$on("refreshed-tasks",function(){return $scope.init()}),$scope.checkLoop=function(from,to){var link,links,ret,_i,_len;for(links=$scope.links,_i=0,_len=links.length;_i<_len;_i++)if(link=links[_i],link.from_task_id===from){if(link.to_task_id===to)return!0;if(ret=$scope.checkLoop(link.to_task_id,to))return!0}return!1},$scope.resetProcLevel=function(){var links;return links=$scope.links,$scope.ptasks.forEach(function(task){var oldlevel;if(oldlevel=task.proclevel,0===task.processed?task.proclevel=0:task.proclevel=$scope.getProcLevel(task.task_id),task.proclevel!==oldlevel)return taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,proclevel:task.proclevel})})},$scope.checkCritical=function(){return $scope.ptasks.length<=1?void($scope.showCritical=!1):($scope.checkLinked(null),$scope.findCritical(null),void(null!==$scope.critical_path?$scope.showCritical=!0:$scope.showCritical=!1))},$scope.$on("refresh-critical",function(){return $scope.checkCritical(),$scope.refreshLinks()}),$scope.findCritical=function(path){var atask,exist_to_task,from_task_id,hours,i,link,root,t,task,to_task_id,_i,_j,_k,_l,_len,_len1,_len2,_len3,_len4,_m,_n,_ref,_ref1,_ref2,_ref3,_ref4;if(null!==path){for(task=path[path.length-1],exist_to_task=!1,_ref4=$scope.links,_m=0,_len3=_ref4.length;_m<_len3;_m++)link=_ref4[_m],atask=null,link.from_task_id===task.task_id&&(atask=$scope.getTask(link.to_task_id)),null!==atask&&atask.task_id!==task.task_id&&($scope.findCritical(path.concat([atask])),exist_to_task=!0);if(exist_to_task===!1){for(hours=0,_n=0,_len4=path.length;_n<_len4;_n++)t=path[_n],hours+=1*t.plan_hours;if(hours>=$scope.max_hours)return $scope.max_hours=hours,$scope.critical_path=path}}else{for($scope.max_hours=0,$scope.critical_path=null,_ref=$scope.root_tasks,_i=0,_len=_ref.length;_i<_len;_i++)root=_ref[_i],$scope.findCritical([root]);if(null!==$scope.critical_path){for(_ref1=$scope.links,_j=0,_len1=_ref1.length;_j<_len1;_j++)link=_ref1[_j],link.critical=!1;for(i=_k=0,_ref2=$scope.critical_path.length-2;0<=_ref2?_k<=_ref2:_k>=_ref2;i=0<=_ref2?++_k:--_k)for(from_task_id=$scope.critical_path[i].task_id,to_task_id=$scope.critical_path[i+1].task_id,_ref3=$scope.links,_l=0,_len2=_ref3.length;_l<_len2;_l++)link=_ref3[_l],link.from_task_id===from_task_id&&link.to_task_id===to_task_id&&(link.critical=!0)}}},$scope.checkLinked=function(task){var atask,from_task_id,link,to_task_id,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2;if(null===task){for($scope.critical=!0,$scope.root_tasks=[],_ref=$scope.ptasks,_i=0,_len=_ref.length;_i<_len;_i++)task=_ref[_i],task.linked=task.complete_flag===!0&&0===task.processed;for($scope.ptasks.length>0&&$scope.checkLinked($scope.ptasks[0]),_ref1=$scope.ptasks,_j=0,_len1=_ref1.length;_j<_len1;_j++)if(task=_ref1[_j],task.linked===!1){$scope.critical=!1;break}return void($scope.critical===!1?$scope.root_tasks=[]:0===$scope.root_tasks.length&&($scope.critical=!1))}for(task.linked=!0,to_task_id=null,from_task_id=null,_ref2=$scope.links,_k=0,_len2=_ref2.length;_k<_len2;_k++)link=_ref2[_k],atask=null,link.from_task_id===task.task_id&&(to_task_id=link.to_task_id,atask=$scope.getTask(to_task_id)),link.to_task_id===task.task_id&&(from_task_id=link.from_task_id,atask=$scope.getTask(from_task_id)),null!==atask&&atask.task_id!==task.task_id&&atask.linked===!1&&$scope.checkLinked(atask);if(null===from_task_id&&null!==to_task_id)return $scope.root_tasks.push(task)},$scope.getTask=function(task_id){var task,_i,_len,_ref;for(_ref=$scope.ptasks,_i=0,_len=_ref.length;_i<_len;_i++)if(task=_ref[_i],task.task_id===task_id)return task;return null},$scope.getProcLevel=function(task_id){var link,links,_i,_len;for(links=$scope.links,_i=0,_len=links.length;_i<_len;_i++)if(link=links[_i],link.to_task_id===task_id)return $scope.getProcLevel(link.from_task_id)+1;return 0},$scope.initItem=function(task){var element,task_id;return task_id=task.task_id,null===task.inited?(element=$('.task-item[data-task-id="'+task_id+'"]'),null===task.x&&(task.x=last_process.x,task.y=last_process.y,last_process.x+=3,last_process.y+=15),last_process.z+=1,task.x<0&&(task.x=0),task.y<0&&(task.y=0),$(element).css("left",task.x),$(element).css("top",task.y),$(element).css("z-index",last_process.z),$(element).data("taskId",task_id),task.inited=!0):$(element).css("z-index",task.proclevel),!0},$scope.addLink=function(from_task_id,to_task_id){var found;if(from_task_id!==to_task_id){if(found=!1,$scope.links.forEach(function(link){if(link.from_task_id===to_task_id&&link.to_task_id===from_task_id||link.from_task_id===from_task_id&&link.to_task_id===to_task_id)return found=!0}),found)return;if($scope.checkLoop(to_task_id,from_task_id))return void logger.logError("循環リンクは作成できません。");$scope.links.push({from_task_id:from_task_id,to_task_id:to_task_id}),$scope.checkCritical(),$scope.refreshLinks(),$scope.setProcessed(from_task_id,1),$scope.setProcessed(to_task_id,1),$scope.refreshProcessed(),$scope.resetProcLevel(),taskStorage.add_proclink($scope.mission_id,from_task_id,to_task_id,function(res){if(0!==res.err_code)return logger.logError(res.err_msg)})}},$scope.setProcessed=function(task_id,processed){return $scope.ptasks.forEach(function(task){if(task.task_id===task_id)return task.processed=processed})},$scope.taskItemFromId=function(task_id){var taskItem;return taskItem=null,$(".task-item").each(function(){if($(this).data("taskId")===task_id)return taskItem=$(this)}),taskItem},$scope.mousedownCanvas=function(evt){var changed,x,y;x=evt.pageX-$("#lines").offset().left,y=evt.pageY-$("#lines").offset().top,changed=!1,$scope.links.forEach(function(link){var selected;if(selected=isOnLine(link.x1,link.y1,link.x2,link.y2,x,y),link.selected&&selected&&(selected=!1),link.selected!==selected&&(changed=!0,link.selected=selected),link.selected)return $scope.removableProclink=!0}),changed&&$scope.refreshLinks(),$window.mobilecheck()||($scope.drag=!0,$scope.dragRect={x:x,y:y,w:0,h:0},$scope.selectedTasks=[],$scope.refreshSelectTask())},$("body").mousemove(function(evt){var h,pos,t,t_h,t_w,t_x,t_y,task,w,x,y,_i,_len,_ref;if($scope.drag&&(x=$scope.dragRect.x,y=$scope.dragRect.y,w=evt.pageX-$("#lines").offset().left-$scope.dragRect.x,h=evt.pageY-$("#lines").offset().top-$scope.dragRect.y,$scope.dragRect.w!==w||$scope.dragRect.h!==h)){for($scope.dragRect.w=w,$scope.dragRect.h=h,$scope.refreshLinks(),w<0&&(x+=w,w=-w),h<0&&(y+=h,h=-h),$scope.selectedTasks=[],_ref=$scope.ptasks,_i=0,_len=_ref.length;_i<_len;_i++)task=_ref[_i],t=$scope.taskItemFromId(task.task_id),null!==t&&(pos=t.position(),t_x=pos.left,t_y=pos.top,t_w=t.outerWidth(!0),t_h=t.outerHeight(!0),x+w<t_x||t_x+t_w<x||y+h<t_y||t_y+t_h<y||$scope.selectedTasks.push(task));return $scope.refreshSelectTask()}}),$("body").mouseup(function(evt){if($scope.drag)return $scope.drag=!1,$scope.dragRect=null,$scope.refreshLinks()}),$scope.removeProclink=function(){var i;return i=0,$scope.links.forEach(function(link){return link.i=i,link.selected&&taskStorage.remove_proclink(link.from_task_id,link.to_task_id,function(res){return 0!==res.err_code?logger.logError(res.err_msg):($scope.links.splice(link.i,1),$scope.checkCritical(),$scope.refreshLinks(),$scope.setProcessed(link.from_task_id,res.from_processed),$scope.setProcessed(link.to_task_id,res.to_processed),$scope.refreshProcessed(),$scope.resetProcLevel()),$scope.removableProclink=!1}),i+=1})},$scope.refreshProcessed=function(){return $scope.ptasks.forEach(function(task){var task_id,task_item;return task_id=task.task_id,task_item=$('.task-item[data-task-id="'+task_id+'"]'),1===task.processed?task_item.addClass("processed"):task_item.removeClass("processed")})},$scope.is_past=function(task){return $dateutil.is_past(task.plan_end_date)&&task.complete_flag!==!0},$scope.refreshSelectTask=function(){var t,task,_i,_len,_ref;for($(".task-item").removeClass("selected"),_ref=$scope.selectedTasks,_i=0,_len=_ref.length;_i<_len;_i++)task=_ref[_i],t=$scope.taskItemFromId(task.task_id),t.addClass("selected");if(0===$scope.selectedTasks.length&&$scope.taskEditMode)return $rootScope.$broadcast("select-task",null)},$scope.selectTask=function(task){var t,_i,_len,_ref;if($scope.selectedTasks.length>1)for(_ref=$scope.selectedTasks,_i=0,_len=_ref.length;_i<_len;_i++)if(t=_ref[_i],t===task)return;if(1!==$scope.selectedTasks.length||$scope.selectedTasks[0]!==task)return $scope.selectedTasks=[task],$scope.taskEditMode&&$rootScope.$broadcast("select-task",task),$scope.refreshSelectTask()},$scope.editTask=function(){if(1===$scope.selectedTasks.length)return $rootScope.$broadcast("select-task",$scope.selectedTasks[0])},$scope.$on("select-task",function(event,task){return $scope.taskEditMode=null!==task}),$scope.addTask=function(){return $dialogs.addTask($rootScope.cur_mission)},$scope.title=function(){var title;return title="",title=$rootScope.cur_mission?$rootScope.cur_mission.mission_name:"チャットルームを選択してください"},$scope.init()}),getContext=function(){var canvas;return canvas=document.getElementById("lines"),null!==canvas?canvas.getContext("2d"):null},drawLine=function(x1,y1,x2,y2,color){var context;if(context=getContext(),null!==context)return context.beginPath(),context.moveTo(x1,y1),context.lineTo(x2,y2),context.lineWidth=3,context.strokeStyle=color,context.stroke()},drawConnect=function(link,fromTask,toTask,critical){var color,fromPos,interFrom,interTo,p1,p2,toPos,x1,x2,y1,y2;if(null!==fromTask&&null!==toTask)return fromPos=fromTask.position(),toPos=toTask.position(),link.x1=x1=fromPos.left+fromTask.outerWidth(!0)/2,link.y1=y1=fromPos.top+fromTask.outerHeight(!0)/2,link.x2=x2=toPos.left+toTask.outerWidth(!0)/2,link.y2=y2=toPos.top+toTask.outerHeight(!0)/2,color=link.selected?"#7C4DFF":critical?"#FF4081":"#3F51B5",interFrom=checkLineRectIntersection(x1,y1,x2,y2,fromPos.left-2,fromPos.top-2,fromTask.outerWidth(!0)+4,fromTask.outerHeight(!0)+4),interTo=checkLineRectIntersection(x1,y1,x2,y2,toPos.left-2,toPos.top-2,toTask.outerWidth(!0)+4,toTask.outerHeight(!0)+4),null!==interFrom&&null!==interTo&&drawLine(interFrom.x,interFrom.y,interTo.x,interTo.y,color),interTo=checkLineRectIntersection(x1,y1,x2,y2,toPos.left-3,toPos.top-3,toTask.outerWidth(!0)+6,toTask.outerHeight(!0)+6),null!==interTo?(p1=getArrowPos(interTo.x,interTo.y,x1,y1,-20,10),p2=getArrowPos(interTo.x,interTo.y,x1,y1,20,10),drawLine(p1.x,p1.y,interTo.x,interTo.y,color),drawLine(p2.x,p2.y,interTo.x,interTo.y,color)):void 0},checkLineRectIntersection=function(l1_sx,l1_sy,l1_ex,l1_ey,r_x,r_y,r_w,r_h){var res;return res=checkLineIntersection(l1_sx,l1_sy,l1_ex,l1_ey,r_x,r_y,r_x+r_w-1,r_y),res.onLine1&&res.onLine2?res:(res=checkLineIntersection(l1_sx,l1_sy,l1_ex,l1_ey,r_x+r_w-1,r_y,r_x+r_w-1,r_y+r_h-1),res.onLine1&&res.onLine2?res:(res=checkLineIntersection(l1_sx,l1_sy,l1_ex,l1_ey,r_x+r_w-1,r_y+r_h-1,r_x,r_y+r_h-1),res.onLine1&&res.onLine2?res:(res=checkLineIntersection(l1_sx,l1_sy,l1_ex,l1_ey,r_x,r_y+r_h-1,r_x,r_y),res.onLine1&&res.onLine2?res:null)))},checkLineIntersection=function(l1_sx,l1_sy,l1_ex,l1_ey,l2_sx,l2_sy,l2_ex,l2_ey){var a,b,denominator,numerator1,numerator2,result;return result={x:null,y:null,onLine1:!1,onLine2:!1},denominator=(l2_ey-l2_sy)*(l1_ex-l1_sx)-(l2_ex-l2_sx)*(l1_ey-l1_sy),0===denominator?result:(a=l1_sy-l2_sy,b=l1_sx-l2_sx,numerator1=(l2_ex-l2_sx)*a-(l2_ey-l2_sy)*b,numerator2=(l1_ex-l1_sx)*a-(l1_ey-l1_sy)*b,a=numerator1/denominator,b=numerator2/denominator,result.x=l1_sx+a*(l1_ex-l1_sx),result.y=l1_sy+a*(l1_ey-l1_sy),a>0&&a<1&&(result.onLine1=!0),b>0&&b<1&&(result.onLine2=!0),result)},getArrowPos=function(x1,y1,x2,y2,ang,sz){var l,result,xd,yd;return result={x:null,y:null},ang=Math.PI/180*ang,l=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2)),xd=(x2-x1)/l,yd=(y2-y1)/l,result.x=x1+(Math.cos(ang)*xd-Math.sin(ang)*yd)*sz,result.y=y1+(Math.sin(ang)*xd+Math.cos(ang)*yd)*sz,result},isOnLine=function(x1,y1,x2,y2,px,py){var f1,f2;return f1=function(somex){return(y2-y1)/(x2-x1)*(somex-x1)+y1},f2=function(somey){return(x2-x1)/(y2-y1)*(somey-y1)+x1},Math.abs(f1(px)-py)<10&&(px>=x1&&px<=x2||px>=x2&&px<=x1)||Math.abs(f2(py)-px)<10&&(py>=y1&&py<=y2||py>=y2&&py<=y1)}}.call(this),function(){"use strict";angular.module("app.task.edit",[]).directive("taskFocus",function($timeout){return{link:function(scope,ele,attrs){return scope.$watch(attrs.taskFocus,function(newVal){if(newVal)return $timeout(function(){return ele[0].focus()},0,!1)})}}}).directive("taskSummaryFocus",function($timeout){return{link:function(scope,ele,attrs){return scope.$watch(attrs.taskSummaryFocus,function(newVal){if(newVal)return $timeout(function(){return ele[0].focus()},0,!1)})}}}).controller("taskeditCtrl",function($scope,$api,taskStorage,filterFilter,$rootScope,HPRIV,logger,$session,$dateutil,CONFIG,$dialogs){return $scope.task=null,$scope.init=function(task){if($scope.activeTab=0,$scope.max_level=5,$scope.level_readonly=!$rootScope.canEditTask(),$scope.print_url=CONFIG.API_BASE+"task/print_task?TOKEN="+$session.getTOKEN()+"&task_id=",$scope.editTaskNameMode=!1,$scope.editSummaryMode=!1,null!==task)return null===task.progress&&(task.progress=0),taskStorage.get_skills(task.task_id,function(res){return 0===res.err_code?$scope.task.skills=res.skills:$scope.task.skills=[]}),$scope.get_comments(task),task.org_task_name=task.task_name,$scope.task=task},$scope.init(null),$scope.$on("select-task",function(event,task){return void 0===task&&(task=null),null===task?$("#panel-task-edit").hide("slide",{direction:"right"}):($("#panel-task-edit").show("slide",{direction:"right"}),$scope.init(task))}),$scope.$on("reload_session",function(){return $scope.init(null)}),$scope.$on("select-mission",function(){return $scope.closePanel()}),$scope.$on("refresh-task-date",function(){return $scope.closePanel()}),$scope.$on("refresh-task-this-week",function(){return $scope.closePanel()}),$scope.$on("select-member",function(){return $scope.closePanel()}),$scope.$on("search-task",function(){return $scope.closePanel()}),$scope.$on("refreshed-tasks",function(event){var found,i,_i,_ref;if(0===$rootScope.tasks.length&&$scope.closePanel(),found=!1,$rootScope.tasks.length>0&&null!==$scope.task)for(i=_i=0,_ref=$rootScope.tasks.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)$scope.task.task_id===$rootScope.tasks[i].task_id&&($scope.task=$rootScope.tasks[i],found=!0);if(found===!1)return $scope.closePanel()}),$scope.closePanel=function(){$rootScope.$broadcast("select-task",null)},$scope.editSummary=function(){$rootScope.canEditTask()&&($scope.editSummaryMode=!0)},$scope.exitEditSummary=function(){$scope.editSummaryMode=!1},$scope.submitSaveSummary=function(task){taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,summary:task.summary}),$scope.editSummaryMode=!1},$scope.changeTaskName=function(task){return task.task_name=task.task_name.trim(),task.task_name===task.org_task_name?void($scope.editTaskNameMode=!1):(""===task.task_name?task.task_name=task.org_task_name:(task.org_task_name=task.task_name,taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,task_name:task.task_name},function(res){if(0!==res.err_code)return logger.logError(res.err_msg)})),$scope.editTaskNameMode=!1)},$scope.editTaskName=function(task){return $scope.editTaskNameMode=!0},$scope.checkPriority=function(task){return taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,priority:task.priority},function(res){if(0!==res.err_code)return logger.logError(res.err_msg)}),taskStorage.refresh_remaining()},$scope.changeMission=function(task){taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id},function(res){return 0===res.err_code?$rootScope.$broadcast("refresh-tasks"):logger.logError(res.err_msg)}),taskStorage.refresh_remaining()},$scope.changeSkills=function(task){var skills;skills=task.skills.join(","),taskStorage.set_skills(task.task_id,skills,function(res){if(0!==res.err_code)return logger.logError(res.err_msg)})},$scope.changePerformer=function(task){taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,performer_id:task.performer_id},function(res){if(0!==res.err_code)return logger.logError(res.err_msg)})},$scope.changeLevel=function(task){taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,level:task.level},function(res){if(0!==res.err_code)return logger.logError(res.err_msg)})},$scope.$on("change_task.plan_start_date",function(){return $scope.changeDate($scope.task)}),$scope.$on("change_task.plan_end_date",function(){return $scope.changeDate($scope.task)}),$scope.changeDate=function(task){var ed,hours,param,sd;null!==task.plan_start_date&&null!==task.plan_end_date&&(sd=moment(task.plan_start_date),ed=moment(task.plan_end_date),task.plan_start_date===task.plan_end_date&&null!==task.plan_start_time&&null!==task.plan_end_time&&(sd=moment(task.plan_start_time),ed=moment(task.plan_end_time)),
hours=ed.diff(sd,"hours")+1,hours>7?task.plan_hours=8*(ed.diff(sd,"days")+1):hours<=0?task.plan_hours=null:task.plan_hours=hours),param={task_id:task.task_id,mission_id:task.mission_id,plan_start_date:task.plan_start_date,plan_start_time:task.plan_start_time,plan_end_date:task.plan_end_date,plan_end_time:task.plan_end_time,plan_hours:task.plan_hours},taskStorage.edit(param,function(res){return 0===res.err_code?$rootScope.$broadcast("refresh-tasks"):logger.logError(res.err_msg)})},$scope.changePlanHours=function(task){taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,plan_hours:task.plan_hours},function(res){return 0!==res.err_code?logger.logError(res.err_msg):($rootScope.cur_mission.total_budget=res.total_budget,$rootScope.cur_mission.total_hours=res.total_hours,$rootScope.$broadcast("refresh-critical"))})},$scope.changeBudget=function(task){taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,plan_budget:task.plan_budget},function(res){if(0===res.err_code)return $rootScope.cur_mission.total_budget=res.data.total_budget,$rootScope.cur_mission.total_hours=res.data.total_hours})},$scope.recalcBudget=function(task){return null!==task.perfomer_id&&task.performer_id!==$session.user_id?$api.call("user/get_daily_amount",{user_id:task.performer_id}).then(function(res){if(0===res.data.err_code)return task.plan_budget=task.plan_hours*res.data.daily_amount,$scope.changeBudget(task)}):(task.plan_budget=0,$scope.changeBudget(task))},$scope.$on("refresh-comments",function(event,new_comment){$scope.get_comments($scope.task)}),$scope.get_comments=function(task){return taskStorage.get_comments(task.task_id,function(res){0===res.err_code?task.comments=res.comments:task.comments=[]})},$scope.canAddComment=function(){return $scope.form_comment_add.$valid},$scope.submitAddComment=function(task){taskStorage.add_comment(task.task_id,$scope.comment,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-comments",res.comment),$scope.comment="",$scope.form_comment_add.$setPristine()):logger.logError(res.err_msg)})},$scope.removeComment=function(task_comment_id){var message;message="コメントを削除してもよろしいでしょうか？",$dialogs.confirm("コメント削除",message,"削除","remove-comment",task_comment_id)},$scope.$on("remove-comment",function(event,task_comment_id){taskStorage.remove_comment(task_comment_id,function(res){return 0===res.err_code?$rootScope.$broadcast("refresh-comments"):logger.logError(res.err_msg)})}),$scope.removeTask=function(task){var message;message="タスクを削除してもよろしいでしょうか？",$dialogs.confirm("タスク削除",message,"削除","remove-task",task)},$scope.$on("remove-task",function(event,task){taskStorage.remove(task,function(res){return 0===res.err_code?($rootScope.$broadcast("refresh-tasks"),logger.logSuccess("タスクが削除されました。")):logger.logError(res.err_msg)}),$scope.closePanel()}),$scope.reqEntrance=function(task){null===task.plan_end_date?logger.logError("期限を設定していないと外部依頼ができません。"):$dialogs.reqEntrance(task)},$scope.helpEntrance=function(task){$dialogs.helpEntrance(task)},$scope.onUploadAttach=function(){return $dialogs.uploadAttach(1,$scope.task.task_id)},$scope.canProgress=function(){return null!==$scope.task&&($rootScope.canEditTask()||$scope.task.performer_id===$session.user_id)},$scope.changeProgress=function(task){return taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,progress:task.progress},function(res){return 0===res.err_code?(task.complete_flag=1===res.complete_flag,$rootScope.$broadcast("refresh-progress",task)):logger.logError(res.err_msg)})}})}.call(this),function(){"use strict";angular.module("app.task.list",[]).directive("progressBack",function($timeout,$rootScope,$parse,$api){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){var progress;return progress=ngModel.$modelValue,null!==progress&&void 0!==progress||(progress=0),$(element).css("width",progress+"%")},$timeout(function(){return initPanel()},10)}}}).directive("completeHandle",function($timeout,$rootScope,$parse,$api,$session){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var initPanel;return initPanel=function(){var enableDrag,refresh,task;return task=ngModel.$modelValue,refresh=function(){var pr;return task=ngModel.$modelValue,pr=task.progress,null!==pr&&void 0!==pr&&100!==pr||(pr=0),$(element).parents(".task-item").find(".progress").css("width",pr+"%")},scope.$on("refresh-tasks",function(event){return refresh()}),scope.$on("refresh-progress",function(event,t){if(t.task_id===task.task_id)return task.progress=t.progress,refresh()}),enableDrag=function(){return task=ngModel.$modelValue,task.performer_id!==$session.user_id?$(element).draggable("disable"):$(element).draggable("enable")},scope.$watch("task.performer_id",function(newVal,oldVal){enableDrag()}),$(element).draggable({revert:!0,axis:"x",start:function(){},drag:function(){var e,pr,s,w,x;return x=$(this).position().left,w=$(".task-list").width(),s=50,e=w-40,pr=x<s?0:x>e?100:parseInt((x-s)/(e-s)*100),task=ngModel.$modelValue,task.progress=pr,$(this).parents(".task-item").find(".progress").css("width",pr+"%")},stop:function(){return task=ngModel.$modelValue,100===task.progress?(task.complete_flag=!0,scope.completed(task),scope.$apply()):scope.changeProgress(task),$(element).removeAttr("style")}}),enableDrag()},$timeout(function(){return initPanel()},10)}}}).directive("taskSortable",function($rootScope,taskStorage,$filter,$api,logger){var o_sorts;return o_sorts=[],{restrict:"A",link:function(scope,ele,attrs){return $(ele).sortable({distance:30,axis:"y",handle:".task-name a",start:function(event,ui){return o_sorts=[],$(".task-sort .task-item").each(function(){var task_id;if(task_id=$(this).data("taskId"),void 0!==task_id)return o_sorts.push(task_id)})},update:function(event,ui){var g_sorts,i,j,lj,n_sorts,orderBy,soreted,sort,task,task_id,_i,_j,_k,_len,_ref,_ref1;for(n_sorts=[],$(".task-sort .task-item").each(function(){var task_id;if(task_id=$(this).data("taskId"),void 0!==task_id)return n_sorts.push(task_id)}),g_sorts=[],orderBy=$filter("orderBy"),soreted=orderBy($rootScope.tasks,"sort"),soreted.forEach(function(task){if(task.complete_flag===!1&&0===task.processed)return g_sorts.push(task.task_id)}),lj=0,i=_i=0,_ref=o_sorts.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i)for(j=_j=lj,_ref1=g_sorts.length-1;lj<=_ref1?_j<=_ref1:_j>=_ref1;j=lj<=_ref1?++_j:--_j)if(o_sorts[i]===g_sorts[j]){g_sorts[j]=n_sorts[i],lj=j+1;break}for(sort=0,_k=0,_len=g_sorts.length;_k<_len;_k++)task_id=g_sorts[_k],task=taskStorage.get_task(task_id),null!==task&&(task.sort=sort,sort+=1);return $api.call("task/update_sorts",{sorts:g_sorts}).then(function(res){if(0!==res.data.err_code)return logger.logError(res.data.err_msg)})}})}}}).controller("taskCtrl",function($scope,$api,taskStorage,missionStorage,filterFilter,HPRIV,$rootScope,$routeParams,logger,$session,$dateutil,$timeout,$dialogs){return $scope.sync=function(){return $scope.mission_id=void 0!==$routeParams.mission_id?parseInt($routeParams.mission_id,10):null,missionStorage.set_cur_mission(void 0!==$scope.mission_id?missionStorage.get_mission($scope.mission_id):null)},$scope.sync(),$scope.$on("synced-server",function(){return $scope.sync(),$scope.refreshBackImage()}),$scope.$on("refresh-tasks",function(event){}),$scope.$on("search-task",function(event){}),$scope.searchFilter=function(task){var search_string;if(1===$rootScope.taskMode){if(null!==task.mission_id)return!1}else if(2===$rootScope.taskMode){if(null===task.mission_id)return!1;if(!$rootScope.cur_mission)return!1;if(task.mission_id!==$scope.mission_id)return!1}return!$rootScope.task_search_string||(search_string=$rootScope.task_search_string.toLowerCase(),""===search_string||task.task_name.toLowerCase().indexOf(search_string)!==-1)},$scope.searchFilter1=function(task){var searched;return searched=$scope.searchFilter(task),!(!searched||task.complete_flag!==!1||0!==task.processed)},$scope.searchFilter2=function(task){var searched;return searched=$scope.searchFilter(task),!(!searched||task.complete_flag!==!1||1!==task.processed)},$scope.searchFilter3=function(task){var searched;return searched=$scope.searchFilter(task),!(!searched||task.complete_flag!==!0)},$scope.refreshBackImage=function(){var back_pos,cover;cover="",2===$rootScope.taskMode&&$rootScope.cur_mission&&null!==$rootScope.cur_mission.job_back_url?(1===$rootScope.cur_mission.job_back_pos?back_pos=" repeat":2===$rootScope.cur_mission.job_back_pos?back_pos=" no-repeat center center":3===$rootScope.cur_mission.job_back_pos?back_pos=" no-repeat left top":(back_pos=" no-repeat center center",cover="cover"),angular.element(".page-tasks").removeClass("default-back"),angular.element(".page-tasks").css("background","url("+encodeURI($rootScope.cur_mission.job_back_url)+") "+back_pos)):(angular.element(".page-tasks").addClass("default-back"),angular.element(".page-tasks").css("background","")),angular.element(".page-tasks").css("-webkit-background-size",cover),angular.element(".page-tasks").css("-moz-background-size",cover),angular.element(".page-tasks").css("-o-background-size",cover),angular.element(".page-tasks").css("background-size",cover)},$scope.refreshBackImage(),$scope.$on("refresh_back_image",function(){return $scope.refreshBackImage()}),$scope.$on("select-mission",function(event){return taskStorage.refresh_remaining(),$scope.refreshBackImage()}),$scope.$on("refresh-task-date",function(event){return taskStorage.search(),$scope.refreshBackImage()}),$scope.$on("refresh-task-this-week",function(event){return taskStorage.search(),$scope.refreshBackImage()}),$scope.loadCompleted=function(){return taskStorage.search_completed()},$scope.canComplete=function(task){return task.performer_id===$session.user_id},$scope.completed=function(task){task.complete_flag&&(task.progress=100),task.complete_flag||(task.progress=0),task.performer_id===$session.user_id&&taskStorage.refresh_remaining(),taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,complete_flag:task.complete_flag,progress:task.progress},function(res){return 0!==res.err_code?logger.logError(res.err_msg):task.complete_flag?(logger.logSuccess("タスクが完了されました。"),$(".good_job").removeClass("good_job_show").show(),$timeout(function(){return $(".good_job").addClass("good_job_show"),$timeout(function(){return $(".good_job").hide()},1500)},10)):void 0})},$scope.selPerformer=function(task){if($rootScope.canEditTask())return $dialogs.selPerformer(task)},$scope.$on("complete_task",function(event,task){return $scope.completed(task)}),$scope.changeProgress=function(task){return taskStorage.edit({task_id:task.task_id,progress:task.progress})},$scope.checkPriority=function(task){return taskStorage.edit({task_id:task.task_id,priority:task.priority}),taskStorage.refresh_remaining()},$scope.title=function(){var title;return title="",title=1===$rootScope.taskMode?"受信箱":2===$rootScope.taskMode?$rootScope.cur_mission?$rootScope.cur_mission.mission_name:"チャットルームを選択してください":3===$rootScope.taskMode?$rootScope.selectedMember?$rootScope.selectedMember.member_name:"ユーザーを選択してください":"スター付き"},$scope.selectTask=function(task){return $scope.selectedTask===task?$scope.selectedTask=null:$scope.selectedTask=task,$rootScope.$broadcast("select-task",$scope.selectedTask)},$scope.$on("select-task",function(event,task){if(null===task&&null!==$scope.selectedTask)return $scope.selectedTask=null}),$scope.is_past=function(task){return $dateutil.is_past(task.plan_end_date)},$scope.addTask=function(){return $dialogs.addTask($rootScope.cur_mission)}})}.call(this),function(){"use strict";angular.module("app.task.star",[]).controller("taskStarCtrl",function($scope,$api,taskStorage,missionStorage,filterFilter,HPRIV,$rootScope,$routeParams,logger,$session,$dateutil,$timeout,$dialogs){return $rootScope.nav_id="task_star",missionStorage.select_mission_in_nav(),$scope.sync=function(init_offset){var home_id,offset_key;return init_offset&&(null!==$rootScope.cur_home&&(home_id=$rootScope.cur_home.home_id),offset_key="home_"+home_id,taskStorage.set_completed_offset(offset_key,0)),taskStorage.search(void 0,1).then(function(tasks){})},$scope.sync(!0),$scope.$on("synced-server",function(){return $scope.sync()}),$scope.$on("refresh-tasks",function(event){}),$scope.$on("search-task",function(event){}),$scope.$on("select-home",function(event){return $scope.sync(!0)}),$scope.searchFilter=function(task){return task.priority===!0},$scope.searchFilter1=function(task){var searched;return searched=$scope.searchFilter(task),!(!searched||task.complete_flag!==!1)},$scope.searchFilter2=function(task){var searched;return searched=$scope.searchFilter(task),!(!searched||task.complete_flag!==!0)},$scope.$on("select-mission",function(event){return taskStorage.refresh_remaining()}),$scope.loadCompleted=function(){return taskStorage.search_completed(void 0,1)},$scope.canComplete=function(task){return task.performer_id===$session.user_id},$scope.completed=function(task){task.complete_flag&&(task.progress=100),task.complete_flag||(task.progress=0),task.performer_id===$session.user_id&&taskStorage.refresh_remaining(),taskStorage.edit({task_id:task.task_id,mission_id:task.mission_id,complete_flag:task.complete_flag,progress:task.progress},function(res){return 0!==res.err_code?logger.logError(res.err_msg):task.complete_flag?(logger.logSuccess("タスクが完了されました。"),$(".good_job").removeClass("good_job_show").show(),$timeout(function(){return $(".good_job").addClass("good_job_show"),$timeout(function(){return $(".good_job").hide()},1500)},10)):void 0})},$scope.selPerformer=function(task){if($rootScope.canEditTask())return $dialogs.selPerformer(task)},$scope.$on("complete_task",function(event,task){return $scope.completed(task)}),$scope.changeProgress=function(task){return taskStorage.edit({task_id:task.task_id,progress:task.progress})},$scope.checkPriority=function(task){return taskStorage.edit({task_id:task.task_id,priority:task.priority}),taskStorage.refresh_remaining()},$scope.selectTask=function(task){return $scope.selectedTask===task?$scope.selectedTask=null:$scope.selectedTask=task,$rootScope.$broadcast("select-task",$scope.selectedTask)},$scope.$on("select-task",function(event,task){if(null===task&&null!==$scope.selectedTask)return $scope.selectedTask=null}),$scope.is_past=function(task){return $dateutil.is_past(task.plan_end_date)},$scope.addTask=function(){return $dialogs.addTask($rootScope.cur_mission)}})}.call(this),eval(function(p,a,c,k,e,d){for(;c--;)k[c]&&(p=p.replace(new RegExp("\\b"+c.toString(a)+"\\b","g"),k[c]));return p}('$.1m({1w:b(e,t,n){b h(){3 e=o[0][0];3 t=o[o.8-1][0];3 n=(t-e)/a;3 r=[];r.6(o[0]);3 i=1;7=o[0];4=o[i];q(3 s=e+n;s<t+n;s+=n){9(s>t){s=t}$("#18").19(s);1a(s>4[0]){7=4;4=o[i++]}9(s==4[0]){r.6([s,4[1]]);7=4;4=o[i++]}11{3 u=(4[1]-7[1])/(4[0]-7[0]);16=u*s+(7[1]-u*7[0]);r.6([s,16])}}j r}b v(){3 n=[];p++;1b(c){14"1c":n=d.w(-1*p);y;14"1h":n=d.w(d.8/2-p/2,d.8/2+p/2);y;1d:n=d.w(0,p);y}9(!u){13=n[0][0];12=n[n.8-1][0];n=[];q(3 i=0;i<o.8;i++){9(o[i][0]>=13&&o[i][0]<=12){n.6(o[i])}}}t[r].x=p<a?n:o;g.1j(t);g.1i();9(p<a){15(v,f/a)}11{e.1g("1f")}}b m(i){3 s=[];s.6([i[0][0],k.1e.10(k,i.z(b(e){j e[1]}))]);s.6([i[0][0],17]);s.6([i[0][0],k.1k.10(k,i.z(b(e){j e[1]}))]);q(3 o=0;o<i.8;o++){s.6([i[o][0],17])}t[r].x=s;j $.1l(e,t,n)}3 r=0;q(3 i=0;i<t.8;i++){9(t[i].5){r=i}}3 s=t[r];3 o=s.x;3 u=t[r].1v?1x:1t;3 a=t[r].5&&t[r].5.1r||1q;3 f=t[r].5&&t[r].5.1p||1o;3 l=t[r].5&&t[r].5.1n||0;3 c=t[r].5&&t[r].5.1u||"1s";3 p=0;3 d=h();3 g=m(o);15(v,l);j g}})',36,70,"|||var|nPoint|animator|push|lPoint|length|if||function||||||||return|Math||||||for||||||slice|data|break|map|apply|else|laV|inV|case|setTimeout|curV|null|m2|html|while|switch|left|default|max|animatorComplete|trigger|center|draw|setData|min|plot|extend|start|1e3|duration|135|steps|right|false|direction|lines|plotAnimator|true".split("|")));